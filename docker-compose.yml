# Paperless → Firefly III Finance Pipeline (Sparklink) — PRODUCTION-LEANING
#
# Philosophy:
# - NO silent defaults for critical values. Missing env vars must hard-fail.
# - Optional features (workers, llm) are enabled via profiles; if enabled, their required vars must exist.
# - Single source of truth: /srv/stack.env (symlinked as /srv/sparklink/.env is also fine).
#
# Profiles:
#   worker     - extraction worker
#   reconcile  - reconcile/matching worker
#   llm        - local Ollama service
#
# Usage:
#   docker compose up -d
#   docker compose --profile worker --profile reconcile up -d
#   docker compose --profile llm up -d
#   docker compose --profile worker --profile reconcile --profile llm up -d

services:
  sparklink:
    build:
      context: .
      dockerfile: Dockerfile
    image: sparklink:latest
    container_name: sparklink
    restart: unless-stopped

    env_file:
      - /srv/stack.env
      - /srv/stack.tunnel.env

    ports:
      - "${SPARKLINK_BIND_IP}:${SPARKLINK_PORT}:8080"

    environment:
      # --- Required core integrations ---
      - PAPERLESS_URL=${PAPERLESS_URL:?PAPERLESS_URL is required}
      - PAPERLESS_TOKEN=${PAPERLESS_TOKEN:?PAPERLESS_TOKEN is required}
      - FIREFLY_URL=${FIREFLY_URL:?FIREFLY_URL is required}
      - FIREFLY_TOKEN=${FIREFLY_TOKEN:?FIREFLY_TOKEN is required}

      # --- Required UX/link correctness (no “mysterious internal URLs”) ---
      - PAPERLESS_EXTERNAL_URL=${PAPERLESS_EXTERNAL_URL:?PAPERLESS_EXTERNAL_URL is required}
      - FIREFLY_EXTERNAL_URL=${FIREFLY_EXTERNAL_URL:?FIREFLY_EXTERNAL_URL is required}

      # --- Required security (production) ---
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:?DJANGO_SECRET_KEY is required}
      - ADMIN_USERNAME=${ADMIN_USERNAME:?ADMIN_USERNAME is required}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}

      # --- Required, but you choose the values explicitly (no hidden defaults) ---
      - PAPERLESS_FILTER_TAG=${PAPERLESS_FILTER_TAG:?PAPERLESS_FILTER_TAG is required}
      - FIREFLY_DEFAULT_ACCOUNT=${FIREFLY_DEFAULT_ACCOUNT:?FIREFLY_DEFAULT_ACCOUNT is required}

      # --- Optional landing-page links (explicitly optional) ---
      - SYNCTHING_URL=${SYNCTHING_EXTERNAL_URL-}
      - FIREFLY_IMPORTER_URL=${FIREFLY_IMPORTER_EXTERNAL_URL-}

      # --- Thresholds (explicit: set them or it fails) ---
      - CONFIDENCE_AUTO_THRESHOLD=${CONFIDENCE_AUTO_THRESHOLD:?CONFIDENCE_AUTO_THRESHOLD is required}
      - CONFIDENCE_REVIEW_THRESHOLD=${CONFIDENCE_REVIEW_THRESHOLD:?CONFIDENCE_REVIEW_THRESHOLD is required}
      - SPARK_RECONCILIATION_AUTO_THRESHOLD=${SPARK_RECONCILIATION_AUTO_THRESHOLD:?SPARK_RECONCILIATION_AUTO_THRESHOLD is required}
      - SPARK_RECONCILIATION_REVIEW_THRESHOLD=${SPARK_RECONCILIATION_REVIEW_THRESHOLD:?SPARK_RECONCILIATION_REVIEW_THRESHOLD is required}
      - SPARK_CACHE_TTL_HOURS=${SPARK_CACHE_TTL_HOURS:?SPARK_CACHE_TTL_HOURS is required}

      # --- LLM config (hard rules) ---
      # If you enable LLM, you MUST provide OLLAMA_URL + OLLAMA_MODEL and set SPARK_LLM_ENABLED=true.
      # If LLM is disabled, set SPARK_LLM_ENABLED=false and leave OLLAMA_URL/OLLAMA_MODEL empty or unset.
      - SPARK_LLM_ENABLED=${SPARK_LLM_ENABLED:?SPARK_LLM_ENABLED is required (true/false)}
      - OLLAMA_URL=${OLLAMA_URL-}
      - OLLAMA_MODEL=${OLLAMA_MODEL-}
      - FALLBACK_OLLAMA_MODEL=${FALLBACK_OLLAMA_MODEL-}
      - SPARK_LLM_OPT_OUT=${SPARK_LLM_OPT_OUT:?SPARK_LLM_OPT_OUT is required (true/false)}
      - SPARK_LLM_CACHE_TTL_DAYS=${SPARK_LLM_CACHE_TTL_DAYS:?SPARK_LLM_CACHE_TTL_DAYS is required}

      # Server bind inside container (safe constants)
      - HOST=0.0.0.0
      - PORT=8080

      - PYTHONPATH=/app/src

    volumes:
      - sparklink-data:/app/data

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - orion_net

    extra_hosts:
      - "host.docker.internal:host-gateway"

  sparklink-worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: sparklink:latest
    container_name: sparklink-worker
    restart: "no"
    profiles: ["worker"]

    env_file:
      - /srv/stack.env
      - /stv/stack.tunnel.env

    # Make these explicit in env (no hidden defaults)
    command: ["pipeline", "${PAPERLESS_FILTER_TAG:?PAPERLESS_FILTER_TAG is required}", "${WORKER_BATCH_SIZE:?WORKER_BATCH_SIZE is required}"]

    environment:
      - PAPERLESS_URL=${PAPERLESS_URL:?PAPERLESS_URL is required}
      - PAPERLESS_TOKEN=${PAPERLESS_TOKEN:?PAPERLESS_TOKEN is required}
      - FIREFLY_URL=${FIREFLY_URL:?FIREFLY_URL is required}
      - FIREFLY_TOKEN=${FIREFLY_TOKEN:?FIREFLY_TOKEN is required}
      - FIREFLY_DEFAULT_ACCOUNT=${FIREFLY_DEFAULT_ACCOUNT:?FIREFLY_DEFAULT_ACCOUNT is required}

      - SPARK_LLM_ENABLED=${SPARK_LLM_ENABLED:?SPARK_LLM_ENABLED is required (true/false)}
      - OLLAMA_URL=${OLLAMA_URL-}
      - OLLAMA_MODEL=${OLLAMA_MODEL-}

      - SPARK_CACHE_TTL_HOURS=${SPARK_CACHE_TTL_HOURS:?SPARK_CACHE_TTL_HOURS is required}

    volumes:
      - sparklink-data:/app/data

    networks:
      - orion_net

    depends_on:
      sparklink:
        condition: service_healthy

  sparklink-reconcile:
    build:
      context: .
      dockerfile: Dockerfile
    image: sparklink:latest
    container_name: sparklink-reconcile
    restart: "no"
    profiles: ["reconcile"]

    env_file:
      - /srv/stack.env
      - /srv/stack.tunnel.env

    command: ["reconcile", "--sync", "--match"]

    environment:
      - PAPERLESS_URL=${PAPERLESS_URL:?PAPERLESS_URL is required}
      - PAPERLESS_TOKEN=${PAPERLESS_TOKEN:?PAPERLESS_TOKEN is required}
      - FIREFLY_URL=${FIREFLY_URL:?FIREFLY_URL is required}
      - FIREFLY_TOKEN=${FIREFLY_TOKEN:?FIREFLY_TOKEN is required}
      - FIREFLY_DEFAULT_ACCOUNT=${FIREFLY_DEFAULT_ACCOUNT:?FIREFLY_DEFAULT_ACCOUNT is required}

      - SPARK_RECONCILIATION_AUTO_THRESHOLD=${SPARK_RECONCILIATION_AUTO_THRESHOLD:?SPARK_RECONCILIATION_AUTO_THRESHOLD is required}
      - SPARK_RECONCILIATION_REVIEW_THRESHOLD=${SPARK_RECONCILIATION_REVIEW_THRESHOLD:?SPARK_RECONCILIATION_REVIEW_THRESHOLD is required}
      - SPARK_CACHE_TTL_HOURS=${SPARK_CACHE_TTL_HOURS:?SPARK_CACHE_TTL_HOURS is required}

      - SPARK_LLM_ENABLED=${SPARK_LLM_ENABLED:?SPARK_LLM_ENABLED is required (true/false)}
      - OLLAMA_URL=${OLLAMA_URL-}
      - OLLAMA_MODEL=${FALLBACK_OLLAMA_MODEL-}

    volumes:
      - sparklink-data:/app/data

    networks:
      - orion_net

    depends_on:
      sparklink:
        condition: service_healthy

  # Optional local Ollama
  # Recommended: bind only to localhost (host) and let Sparklink reach it via docker network name "ollama".
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    profiles: ["llm"]

    # Hard-fail if you enable the llm profile but forgot the port and bind ip
    ports:
      - "${OLLAMA_BIND_IP:?OLLAMA_BIND_IP is required (recommend 127.0.0.1)}:${OLLAMA_PORT:?OLLAMA_PORT is required}:11434"

    volumes:
      - ollama-data:/root/.ollama

    networks:
      - orion_net

volumes:
  sparklink-data:
    driver: local
  ollama-data:
    driver: local

networks:
  orion_net:
    external: true
