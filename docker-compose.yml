# Paperless â†’ Firefly III Finance Pipeline (Spark v1.0)
# Docker Compose configuration for local development and production
#
# Services:
# - paperless-firefly: Main web UI and review interface
# - paperless-firefly-worker: Scheduled extraction worker (optional, profile: worker)
# - paperless-firefly-reconcile: Reconciliation sync worker (optional, profile: reconcile)
#
# Profiles:
# - worker: Enable extraction worker service
# - reconcile: Enable reconciliation worker service
# - llm: Enable Ollama LLM integration
#
# Usage:
# - Basic: docker compose up -d
# - With workers: docker compose --profile worker --profile reconcile up -d
# - With LLM: docker compose --profile llm up -d
#
# See .env.example for configuration options.

services:
  # Main application service
  paperless-firefly:
    build:
      context: .
      dockerfile: Dockerfile
    image: paperless-firefly:latest
    container_name: paperless-firefly
    restart: unless-stopped

    ports:
      - "${PF_PORT:-8080}:8080"

    environment:
      # Paperless connection (internal Docker URLs)
      - PAPERLESS_URL=${PAPERLESS_URL:?PAPERLESS_URL is required}
      - PAPERLESS_TOKEN=${PAPERLESS_TOKEN:?PAPERLESS_TOKEN is required}
      - PAPERLESS_FILTER_TAG=${PAPERLESS_FILTER_TAG:-finance/inbox}

      # External URLs for browser links (what users actually access)
      - PAPERLESS_EXTERNAL_URL=${PAPERLESS_EXTERNAL_URL:-${PAPERLESS_URL}}
      - FIREFLY_EXTERNAL_URL=${FIREFLY_EXTERNAL_URL:-${FIREFLY_URL}}

      # Firefly III connection (internal Docker URLs)
      - FIREFLY_URL=${FIREFLY_URL:?FIREFLY_URL is required}
      - FIREFLY_TOKEN=${FIREFLY_TOKEN:?FIREFLY_TOKEN is required}
      - FIREFLY_DEFAULT_ACCOUNT=${FIREFLY_DEFAULT_ACCOUNT:-Checking Account}

      # Optional service links for landing page
      - SYNCTHING_URL=${SYNCTHING_URL:-}
      - FIREFLY_IMPORTER_URL=${FIREFLY_IMPORTER_URL:-}

      # Authentication - default admin user
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-change-me-in-production}

      # Confidence thresholds
      - CONFIDENCE_AUTO_THRESHOLD=${CONFIDENCE_AUTO_THRESHOLD:-0.85}
      - CONFIDENCE_REVIEW_THRESHOLD=${CONFIDENCE_REVIEW_THRESHOLD:-0.60}

      # LLM Configuration (optional, Spark v1.0)
      - OLLAMA_URL=${OLLAMA_URL:-}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b}
      - SPARK_LLM_ENABLED=${SPARK_LLM_ENABLED:-false}
      - SPARK_LLM_OPT_OUT=${SPARK_LLM_OPT_OUT:-false}
      - SPARK_LLM_CACHE_TTL_DAYS=${SPARK_LLM_CACHE_TTL_DAYS:-30}

      # Reconciliation settings (Spark v1.0)
      - SPARK_RECONCILIATION_AUTO_THRESHOLD=${SPARK_RECONCILIATION_AUTO_THRESHOLD:-0.92}
      - SPARK_RECONCILIATION_REVIEW_THRESHOLD=${SPARK_RECONCILIATION_REVIEW_THRESHOLD:-0.70}
      - SPARK_CACHE_TTL_HOURS=${SPARK_CACHE_TTL_HOURS:-24}

      # Server settings
      - HOST=0.0.0.0
      - PORT=8080

    volumes:
      # Persistent state database
      - paperless-firefly-data:/app/data
      # Optional: mount custom config
      # - ./config.yaml:/app/config/config.yaml:ro

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    networks:
      - paperless-firefly-net

    # For LAN access to Paperless and Firefly
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Scheduled extraction worker (optional)
  paperless-firefly-worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: paperless-firefly:latest
    container_name: paperless-firefly-worker
    restart: "no"
    profiles:
      - worker

    command: ["pipeline", "finance/inbox", "50"]

    environment:
      - PAPERLESS_URL=${PAPERLESS_URL}
      - PAPERLESS_TOKEN=${PAPERLESS_TOKEN}
      - FIREFLY_URL=${FIREFLY_URL}
      - FIREFLY_TOKEN=${FIREFLY_TOKEN}
      - FIREFLY_DEFAULT_ACCOUNT=${FIREFLY_DEFAULT_ACCOUNT:-Checking Account}

    volumes:
      - paperless-firefly-data:/app/data

    networks:
      - paperless-firefly-net

    depends_on:
      paperless-firefly:
        condition: service_healthy

  # Reconciliation sync worker (optional, Spark v1.0)
  # Syncs Firefly transactions and runs matching engine
  paperless-firefly-reconcile:
    build:
      context: .
      dockerfile: Dockerfile
    image: paperless-firefly:latest
    container_name: paperless-firefly-reconcile
    restart: "no"
    profiles:
      - reconcile

    command: ["reconcile", "--sync", "--match"]

    environment:
      - PAPERLESS_URL=${PAPERLESS_URL}
      - PAPERLESS_TOKEN=${PAPERLESS_TOKEN}
      - FIREFLY_URL=${FIREFLY_URL}
      - FIREFLY_TOKEN=${FIREFLY_TOKEN}
      - FIREFLY_DEFAULT_ACCOUNT=${FIREFLY_DEFAULT_ACCOUNT:-Checking Account}
      - SPARK_RECONCILIATION_AUTO_THRESHOLD=${SPARK_RECONCILIATION_AUTO_THRESHOLD:-0.92}
      - SPARK_RECONCILIATION_REVIEW_THRESHOLD=${SPARK_RECONCILIATION_REVIEW_THRESHOLD:-0.70}
      # LLM for reconciliation categorization (optional)
      - OLLAMA_URL=${OLLAMA_URL:-}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b}
      - SPARK_LLM_ENABLED=${SPARK_LLM_ENABLED:-false}

    volumes:
      - paperless-firefly-data:/app/data

    networks:
      - paperless-firefly-net

    depends_on:
      paperless-firefly:
        condition: service_healthy

  # Ollama LLM service (optional, Spark v1.0)
  # Local LLM for category suggestion assistance
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    profiles:
      - llm

    ports:
      - "${OLLAMA_PORT:-11434}:11434"

    volumes:
      - ollama-data:/root/.ollama

    networks:
      - paperless-firefly-net

    # GPU support (uncomment for NVIDIA GPU)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

volumes:
  paperless-firefly-data:
    driver: local
  ollama-data:
    driver: local

networks:
  paperless-firefly-net:
    driver: bridge
