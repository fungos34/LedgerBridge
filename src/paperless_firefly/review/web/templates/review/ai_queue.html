{% extends "review/base.html" %}
{% load static %}

{% block title %}AI Job Queue - SparkLink{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        margin-bottom: 1.5rem;
    }

    .page-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .page-header .text-muted {
        font-size: 0.875rem;
        color: var(--gray-500);
    }

    .queue-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    @media (max-width: 768px) {
        .queue-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    .stat-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.25rem;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--gray-100);
        transition: transform 0.15s, box-shadow 0.15s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card .stat-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-top: 0.5rem;
    }

    .stat-card.pending {
        border-left: 4px solid var(--gray-400);
    }
    .stat-card.pending .stat-value { color: var(--gray-600); }

    .stat-card.processing {
        border-left: 4px solid var(--blue-500);
    }
    .stat-card.processing .stat-value { color: var(--blue-500); }

    .stat-card.completed {
        border-left: 4px solid var(--green-500);
    }
    .stat-card.completed .stat-value { color: var(--green-500); }

    .stat-card.failed {
        border-left: 4px solid var(--red-500);
    }
    .stat-card.failed .stat-value { color: var(--red-500); }

    .filter-tabs {
        display: flex;
        gap: 0.25rem;
        margin-bottom: 1.5rem;
        background: var(--gray-100);
        padding: 0.25rem;
        border-radius: 0.5rem;
        width: fit-content;
    }

    .filter-tab {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        text-decoration: none;
        color: var(--gray-600);
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.15s;
    }

    .filter-tab:hover {
        color: var(--gray-900);
    }

    .filter-tab.active {
        background: white;
        color: var(--primary-600);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .jobs-table-container {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .jobs-table {
        width: 100%;
        border-collapse: collapse;
    }

    .jobs-table th,
    .jobs-table td {
        padding: 1rem 1.25rem;
        text-align: left;
        border-bottom: 1px solid var(--gray-100);
    }

    .jobs-table th {
        background: var(--gray-50);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
    }

    .jobs-table tr:hover {
        background: var(--gray-50);
    }

    .jobs-table tbody tr {
        transition: background 0.15s;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-badge.pending { background: var(--gray-100); color: var(--gray-700); }
    .status-badge.processing { background: var(--blue-100); color: var(--blue-700); }
    .status-badge.completed { background: var(--green-100); color: var(--green-700); }
    .status-badge.failed { background: var(--red-100); color: var(--red-700); }
    .status-badge.cancelled { background: var(--yellow-100); color: var(--yellow-700); }

    .job-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: nowrap;
    }

    /* Uniform action button base styles */
    .job-actions .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        min-width: 5.5rem;
        padding: 0.375rem 0.625rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
    }

    .job-actions .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-cancel {
        background: var(--gray-50);
        color: var(--gray-600);
        border: 1px solid var(--gray-300);
    }

    .btn-cancel:hover:not(:disabled) {
        background: var(--red-50);
        color: var(--red-600);
        border-color: var(--red-300);
    }

    .btn-retry {
        background: var(--blue-50);
        color: var(--blue-600);
        border: 1px solid var(--blue-200);
    }

    .btn-retry:hover:not(:disabled) {
        background: var(--blue-100);
    }

    .error-cell {
        max-width: 120px;
        position: relative;
    }

    .error-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: var(--red-50);
        border: 1px solid var(--red-200);
        border-radius: 0.375rem;
        color: var(--red-700);
        font-size: 0.7rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .error-badge:hover {
        background: var(--red-100);
        border-color: var(--red-300);
    }

    .error-badge .error-icon {
        flex-shrink: 0;
    }

    /* Error modal */
    .error-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, visibility 0.2s;
    }

    .error-modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .error-modal {
        background: white;
        border-radius: 0.75rem;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        transform: scale(0.95);
        transition: transform 0.2s;
        overflow: hidden;
    }

    .error-modal-overlay.active .error-modal {
        transform: scale(1);
    }

    .error-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.25rem;
        background: var(--red-50);
        border-bottom: 1px solid var(--red-200);
    }

    .error-modal-header h3 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--red-700);
    }

    .error-modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray-500);
        cursor: pointer;
        padding: 0.25rem;
        line-height: 1;
        border-radius: 0.25rem;
        transition: all 0.15s;
    }

    .error-modal-close:hover {
        background: var(--red-100);
        color: var(--red-700);
    }

    .error-modal-body {
        padding: 1.25rem;
        overflow-y: auto;
        max-height: 60vh;
    }

    .error-modal-body pre {
        margin: 0;
        padding: 1rem;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        font-size: 0.8125rem;
        font-family: 'Consolas', 'Monaco', monospace;
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.5;
        color: var(--gray-800);
    }

    .error-job-info {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-500);
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .empty-state svg {
        width: 5rem;
        height: 5rem;
        margin-bottom: 1rem;
        opacity: 0.4;
        color: var(--gray-400);
    }

    .empty-state h3 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        max-width: 400px;
        margin: 0 auto;
    }

    .empty-state a {
        color: var(--primary-600);
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }

    .pagination a,
    .pagination span {
        padding: 0.5rem 1rem;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        text-decoration: none;
        color: var(--gray-600);
        font-size: 0.875rem;
        background: white;
        transition: all 0.15s;
    }

    .pagination a:hover:not(.disabled) {
        background: var(--gray-50);
        border-color: var(--gray-300);
        color: var(--gray-900);
    }

    .pagination a.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: var(--gray-50);
    }

    .pagination .page-info {
        background: var(--gray-100);
        color: var(--gray-700);
        font-weight: 500;
    }

    .schedule-info {
        background: linear-gradient(135deg, var(--blue-50), #eff6ff);
        border: 1px solid var(--blue-200);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
    }

    .schedule-info-icon {
        font-size: 1.5rem;
        line-height: 1;
    }

    .schedule-info-content {
        flex: 1;
    }

    .schedule-info h3 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--blue-700);
        margin-bottom: 0.5rem;
    }

    .schedule-info p {
        font-size: 0.875rem;
        color: var(--blue-600);
        margin: 0;
    }

    .doc-link {
        color: var(--primary-600);
        text-decoration: none;
    }

    .doc-link:hover {
        text-decoration: underline;
    }

    .timestamp {
        font-size: 0.75rem;
        color: var(--gray-500);
    }

    /* Priority input */
    .priority-input {
        width: 4rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 0.25rem;
        text-align: center;
    }

    .priority-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .priority-input:disabled {
        background: var(--gray-100);
        cursor: not-allowed;
    }

    /* Run Now button */
    .btn-run-now {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        border: 1px solid #047857;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .btn-run-now:hover:not(:disabled) {
        background: linear-gradient(135deg, #047857, #065f46);
    }

    .btn-run-now:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Processing indicator */
    .processing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.75rem;
        color: var(--blue-600);
    }

    .processing-indicator .spinner {
        width: 1rem;
        height: 1rem;
        border: 2px solid var(--blue-200);
        border-top-color: var(--blue-600);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ü§ñ AI Job Queue</h1>
    <p class="text-muted">Scheduled AI interpretation jobs</p>
</div>

<!-- Queue Stats -->
<div class="queue-stats">
    <div class="stat-card pending">
        <div class="stat-value">{{ stats.pending }}</div>
        <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card processing">
        <div class="stat-value">{{ stats.processing }}</div>
        <div class="stat-label">Processing</div>
    </div>
    <div class="stat-card completed">
        <div class="stat-value">{{ stats.completed }}</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card failed">
        <div class="stat-value">{{ stats.failed }}</div>
        <div class="stat-label">Failed</div>
    </div>
</div>

<!-- Schedule Info -->
<div class="schedule-info">
    <div class="schedule-info-icon">üìÖ</div>
    <div class="schedule-info-content">
        <h3>Processing Schedule</h3>
        <p>
            Jobs are processed automatically based on settings configured in 
            <a href="{% url 'settings' %}#ai-schedule">Settings ‚Üí AI Schedule</a>.
            You can also run the processor manually with:
            <code>python manage.py process_ai_queue</code>
        </p>
    </div>
</div>

<!-- Filter Tabs -->
<div class="filter-tabs">
    <a href="{% url 'ai_queue_list' %}" class="filter-tab {% if not status_filter %}active{% endif %}">
        All ({{ stats.total }})
    </a>
    <a href="{% url 'ai_queue_list' %}?status=pending" class="filter-tab {% if status_filter == 'pending' %}active{% endif %}">
        Pending ({{ stats.pending }})
    </a>
    <a href="{% url 'ai_queue_list' %}?status=processing" class="filter-tab {% if status_filter == 'processing' %}active{% endif %}">
        Processing ({{ stats.processing }})
    </a>
    <a href="{% url 'ai_queue_list' %}?status=completed" class="filter-tab {% if status_filter == 'completed' %}active{% endif %}">
        Completed ({{ stats.completed }})
    </a>
    <a href="{% url 'ai_queue_list' %}?status=failed" class="filter-tab {% if status_filter == 'failed' %}active{% endif %}">
        Failed ({{ stats.failed }})
    </a>
</div>

<!-- Jobs Table -->
{% if jobs %}
<div class="jobs-table-container">
<table class="jobs-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Document</th>
            <th>Status</th>
            <th>Priority</th>
            <th>Scheduled</th>
            <th>Started</th>
            <th>Completed</th>
            <th>Retries</th>
            <th>Error</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for job in jobs %}
        <tr data-job-id="{{ job.id }}">
            <td>#{{ job.id }}</td>
            <td>
                <a href="{% url 'unified_review_detail' 'paperless' job.document_id %}" class="doc-link">
                    {% if job.doc_title %}
                        {{ job.doc_title|truncatechars:40 }}
                    {% else %}
                        Doc #{{ job.document_id }}
                    {% endif %}
                </a>
            </td>
            <td>
                <span class="status-badge {{ job.status|lower }}">{{ job.status }}</span>
            </td>
            <td>
                {% if job.status == 'PENDING' %}
                <input type="number" 
                       class="priority-input"
                       value="{{ job.priority }}"
                       min="-99"
                       max="99"
                       onchange="updatePriority({{ job.id }}, this.value)"
                       title="Higher priority jobs are processed first">
                {% else %}
                <input type="number" 
                       class="priority-input"
                       value="{{ job.priority }}"
                       disabled
                       title="Cannot change priority of {{ job.status|lower }} jobs">
                {% endif %}
            </td>
            <td>
                <span class="timestamp" title="{{ job.scheduled_at }}">{{ job.scheduled_at|date:"M j, Y H:i"|default:"-" }}</span>
            </td>
            <td>
                {% if job.started_at %}
                <span class="timestamp" title="{{ job.started_at }}">{{ job.started_at|date:"M j, Y H:i" }}</span>
                {% else %}-{% endif %}
            </td>
            <td>
                {% if job.completed_at %}
                <span class="timestamp" title="{{ job.completed_at }}">{{ job.completed_at|date:"M j, Y H:i" }}</span>
                {% else %}-{% endif %}
            </td>
            <td>{{ job.retry_count }}/{{ job.max_retries }}</td>
            <td class="error-cell">
                {% if job.error_message %}
                <button class="error-badge" onclick="showErrorModal({{ job.id }}, '{{ job.error_message|escapejs }}')" title="Click to view full error">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span>View Error</span>
                </button>
                {% else %}<span style="color: var(--gray-400);">‚Äî</span>{% endif %}
            </td>
            <td class="job-actions">
                {% if job.status == 'PENDING' %}
                <button class="action-btn btn-run-now" 
                        onclick="runJobNow({{ job.id }})"
                        {% if is_processing %}disabled title="Another job is currently processing"{% else %}title="Run this job immediately"{% endif %}>
                    <span>‚ñ∂Ô∏è</span> Run Now
                </button>
                {% endif %}
                {% if job.status == 'PENDING' or job.status == 'PROCESSING' %}
                <button class="action-btn btn-cancel" onclick="cancelJob({{ job.id }})" title="Cancel job">
                    <span>‚úï</span> Cancel
                </button>
                {% endif %}
                {% if job.status == 'FAILED' %}
                <button class="action-btn btn-retry" onclick="retryJob({{ job.id }})" title="Retry job">
                    <span>‚Üª</span> Retry
                </button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>

<!-- Pagination -->
<div class="pagination">
    {% if has_prev %}
    <a href="?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page|add:'-1' }}">‚Üê Previous</a>
    {% else %}
    <a href="#" class="disabled">‚Üê Previous</a>
    {% endif %}
    
    <span class="page-info">Page {{ page }}</span>
    
    {% if has_next %}
    <a href="?{% if status_filter %}status={{ status_filter }}&{% endif %}page={{ page|add:'1' }}">Next ‚Üí</a>
    {% else %}
    <a href="#" class="disabled">Next ‚Üí</a>
    {% endif %}
</div>

{% else %}
<div class="empty-state">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>
    <h3>No jobs{% if status_filter %} with status "{{ status_filter }}"{% endif %}</h3>
    <p>
        {% if status_filter %}
        Try viewing <a href="{% url 'ai_queue_list' %}">all jobs</a> or wait for new documents to be extracted.
        {% else %}
        AI jobs will appear here when documents are extracted with AI enabled.
        {% endif %}
    </p>
</div>
{% endif %}

<!-- Error Modal (outside jobs table for when jobs exist) -->
<div id="errorModalGlobal" class="error-modal-overlay" onclick="closeErrorModal(event)">
    <div class="error-modal" onclick="event.stopPropagation()">
        <div class="error-modal-header">
            <h3><span>‚ö†Ô∏è</span> Error Details</h3>
            <button class="error-modal-close" onclick="closeErrorModal()" title="Close">&times;</button>
        </div>
        <div class="error-modal-body">
            <div class="error-job-info">
                Job ID: <strong id="errorJobIdGlobal"></strong>
            </div>
            <pre id="errorContentGlobal"></pre>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Error modal functions
    function showErrorModal(jobId, errorMessage) {
        const modal = document.getElementById('errorModalGlobal');
        const jobIdEl = document.getElementById('errorJobIdGlobal');
        const contentEl = document.getElementById('errorContentGlobal');
        
        jobIdEl.textContent = '#' + jobId;
        contentEl.textContent = errorMessage;
        modal.classList.add('active');
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }
    
    function closeErrorModal(event) {
        // If called from overlay click, only close if clicking the overlay itself
        if (event && event.target !== event.currentTarget) return;
        
        const modal = document.getElementById('errorModalGlobal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    // Close on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeErrorModal();
        }
    });

    function cancelJob(jobId) {
        if (!confirm('Cancel this AI job?')) return;
        
        fetch('{% url "ai_queue_action" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `action=cancel&job_id=${jobId}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to cancel job: ' + data.error);
            }
        })
        .catch(e => alert('Error: ' + e));
    }
    
    function retryJob(jobId) {
        if (!confirm('Retry this failed AI job?')) return;
        
        fetch('{% url "ai_queue_action" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `action=retry&job_id=${jobId}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to retry job: ' + data.error);
            }
        })
        .catch(e => alert('Error: ' + e));
    }
    
    function updatePriority(jobId, newPriority) {
        fetch('{% url "ai_queue_action" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `action=update_priority&job_id=${jobId}&priority=${newPriority}`
        })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert('Failed to update priority: ' + data.error);
                location.reload(); // Reset to original value
            }
        })
        .catch(e => {
            alert('Error: ' + e);
            location.reload();
        });
    }
    
    function runJobNow(jobId) {
        if (!confirm('Run this AI job immediately?')) return;
        
        // Show processing indicator
        const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
        const actionsCell = row ? row.querySelector('.job-actions') : null;
        if (actionsCell) {
            actionsCell.innerHTML = '<span class="processing-indicator"><span class="spinner"></span> Running...</span>';
        }
        
        fetch('{% url "ai_queue_action" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `action=run_now&job_id=${jobId}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Reload after a short delay to show updated status
                setTimeout(() => location.reload(), 500);
            } else {
                alert('Failed to run job: ' + data.error);
                location.reload();
            }
        })
        .catch(e => {
            alert('Error: ' + e);
            location.reload();
        });
    }
</script>
{% endblock %}
