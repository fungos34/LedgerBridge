{% extends "review/base.html" %}

{% block title %}Unified Review - SparkLink{% endblock %}

{% block extra_css %}
<style>
    .unified-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    @media (max-width: 1200px) {
        .unified-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .stats-bar {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .stats-bar {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    .stat-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .stat-card .value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
    }
    
    .stat-card .label {
        font-size: 0.625rem;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .stat-card.warning .value { color: #d97706; }
    .stat-card.success .value { color: #059669; }
    .stat-card.info .value { color: #2563eb; }
    
    .panel {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .panel-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--gray-50);
    }
    
    .panel-header h2 {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .panel-header .count {
        background: var(--gray-200);
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .panel-body {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .record-list {
        list-style: none;
    }
    
    .record-item {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-100);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        transition: background 0.15s;
    }
    
    .record-item:hover {
        background: var(--gray-50);
    }
    
    .record-item.needs-action {
        background: #fef3c7;
        border-left: 3px solid #d97706;
    }
    
    .record-item.linked {
        background: #dcfce7;
        border-left: 3px solid #059669;
    }
    
    .record-item.orphan {
        background: #fee2e2;
        border-left: 3px solid #dc2626;
    }
    
    .record-info {
        flex: 1;
        min-width: 0;
    }
    
    .record-title {
        font-weight: 600;
        font-size: 0.875rem;
        color: var(--gray-900);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
    }
    
    .record-meta {
        font-size: 0.75rem;
        color: var(--gray-500);
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 0.25rem;
    }
    
    .record-amount {
        font-family: "SFMono-Regular", Consolas, monospace;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .record-status {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 500;
        text-transform: uppercase;
        white-space: nowrap;
    }
    
    .status-needs-link { background: #fef3c7; color: #92400e; }
    .status-needs-review { background: #dbeafe; color: #1d4ed8; }
    .status-linked { background: #dcfce7; color: #166534; }
    .status-orphan { background: #fee2e2; color: #991b1b; }
    .status-ready { background: #d1fae5; color: #065f46; }
    .status-confirmed { background: #ddd6fe; color: #5b21b6; }
    
    /* AI Status Badges */
    .ai-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.125rem;
        padding: 0.125rem 0.375rem;
        border-radius: 9999px;
        font-size: 0.6rem;
        font-weight: 500;
        margin-left: 0.25rem;
    }
    
    .ai-status-completed { background: #dcfce7; color: #166534; }
    .ai-status-pending { background: #fef3c7; color: #92400e; }
    .ai-status-processing { background: #dbeafe; color: #1d4ed8; }
    .ai-status-failed { background: #fee2e2; color: #991b1b; }
    .ai-status-none { background: #f3f4f6; color: #6b7280; }
    
    /* Owner/Shared Badge */
    .owner-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.6rem;
        font-weight: 500;
        background: #e0e7ff;
        color: #3730a3;
        margin-left: 0.25rem;
        cursor: pointer;
        transition: all 0.15s;
    }
    
    .owner-badge:hover {
        background: #c7d2fe;
    }
    
    .owner-badge .owner-icon {
        font-size: 0.7rem;
    }
    
    /* Quick Accept Button */
    .btn-quick-accept {
        background: linear-gradient(135deg, #059669, #047857);
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        box-shadow: 0 1px 3px rgba(5, 150, 105, 0.3);
        transition: all 0.15s;
    }
    
    .btn-quick-accept:hover {
        background: linear-gradient(135deg, #047857, #065f46);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(5, 150, 105, 0.4);
    }
    
    .btn-quick-accept:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .record-actions {
        display: flex;
        gap: 0.75rem;
        flex-shrink: 0;
    }
    
    .btn-review {
        background: var(--primary);
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .btn-review:hover {
        background: var(--primary-dark);
        color: white;
    }
    
    .empty-state {
        padding: 3rem;
        text-align: center;
        color: var(--gray-500);
    }
    
    .empty-state h3 {
        margin-bottom: 0.5rem;
    }
    
    /* Help text */
    .help-banner {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 0.5rem;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
        color: #1e40af;
    }
    
    .help-banner h3 {
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .help-banner ul {
        margin: 0;
        padding-left: 1.25rem;
    }
    
    .help-banner li {
        margin-bottom: 0.25rem;
    }
    
    /* Quick Link Dropdown */
    .link-dropdown {
        position: relative;
        display: inline-block;
    }
    
    .link-dropdown-btn {
        background: #f3f4f6;
        color: #374151;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        border: 1px solid #d1d5db;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .link-dropdown-btn:hover {
        background: #e5e7eb;
    }
    
    .link-dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        min-width: 280px;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        z-index: 100;
        padding: 0.5rem;
        margin-top: 0.25rem;
    }
    
    .link-dropdown.open .link-dropdown-menu {
        display: block;
    }
    
    .link-suggestion {
        padding: 0.5rem;
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.15s;
    }
    
    .link-suggestion:hover {
        background: #f3f4f6;
    }
    
    .link-suggestion-info {
        flex: 1;
        min-width: 0;
    }
    
    .link-suggestion-title {
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .link-suggestion-meta {
        font-size: 0.625rem;
        color: var(--gray-500);
    }
    
    .link-suggestion-score {
        background: var(--primary);
        color: white;
        padding: 0.125rem 0.375rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 600;
    }
    
    .no-suggestions {
        padding: 0.75rem;
        text-align: center;
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    .link-suggestion-actions {
        display: flex;
        gap: 0.25rem;
    }
    
    .btn-quick-link {
        background: #059669;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.625rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
    }
    
    .btn-quick-link:hover {
        background: #047857;
    }
    
    .btn-orphan {
        background: #dc2626;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.625rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
    }
    
    .btn-orphan:hover {
        background: #b91c1c;
    }
    
    .match-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.125rem;
        padding: 0.125rem 0.5rem;
        background: #dcfce7;
        color: #166534;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 500;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stat-card warning">
        <div class="value">{{ stats.paperless_pending }}</div>
        <div class="label">üìÑ Paperless Needs Action</div>
    </div>
    <div class="stat-card success">
        <div class="value">{{ stats.paperless_ready }}</div>
        <div class="label">‚úÖ Ready to Import</div>
    </div>
    <div class="stat-card warning">
        <div class="value">{{ stats.firefly_unmatched }}</div>
        <div class="label">üè¶ Firefly Unmatched</div>
    </div>
    <div class="stat-card info">
        <div class="value">{{ stats.firefly_matched }}</div>
        <div class="label">üîó Firefly Matched</div>
    </div>
</div>

<!-- Help Banner -->
<div class="help-banner">
    <h3>üìã Unified Review Workflow</h3>
    <ul>
        <li><strong>Review:</strong> Click "Review" on any record to edit details and set the category</li>
        <li><strong>Link:</strong> Match Paperless documents to Firefly transactions (or mark as orphan)</li>
        <li><strong>Import:</strong> Only linked or orphaned records can be imported to Firefly</li>
    </ul>
</div>

<!-- Two-Column Grid -->
<div class="unified-grid">
    <!-- Paperless Documents Panel -->
    <div class="panel">
        <div class="panel-header">
            <h2>üìÑ Paperless Documents <span class="count">{{ paperless_records|length }}</span></h2>
        </div>
        <div class="panel-body">
            {% if paperless_records %}
            <ul class="record-list">
                {% for record in paperless_records %}
                <li class="record-item {% if record.needs_linking or record.needs_review %}needs-action{% elif record.is_linked %}linked{% elif record.is_orphan %}orphan{% endif %}">
                    <div class="record-info">
                        <div class="record-title" title="{{ record.title }}">
                            {{ record.title|truncatechars:30 }}
                            {% if record.match_count > 0 %}
                            <span class="match-badge">{{ record.match_count }} match{% if record.match_count > 1 %}es{% endif %}</span>
                            {% endif %}
                            <!-- Owner Badge for shared documents -->
                            {% if record.is_shared_from_other %}
                            <span class="owner-badge" 
                                  title="Imported by {{ record.owner_username }}. Click to transfer ownership."
                                  onclick="showTransferOwnershipModal('paperless', {{ record.id }}, '{{ record.owner_username }}', '{{ record.title|escapejs }}', {{ record.document_id }})">
                                <span class="owner-icon">üë§</span>
                                {{ record.owner_username }}
                            </span>
                            {% endif %}
                            <!-- AI Status Badge -->
                            {% if record.ai_status == 'COMPLETED' %}
                            <span class="ai-status-badge ai-status-completed" title="AI suggestions ready">ü§ñ ‚úì</span>
                            {% elif record.ai_status == 'PENDING' %}
                            <span class="ai-status-badge ai-status-pending" title="AI scheduled">ü§ñ ‚è≥</span>
                            {% elif record.ai_status == 'PROCESSING' %}
                            <span class="ai-status-badge ai-status-processing" title="AI processing">ü§ñ ‚öôÔ∏è</span>
                            {% elif record.ai_status == 'FAILED' %}
                            <span class="ai-status-badge ai-status-failed" title="AI failed">ü§ñ ‚úó</span>
                            {% endif %}
                        </div>
                        <div class="record-meta">
                            <span class="record-amount">{{ record.currency|default:"EUR" }} {{ record.amount|floatformat:2|default:"‚Äî" }}</span>
                            <span>{{ record.date|default:"No date" }}</span>
                            {% if record.vendor %}
                            <span>‚Üí {{ record.vendor|truncatechars:20 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="record-status">
                        {% if record.review_decision == 'ACCEPTED' or record.review_decision == 'EDITED' %}
                        <span class="status-confirmed">‚úì Confirmed</span>
                        {% endif %}
                        {% if record.is_orphan %}
                        <span class="status-orphan">üìç Orphan</span>
                        {% elif record.is_linked %}
                        <span class="status-linked">üîó Linked</span>
                        {% elif record.needs_linking %}
                        <span class="status-needs-link">‚ö†Ô∏è Needs Link</span>
                        {% endif %}
                        {% if record.needs_review and record.review_decision != 'ACCEPTED' and record.review_decision != 'EDITED' %}
                        <span class="status-needs-review">üëÅÔ∏è Needs Review</span>
                        {% endif %}
                        {% if record.ready_for_import %}
                        <span class="status-ready">‚úÖ Ready</span>
                        {% endif %}
                    </div>
                    <div class="record-actions">
                        <!-- Quick Accept Button (visible when ready, but NOT if already reviewed manually) -->
                        {% if record.ready_for_import and record.review_decision != 'ACCEPTED' and record.review_decision != 'EDITED' %}
                        <button type="button" 
                                class="btn-quick-accept" 
                                onclick="quickAcceptDocument({{ record.document_id }})"
                                title="Accept and import this document">
                            ‚úì Accept
                        </button>
                        {% endif %}
                        {% if not record.is_linked and not record.is_orphan %}
                        <div class="link-dropdown" data-document-id="{{ record.document_id }}">
                            <button type="button" class="link-dropdown-btn" onclick="toggleLinkDropdown(this)">
                                üîó Link ‚ñº
                            </button>
                            <div class="link-dropdown-menu">
                                <div class="link-dropdown-content">
                                    <div style="text-align: center; padding: 0.5rem;">
                                        <small>Loading suggestions...</small>
                                    </div>
                                </div>
                                <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid #e5e7eb;">
                                <button type="button" class="btn-orphan" style="width: 100%;" onclick="markAsOrphan({{ record.document_id }})">
                                    üìç Mark as Orphan (no receipt)
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        <a href="{% url 'unified_review_detail' 'paperless' record.document_id %}" class="btn-review">
                            üìù Review
                        </a>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="empty-state">
                <h3>No Paperless Documents</h3>
                <p>Sync documents from Paperless to start reviewing</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Firefly Transactions Panel -->
    <div class="panel">
        <div class="panel-header">
            <h2>üè¶ Firefly Transactions <span class="count">{{ firefly_records|length }}</span></h2>
        </div>
        <div class="panel-body">
            {% if firefly_records %}
            <ul class="record-list">
                {% for record in firefly_records %}
                <li class="record-item {% if record.needs_linking %}needs-action{% elif record.is_linked %}linked{% elif record.is_orphan %}orphan{% endif %}">
                    <div class="record-info">
                        <div class="record-title" title="{{ record.description }}">
                            {{ record.description|truncatechars:30 }}
                            <!-- Owner Badge for shared records -->
                            {% if record.is_shared_from_other %}
                            <span class="owner-badge" 
                                  title="Imported by {{ record.owner_username }}. Click to transfer ownership."
                                  onclick="showTransferOwnershipModal('firefly', {{ record.firefly_id }}, '{{ record.owner_username }}', '{{ record.description|escapejs }}', null)">
                                <span class="owner-icon">üë§</span>
                                {{ record.owner_username }}
                            </span>
                            {% endif %}
                        </div>
                        <div class="record-meta">
                            <span class="record-amount">{{ record.currency|default:"EUR" }} {{ record.amount|floatformat:2|default:"‚Äî" }}</span>
                            <span>{{ record.date|default:"No date" }}</span>
                            {% if record.source_account or record.destination_account %}
                            <span title="{{ record.source_account|default:'?' }} ‚Üí {{ record.destination_account|default:'?' }}">{{ record.source_account|default:"?"|truncatechars:10 }} ‚Üí {{ record.destination_account|default:"?"|truncatechars:10 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="record-status">
                        {% if record.needs_linking %}
                        <span class="status-needs-link">‚ö†Ô∏è Unmatched</span>
                        {% elif record.is_orphan %}
                        <span class="status-orphan">üìç No Receipt</span>
                        {% elif record.is_linked %}
                        <span class="status-linked">üîó Linked</span>
                        {% endif %}
                    </div>
                    <div class="record-actions">
                        <a href="{% url 'unified_review_detail' 'firefly' record.firefly_id %}" class="btn-review">
                            üìù Review
                        </a>
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <div class="empty-state">
                <h3>No Firefly Transactions</h3>
                <p>Sync transactions from Firefly to start matching</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">
        <h2>Quick Actions</h2>
    </div>
    <div class="card-body">
        <!-- Active Filters Display -->
        <div id="active-filters-display" class="active-filters-container" style="display: none;">
            <div class="active-filters-header">
                <span class="active-filters-icon">üîç</span>
                <span class="active-filters-label">Active Filters:</span>
            </div>
            <div id="active-filters-badges" class="active-filters-badges"></div>
        </div>

        <div class="quick-actions-grid">
            <!-- Paperless Sync with Filters -->
            <div class="action-group">
                <h4 class="action-group-title">üìÑ Paperless Sync</h4>
                <form method="post" action="{% url 'sync_paperless' %}" class="sync-form" id="paperless-sync-form">
                    {% csrf_token %}
                    <div class="sync-filters">
                        <div class="filter-row">
                            <label for="paperless_days">Time range:</label>
                            <select name="days" id="paperless_days" class="form-control form-control-sm">
                                <option value="30">Last 30 days</option>
                                <option value="60">Last 60 days</option>
                                <option value="90" selected>Last 90 days</option>
                                <option value="180">Last 180 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <label for="paperless_tag_input">Tag filter:</label>
                            <div class="tag-input-container">
                                <input type="text" id="paperless_tag_input" class="form-control form-control-sm" placeholder="Type tag and press Enter">
                                <input type="hidden" name="tag_filter" id="paperless_tag_hidden">
                            </div>
                        </div>
                        <div id="paperless-tag-badges" class="tag-badges-container"></div>
                    </div>
                    <button type="submit" class="btn btn-outline">üìÑ Sync Paperless</button>
                </form>
            </div>
            
            <!-- Firefly Sync with Filters -->
            <div class="action-group">
                <h4 class="action-group-title">üè¶ Firefly Sync</h4>
                <form method="post" action="{% url 'sync_firefly_transactions' %}" class="sync-form">
                    {% csrf_token %}
                    <div class="sync-filters">
                        <div class="filter-row">
                            <label for="firefly_days">Time range:</label>
                            <select name="days" id="firefly_days" class="form-control form-control-sm">
                                <option value="30">Last 30 days</option>
                                <option value="60">Last 60 days</option>
                                <option value="90" selected>Last 90 days</option>
                                <option value="180">Last 180 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="filter-row">
                            <label for="firefly_account">Account:</label>
                            <select name="account_filter" id="firefly_account" class="form-control form-control-sm">
                                <option value="">All accounts</option>
                                {% for account in firefly_accounts %}
                                <option value="{{ account.id }}">{{ account.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-outline">üè¶ Sync Firefly</button>
                </form>
            </div>
            
            <!-- Auto-Match -->
            <div class="action-group">
                <h4 class="action-group-title">üîó Auto-Match</h4>
                <form method="post" action="{% url 'run_auto_match' %}" class="sync-form">
                    {% csrf_token %}
                    <p class="action-description">Automatically link documents to transactions when amount, date, and account match exactly.</p>
                    <button type="submit" class="btn btn-primary">üîó Run Auto-Match</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}

.action-group {
    background: var(--gray-50);
    border-radius: 0.5rem;
    padding: 1rem;
    border: 1px solid var(--gray-200);
}

.action-group-title {
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
}

.sync-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.sync-filters {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.filter-row label {
    font-size: 0.75rem;
    color: var(--gray-600);
    min-width: 80px;
}

.filter-row .form-control-sm {
    flex: 1;
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
    border: 1px solid var(--gray-300);
}

.action-description {
    font-size: 0.75rem;
    color: var(--gray-600);
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
}

/* Active Filters Display */
.active-filters-container {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
}

.active-filters-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
    font-weight: 600;
    color: #0369a1;
}

.active-filters-icon {
    font-size: 1rem;
}

.active-filters-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

/* Tag Badges */
.tag-input-container {
    flex: 1;
    display: flex;
    align-items: center;
}

.tag-badges-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-top: 0.375rem;
}

.tag-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.7rem;
    font-weight: 500;
    cursor: default;
    animation: tagBadgeIn 0.2s ease-out;
}

@keyframes tagBadgeIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.tag-badge-remove {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.15);
    cursor: pointer;
    font-size: 0.6rem;
    line-height: 1;
    transition: background 0.15s;
}

.tag-badge-remove:hover {
    background: rgba(0, 0, 0, 0.3);
}

/* Tag color variants */
.tag-badge-blue {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
}

.tag-badge-green {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #86efac;
}

.tag-badge-purple {
    background: #f3e8ff;
    color: #7c3aed;
    border: 1px solid #c4b5fd;
}

.tag-badge-orange {
    background: #ffedd5;
    color: #c2410c;
    border: 1px solid #fdba74;
}

.tag-badge-pink {
    background: #fce7f3;
    color: #be185d;
    border: 1px solid #f9a8d4;
}

.tag-badge-cyan {
    background: #cffafe;
    color: #0e7490;
    border: 1px solid #67e8f9;
}

.tag-badge-yellow {
    background: #fef9c3;
    color: #a16207;
    border: 1px solid #fde047;
}

.tag-badge-red {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

/* Filter type indicator for active filters */
.filter-type-badge {
    font-size: 0.65rem;
    padding: 0.125rem 0.375rem;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 0.25rem;
    margin-right: 0.25rem;
}
</style>

<!-- ==================== IMPORT QUEUE SECTION ==================== -->

{% if import_status.running %}
<div class="status-banner running" style="background: #dbeafe; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 1rem; margin: 1.5rem 0; display: flex; align-items: center; gap: 1rem;">
    <span style="font-size: 1.25rem;">üîÑ</span>
    <div>
        <strong style="color: #1e40af;">Import in progress...</strong>
        <div style="color: #3b82f6; font-size: 0.875rem;">{{ import_status.progress }}</div>
    </div>
</div>
{% elif import_status.error %}
<div class="status-banner error" style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 1rem; margin: 1.5rem 0; display: flex; align-items: center; gap: 1rem;">
    <span style="font-size: 1.25rem;">‚ùå</span>
    <div style="flex: 1;">
        <strong style="color: #991b1b;">Import failed</strong>
        <div style="color: #dc2626; font-size: 0.875rem;">{{ import_status.error }}</div>
        {% if debug_mode and import_status.traceback %}
        <details style="margin-top: 0.5rem;">
            <summary style="cursor: pointer; font-size: 0.85rem; color: #dc2626;">üîç Show detailed traceback</summary>
            <pre style="margin-top: 0.5rem; padding: 0.75rem; background: #fef2f2; border-radius: 0.25rem; font-size: 0.75rem; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;">{{ import_status.traceback }}</pre>
        </details>
        {% endif %}
    </div>
</div>
{% elif import_status.result %}
<div class="status-banner success" style="background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 0.5rem; padding: 1rem; margin: 1.5rem 0; display: flex; align-items: center; gap: 1rem;">
    <span style="font-size: 1.25rem;">‚úÖ</span>
    <div style="color: #065f46;">{{ import_status.result }}</div>
</div>
{% endif %}

{% if failed_items %}
<div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #dc2626;">
    <div class="card-header" style="background: #fef2f2;">
        <h2 style="color: #991b1b;">‚ö†Ô∏è Failed Imports ({{ failed_items|length }})</h2>
    </div>
    
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #fef2f2;">
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Document</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Amount</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Date</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Error</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in failed_items %}
            <tr style="border-bottom: 1px solid #fee2e2;">
                <td style="padding: 0.75rem;">
                    <a href="{% url 'unified_review_detail' 'paperless' item.document_id %}" style="color: #2563eb; text-decoration: none;">{{ item.title|truncatechars:40 }}</a>
                </td>
                <td style="padding: 0.75rem; font-family: monospace; font-size: 0.875rem;">{{ item.amount }} {{ item.currency }}</td>
                <td style="padding: 0.75rem; font-size: 0.875rem;">{{ item.date }}</td>
                <td style="padding: 0.75rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; color: #991b1b; font-size: 0.75rem;">
                    {{ item.error_message|default:"Unknown error" }}
                </td>
                <td style="padding: 0.75rem;">
                    <form method="post" action="{% url 'dismiss_import' item.external_id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm" style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #fecaca; cursor: pointer; font-size: 0.75rem;" title="Reject this extraction and remove from retry queue">
                            ‚úï Dismiss
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="padding: 0.75rem 1rem; background: #fef2f2; font-size: 0.875rem; color: #7f1d1d;">
        üí° Tip: These items will be retried when you click "Import All". Click "Dismiss" to reject and skip permanently.
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>üì§ Import Queue ({{ ready_items|length }})</h2>
        <form method="post" action="{% url 'run_import' %}" style="display: inline;">
            {% csrf_token %}
            {% if ready_items or failed_items %}
            <button type="submit" class="btn btn-success" {% if import_status.running %}disabled{% endif %}>
                {% if import_status.running %}
                ‚è≥ Importing...
                {% else %}
                Import All to Firefly ({{ ready_items|length|add:failed_items|length }}) ‚Üí
                {% endif %}
            </button>
            {% else %}
            <button type="button" class="btn btn-success" disabled style="opacity: 0.5; cursor: not-allowed;">
                Import All to Firefly ‚Üí
            </button>
            {% endif %}
        </form>
    </div>
    
    {% if ready_items %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: var(--gray-50);">
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Document</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Amount</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Date</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Vendor</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Source</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Status</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in ready_items %}
            <tr style="border-bottom: 1px solid var(--gray-100);">
                <td style="padding: 0.75rem;">
                    <a href="{% url 'unified_review_detail' 'paperless' item.document_id %}" style="color: #2563eb; text-decoration: none;">{{ item.title|truncatechars:40 }}</a>
                </td>
                <td style="padding: 0.75rem; font-family: monospace; font-size: 0.875rem;">{{ item.amount }} {{ item.currency }}</td>
                <td style="padding: 0.75rem; font-size: 0.875rem;">{{ item.date }}</td>
                <td style="padding: 0.75rem; font-size: 0.875rem;">{{ item.vendor|default:"-" }}</td>
                <td style="padding: 0.75rem; font-size: 0.875rem;">{{ item.source_account }}</td>
                <td style="padding: 0.75rem;">
                    {% if item.review_state == 'AUTO' %}
                    <span style="display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 500; background: #dbeafe; color: #1e40af;">AUTO</span>
                    {% elif item.review_decision == 'ACCEPTED' %}
                    <span style="display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 500; background: #dcfce7; color: #166534;">Accepted</span>
                    {% elif item.review_decision == 'EDITED' %}
                    <span style="display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.625rem; font-weight: 500; background: #fef3c7; color: #92400e;">Edited</span>
                    {% endif %}
                </td>
                <td style="padding: 0.75rem;">
                    {% if item.review_decision %}
                    <form method="post" action="{% url 'reset_extraction' item.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Reset to re-review this extraction" onclick="return confirm('Reset this extraction to re-review it?')">
                            üîÑ Reset
                        </button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 2rem; color: var(--gray-500);">
        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì≠</div>
        <div>No transactions ready for import</div>
        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Review and link documents above to queue them for import</p>
    </div>
    {% endif %}
</div>

{% if recent_imports %}
<div class="card" style="margin-top: 1.5rem;">
    <div class="card-header">
        <h2>‚úÖ Recently Imported</h2>
    </div>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: var(--gray-50);">
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Document</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Firefly Transaction</th>
                <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; font-weight: 600;">Imported At</th>
            </tr>
        </thead>
        <tbody>
            {% for imp in recent_imports %}
            <tr style="border-bottom: 1px solid var(--gray-100);">
                <td style="padding: 0.75rem;">
                    <a href="{{ paperless_url }}/documents/{{ imp.document_id }}" target="_blank" title="Open in Paperless" style="color: #2563eb; text-decoration: none;">
                        üìÑ {% if imp.title %}{{ imp.title|truncatechars:35 }}{% else %}Doc #{{ imp.document_id }}{% endif %}
                    </a>
                </td>
                <td style="padding: 0.75rem;">
                    {% if imp.firefly_id %}
                    <a href="{{ firefly_url }}/transactions/show/{{ imp.firefly_id }}" target="_blank" style="color: #2563eb; text-decoration: none;">
                        üí∞ View Transaction #{{ imp.firefly_id }}
                    </a>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td style="padding: 0.75rem; font-size: 0.875rem; color: var(--gray-600);">{{ imp.created_at|slice:":19" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if import_status.running %}
<script>
// Auto-refresh while import is running
setTimeout(function() {
    window.location.reload();
}, 3000);
</script>
{% endif %}

<!-- ==================== END IMPORT QUEUE SECTION ==================== -->

<script>
// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.link-dropdown')) {
        document.querySelectorAll('.link-dropdown.open').forEach(el => el.classList.remove('open'));
    }
});

function toggleLinkDropdown(btn) {
    const dropdown = btn.closest('.link-dropdown');
    const wasOpen = dropdown.classList.contains('open');
    
    // Close all other dropdowns
    document.querySelectorAll('.link-dropdown.open').forEach(el => el.classList.remove('open'));
    
    if (!wasOpen) {
        dropdown.classList.add('open');
        loadSuggestions(dropdown);
    }
}

function loadSuggestions(dropdown) {
    const documentId = dropdown.dataset.documentId;
    const contentEl = dropdown.querySelector('.link-dropdown-content');
    
    fetch(`/api/link-suggestions/paperless/${documentId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.suggestions && data.suggestions.length > 0) {
                contentEl.innerHTML = data.suggestions.map(s => `
                    <div class="link-suggestion">
                        <div class="link-suggestion-info">
                            <div class="link-suggestion-title">${s.description || 'Transaction'}</div>
                            <div class="link-suggestion-meta">${s.amount || '?'} ‚Ä¢ ${s.date || '?'}</div>
                        </div>
                        <span class="link-suggestion-score">${s.score}%</span>
                        <div class="link-suggestion-actions">
                            <button type="button" class="btn-quick-link" onclick="quickLink(${documentId}, ${s.id})">
                                Link
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                contentEl.innerHTML = '<div class="no-suggestions">No matching transactions found</div>';
            }
        })
        .catch(error => {
            console.error('Error loading suggestions:', error);
            contentEl.innerHTML = '<div class="no-suggestions">Error loading suggestions</div>';
        });
}

function quickLink(paperlessId, fireflyId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_quick_link" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            paperless_id: paperlessId,
            firefly_id: fireflyId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated status
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error creating link: ' + error);
    });
}

function markAsOrphan(paperlessId) {
    if (!confirm('Mark this document as orphan (no matching transaction)?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_quick_link" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            paperless_id: paperlessId,
            mark_orphan: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error marking as orphan: ' + error);
    });
}

// Quick accept a document (applies AI suggestions and marks as accepted)
function quickAcceptDocument(documentId) {
    if (!confirm('Accept this document?\n\nIf AI has processed this document, all AI suggestions will be applied automatically.\n\nThis action will be recorded in the audit trail.')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/review/paperless/${documentId}/quick-accept/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show message about how many AI suggestions were applied
            let msg = 'Document accepted!';
            if (data.ai_suggestions_applied && data.ai_suggestions_applied > 0) {
                msg += ` (${data.ai_suggestions_applied} AI suggestion(s) applied)`;
            }
            alert(msg);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error accepting document: ' + error);
    });
}

// Transfer ownership modal
let transferModalData = null;

function showTransferOwnershipModal(recordType, recordId, currentOwner, recordTitle, documentId) {
    transferModalData = { recordType, recordId, documentId };
    document.getElementById('transfer-record-title').textContent = recordTitle;
    document.getElementById('transfer-current-owner').textContent = currentOwner;
    
    // Clear and disable the select while loading
    const selectEl = document.getElementById('transfer-new-owner');
    selectEl.innerHTML = '<option value="">Loading eligible users...</option>';
    selectEl.disabled = true;
    
    document.getElementById('transfer-modal').style.display = 'flex';
    
    // Only fetch eligible users for Paperless documents (we have document_id)
    if (recordType === 'paperless' && documentId) {
        fetch(`{% url 'api_get_eligible_owners' %}?document_id=${documentId}`)
            .then(response => response.json())
            .then(data => {
                selectEl.innerHTML = '<option value="">Select a user...</option>';
                if (data.success && data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        selectEl.appendChild(option);
                    });
                } else {
                    selectEl.innerHTML = '<option value="">No eligible users found</option>';
                }
                selectEl.disabled = false;
            })
            .catch(error => {
                console.error('Error fetching eligible users:', error);
                selectEl.innerHTML = '<option value="">Error loading users</option>';
                selectEl.disabled = false;
            });
    } else {
        // For Firefly records, show all users (no Paperless document to check)
        selectEl.innerHTML = '<option value="">Select a user...</option>';
        {% for user in all_users %}
        selectEl.innerHTML += '<option value="{{ user.id }}">{{ user.username }}</option>';
        {% endfor %}
        selectEl.disabled = false;
    }
}

function closeTransferModal() {
    document.getElementById('transfer-modal').style.display = 'none';
    transferModalData = null;
}

function transferOwnership() {
    if (!transferModalData) return;
    
    const newOwnerId = document.getElementById('transfer-new-owner').value;
    if (!newOwnerId) {
        alert('Please select a new owner');
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_transfer_ownership" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            record_type: transferModalData.recordType,
            record_id: transferModalData.recordId,
            new_owner_id: parseInt(newOwnerId)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Ownership transferred successfully!\n\nNote: Transaction links have been removed and will need to be re-established.');
            closeTransferModal();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error transferring ownership: ' + error);
    });
}
</script>

<!-- Transfer Ownership Modal -->
<div id="transfer-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>üì§ Transfer Ownership</h3>
        <div class="modal-body">
            <p><strong>Document:</strong> <span id="transfer-record-title"></span></p>
            <p><strong>Current Owner:</strong> <span id="transfer-current-owner"></span></p>
            <div class="form-group" style="margin-top: 1rem;">
                <label for="transfer-new-owner">Transfer to:</label>
                <select id="transfer-new-owner" class="form-control">
                    <option value="">Loading eligible users...</option>
                    <!-- Options populated dynamically based on Paperless document access -->
                </select>
            </div>
            <p class="text-warning" style="margin-top: 1rem; font-size: 0.875rem; color: #d97706;">
                ‚ö†Ô∏è Warning: Transferring ownership will remove any existing transaction links. 
                The new owner will need to re-link the document.
            </p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeTransferModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="transferOwnership()">Transfer</button>
        </div>
    </div>
</div>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.modal-content h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: var(--gray-900);
}

.modal-body {
    margin-bottom: 1.5rem;
}

.modal-body p {
    margin: 0.5rem 0;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}
</style>

<script>
// ==================== TAG BADGE SYSTEM ====================

// Color palette for tag badges
const tagColors = ['blue', 'green', 'purple', 'orange', 'pink', 'cyan', 'yellow', 'red'];

// Track tags for Paperless sync
let paperlessTags = [];

// Get consistent color for a tag (based on string hash)
function getTagColor(tag) {
    let hash = 0;
    for (let i = 0; i < tag.length; i++) {
        hash = ((hash << 5) - hash) + tag.charCodeAt(i);
        hash = hash & hash;
    }
    return tagColors[Math.abs(hash) % tagColors.length];
}

// Create a tag badge element
function createTagBadge(tag, onRemove, showType = null) {
    const color = getTagColor(tag);
    const badge = document.createElement('span');
    badge.className = `tag-badge tag-badge-${color}`;
    
    let content = '';
    if (showType) {
        content += `<span class="filter-type-badge">${showType}</span>`;
    }
    content += `<span class="tag-badge-text">${escapeHtml(tag)}</span>`;
    content += `<span class="tag-badge-remove" title="Remove">√ó</span>`;
    
    badge.innerHTML = content;
    
    badge.querySelector('.tag-badge-remove').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        onRemove(tag);
    });
    
    return badge;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Update the hidden input and badge display for Paperless tags
function updatePaperlessTags() {
    const hiddenInput = document.getElementById('paperless_tag_hidden');
    const badgesContainer = document.getElementById('paperless-tag-badges');
    
    if (!hiddenInput || !badgesContainer) return;
    
    // Update hidden input with comma-separated tags
    hiddenInput.value = paperlessTags.join(',');
    
    // Clear and rebuild badges
    badgesContainer.innerHTML = '';
    paperlessTags.forEach(tag => {
        const badge = createTagBadge(tag, removePaperlessTag);
        badgesContainer.appendChild(badge);
    });
    
    // Update active filters display
    updateActiveFiltersDisplay();
}

// Add a tag to Paperless filter
function addPaperlessTag(tag) {
    const trimmedTag = tag.trim().toLowerCase();
    if (trimmedTag && !paperlessTags.includes(trimmedTag)) {
        paperlessTags.push(trimmedTag);
        updatePaperlessTags();
    }
}

// Remove a tag from Paperless filter
function removePaperlessTag(tag) {
    paperlessTags = paperlessTags.filter(t => t !== tag);
    updatePaperlessTags();
}

// Update the active filters display section
function updateActiveFiltersDisplay() {
    const container = document.getElementById('active-filters-display');
    const badgesArea = document.getElementById('active-filters-badges');
    
    if (!container || !badgesArea) return;
    
    badgesArea.innerHTML = '';
    let hasFilters = false;
    
    // Add Paperless time range if not default
    const paperlessDays = document.getElementById('paperless_days');
    if (paperlessDays && paperlessDays.value !== '90') {
        hasFilters = true;
        const badge = createFilterBadge('üìÑ ' + paperlessDays.options[paperlessDays.selectedIndex].text, () => {
            paperlessDays.value = '90';
            updateActiveFiltersDisplay();
        });
        badgesArea.appendChild(badge);
    }
    
    // Add Paperless tags
    paperlessTags.forEach(tag => {
        hasFilters = true;
        const badge = createTagBadge(tag, removePaperlessTag, 'üìÑ Tag');
        badgesArea.appendChild(badge);
    });
    
    // Add Firefly time range if not default
    const fireflyDays = document.getElementById('firefly_days');
    if (fireflyDays && fireflyDays.value !== '90') {
        hasFilters = true;
        const badge = createFilterBadge('üè¶ ' + fireflyDays.options[fireflyDays.selectedIndex].text, () => {
            fireflyDays.value = '90';
            updateActiveFiltersDisplay();
        });
        badgesArea.appendChild(badge);
    }
    
    // Add Firefly account filter if set
    const fireflyAccount = document.getElementById('firefly_account');
    if (fireflyAccount && fireflyAccount.value) {
        hasFilters = true;
        const accountName = fireflyAccount.options[fireflyAccount.selectedIndex].text;
        const badge = createFilterBadge('üè¶ ' + accountName, () => {
            fireflyAccount.value = '';
            updateActiveFiltersDisplay();
        });
        badgesArea.appendChild(badge);
    }
    
    container.style.display = hasFilters ? 'block' : 'none';
}

// Create a simple filter badge (for non-tag filters)
function createFilterBadge(label, onRemove) {
    const badge = document.createElement('span');
    badge.className = 'tag-badge tag-badge-blue';
    badge.innerHTML = `
        <span class="tag-badge-text">${escapeHtml(label)}</span>
        <span class="tag-badge-remove" title="Remove">√ó</span>
    `;
    badge.querySelector('.tag-badge-remove').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        onRemove();
    });
    return badge;
}

// Initialize tag input functionality
document.addEventListener('DOMContentLoaded', function() {
    const tagInput = document.getElementById('paperless_tag_input');
    
    if (tagInput) {
        // Add tag on Enter key
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = this.value.trim();
                if (tag) {
                    addPaperlessTag(tag);
                    this.value = '';
                }
            }
        });
        
        // Add tag on comma (for quick multi-tag entry)
        tagInput.addEventListener('input', function(e) {
            if (this.value.includes(',')) {
                const tags = this.value.split(',').map(t => t.trim()).filter(t => t);
                tags.forEach(addPaperlessTag);
                this.value = '';
            }
        });
    }
    
    // Listen for changes to filter dropdowns
    const paperlessDays = document.getElementById('paperless_days');
    const fireflyDays = document.getElementById('firefly_days');
    const fireflyAccount = document.getElementById('firefly_account');
    
    if (paperlessDays) {
        paperlessDays.addEventListener('change', updateActiveFiltersDisplay);
    }
    if (fireflyDays) {
        fireflyDays.addEventListener('change', updateActiveFiltersDisplay);
    }
    if (fireflyAccount) {
        fireflyAccount.addEventListener('change', updateActiveFiltersDisplay);
    }
    
    // Initial update
    updateActiveFiltersDisplay();
});
</script>
{% endblock %}
