{% extends "review/base.html" %}

{% block title %}Review: {{ extraction.paperless_title }}{% endblock %}
{% block pending_count %}{{ pending_count }}{% endblock %}

{% block extra_css %}
<style>
    .review-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        align-items: start;
    }
    
    @media (max-width: 1024px) {
        .review-layout {
            grid-template-columns: 1fr;
        }
    }
    
    .document-viewer {
        position: sticky;
        top: 1rem;
        height: calc(100vh - 8rem);
        min-height: 500px;
    }
    
    /* Responsive iframe for small screens */
    @media (max-height: 700px) {
        .document-viewer {
            max-height: 50vh;
            min-height: 300px;
        }
    }
    
    @media (max-width: 768px) {
        .document-viewer {
            position: relative;
            max-height: 50vh;
            min-height: 300px;
        }
    }
    
    .document-viewer.collapsed {
        height: 60px;
        min-height: 60px;
        overflow: hidden;
    }
    
    .document-viewer.collapsed .card-body {
        display: none;
    }
    
    .document-viewer iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0.375rem;
    }
    
    .document-viewer-fallback {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: var(--gray-100);
        border-radius: 0.375rem;
        text-align: center;
        padding: 2rem;
    }
    
    .document-viewer-fallback img {
        max-width: 200px;
        margin-bottom: 1rem;
        border-radius: 0.25rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .form-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        margin-bottom: 1rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .nav-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .nav-buttons .position {
        color: var(--gray-500);
        font-size: 0.875rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .confidence-detail {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .confidence-item {
        text-align: center;
        padding: 0.5rem;
        background: var(--gray-50);
        border-radius: 0.25rem;
    }
    
    .confidence-item-label {
        font-size: 0.625rem;
        text-transform: uppercase;
        color: var(--gray-500);
    }
    
    .confidence-item-value {
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    /* Required field indicator */
    .required-star {
        color: #dc2626;
        font-weight: bold;
    }
    
    /* Field validation error styling */
    .form-input.field-error,
    .form-input:invalid:not(:focus) {
        border-color: #dc2626;
        box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.1);
    }
    
    .form-group.has-error .form-label {
        color: #dc2626;
    }
    
    /* Toggle button for document viewer */
    .viewer-toggle {
        background: var(--gray-100);
        border: 1px solid var(--gray-300);
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        display: none;
    }
    
    @media (max-width: 1024px) {
        .viewer-toggle {
            display: inline-block;
        }
    }
    
    /* Tooltip styling */
    .form-label[title] {
        cursor: help;
        border-bottom: 1px dotted var(--gray-400);
    }
    
    .raw-text {
        max-height: 200px;
        overflow-y: auto;
        background: var(--gray-50);
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-family: monospace;
        font-size: 0.75rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .provenance-info {
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    .provenance-info dt {
        font-weight: 500;
        display: inline;
    }
    
    .provenance-info dd {
        display: inline;
        margin: 0;
        margin-right: 1rem;
    }
    
    .already-reviewed {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        color: #92400e;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    
    /* AI badge styling */
    .badge-ai {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: linear-gradient(135deg, #818cf8, #6366f1);
        color: white;
        font-size: 0.625rem;
        font-weight: 600;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
        vertical-align: middle;
        cursor: help;
    }
    
    .btn-xs {
        font-size: 0.625rem;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
    }
    
    .btn-outline {
        background: transparent;
        border: 1px solid var(--gray-300);
        color: var(--gray-700);
    }
    
    .btn-outline:hover {
        background: var(--gray-50);
        border-color: var(--gray-400);
    }
</style>
{% endblock %}

{% block content %}
<div class="nav-buttons">
    <div class="flex gap-2">
        <a href="{% url 'list' %}" class="btn btn-outline">‚Üê Back to List</a>
        {% if prev_id %}
        <a href="{% url 'detail' prev_id %}" class="btn btn-outline">‚Üê Previous</a>
        {% endif %}
    </div>
    <span class="position">{{ current_position }} of {{ pending_count }}</span>
    <div>
        {% if next_id %}
        <a href="{% url 'detail' next_id %}" class="btn btn-outline">Next ‚Üí</a>
        {% endif %}
    </div>
</div>

{% if already_reviewed %}
<div class="already-reviewed">
    ‚ö†Ô∏è This extraction has already been reviewed ({{ record.review_decision }}).
    You can still modify and re-submit if needed.
</div>
{% endif %}

<div class="review-layout">
    <!-- Document Viewer -->
    <div class="card document-viewer" id="document-viewer">
        <div class="card-header">
            <h2>üìÑ {{ extraction.paperless_title|truncatechars:40 }}</h2>
            <div class="flex gap-2">
                <button type="button" class="viewer-toggle" onclick="toggleDocumentViewer()" title="Toggle document preview">
                    üìÑ Toggle Preview
                </button>
                <a href="{% url 'document' document_id %}?download=1" class="btn btn-sm btn-outline" download>
                    ‚¨á Download
                </a>
                <a href="{{ paperless_url }}/documents/{{ document_id }}/" target="_blank" class="btn btn-sm btn-outline">
                    Open in Paperless ‚Üó
                </a>
            </div>
        </div>
        <div class="card-body" style="height: calc(100% - 60px); padding: 0;">
            <iframe src="{% url 'document' document_id %}" 
                    title="Document Preview"
                    id="document-iframe"
                    style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    
    <!-- Edit Form -->
    <div>
        <form method="post" action="{% url 'save' record.id %}">
            {% csrf_token %}
            <div class="card">
                <div class="card-header">
                    <h2>Transaction Details</h2>
                    <span class="badge {% if record.review_state == 'AUTO' %}badge-auto{% elif record.review_state == 'REVIEW' %}badge-review{% else %}badge-manual{% endif %}">
                        {{ record.review_state }}
                    </span>
                </div>
                <div class="card-body">
                    <!-- Amount & Currency -->
                    <div class="form-section">
                        <div class="form-section-title">Amount</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="amount">Amount *</label>
                                <input type="number" 
                                       id="amount" 
                                       name="amount" 
                                       class="form-input" 
                                       value="{{ proposal.amount }}"
                                       step="0.01"
                                       required>
                                <div class="form-help">Confidence: {{ confidence.amount|floatformat:0 }}%</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="currency">Currency *</label>
                                <input type="text" 
                                       id="currency" 
                                       name="currency" 
                                       class="form-input" 
                                       value="{{ proposal.currency }}"
                                       maxlength="3"
                                       style="text-transform: uppercase;"
                                       required>
                                <div class="form-help">Confidence: {{ confidence.currency|floatformat:0 }}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date -->
                    <div class="form-section">
                        <div class="form-section-title">Date</div>
                        <div class="form-group">
                            <label class="form-label" for="date">Transaction Date *</label>
                            <input type="date" 
                                   id="date" 
                                   name="date" 
                                   class="form-input" 
                                   value="{{ proposal.date }}"
                                   required>
                            <div class="form-help">Confidence: {{ confidence.date|floatformat:0 }}%</div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="form-section">
                        <div class="form-section-title">Description</div>
                        <div class="form-group">
                            <label class="form-label" for="description">Description *</label>
                            <input type="text" 
                                   id="description" 
                                   name="description" 
                                   class="form-input" 
                                   value="{{ proposal.description }}"
                                   required>
                            <div class="form-help">Confidence: {{ confidence.description|floatformat:0 }}%</div>
                        </div>
                    </div>
                    
                    <!-- Accounts -->
                    <div class="form-section">
                        <div class="form-section-title">Accounts</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="source_account">Source Account <span class="required-star" style="color: #dc2626;">*</span></label>
                                <select id="source_account" 
                                        name="source_account" 
                                        class="form-input" 
                                        required>
                                    <option value="">-- Select Source Account --</option>
                                    {% for account in firefly_accounts %}
                                    <option value="{{ account.name }}" {% if account.name == proposal.source_account %}selected{% endif %}>
                                        {{ account.name }} ({{ account.currency_code }})
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if not firefly_accounts %}
                                <div class="form-help" style="color: #dc2626;">‚ö†Ô∏è Could not load Firefly accounts. Check your Firefly API settings.</div>
                                {% else %}
                                <div class="form-help">The bank account to debit (required for transactions)</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="destination_account">Destination / Vendor</label>
                                <input type="text" 
                                       id="destination_account" 
                                       name="destination_account" 
                                       class="form-input" 
                                       value="{{ proposal.destination_account|default:'' }}"
                                       placeholder="e.g., Supermarket">
                                <div class="form-help">Confidence: {{ confidence.vendor|floatformat:0 }}%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category & Type -->
                    <div class="form-section">
                        <div class="form-section-title">Classification</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="category" title="The spending category for this transaction (e.g., Groceries, Utilities). Categories help organize your finances.">
                                    Category
                                    {% if llm_suggestion %}
                                    <span class="badge badge-ai" title="AI suggested: {{ llm_suggestion.category }} ({{ llm_suggestion.confidence|floatformat:0 }}% confidence)">
                                        ü§ñ AI
                                    </span>
                                    {% elif weighted_category %}
                                    <span class="badge badge-info" title="Computed from split items">
                                        üìä From splits
                                    </span>
                                    {% endif %}
                                </label>
                                <select id="category" 
                                        name="category" 
                                        class="form-input">
                                    <option value="">-- Select Category --</option>
                                    {% for cat in firefly_categories %}
                                    <option value="{{ cat.name }}" {% if cat.name == proposal.category or cat.name == weighted_category and not proposal.category %}selected{% endif %}>
                                        {{ cat.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if llm_suggestion %}
                                <div class="form-help">
                                    AI suggested: <strong>{{ llm_suggestion.category }}</strong>
                                    <button type="button" class="btn btn-xs btn-outline" 
                                            onclick="document.getElementById('category').value='{{ llm_suggestion.category }}'">
                                        Use suggestion
                                    </button>
                                </div>
                                {% elif weighted_category %}
                                <div class="form-help">
                                    Computed from splits: <strong>{{ weighted_category }}</strong>
                                </div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="transaction_type">Transaction Type *</label>
                                <select id="transaction_type" name="transaction_type" class="form-input" required>
                                    <option value="withdrawal" {% if proposal.transaction_type.value == 'WITHDRAWAL' %}selected{% endif %}>Withdrawal (Expense)</option>
                                    <option value="deposit" {% if proposal.transaction_type.value == 'DEPOSIT' %}selected{% endif %}>Deposit (Income)</option>
                                    <option value="transfer" {% if proposal.transaction_type.value == 'TRANSFER' %}selected{% endif %}>Transfer</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Invoice Number -->
                    <div class="form-section">
                        <div class="form-section-title">Reference</div>
                        <div class="form-group">
                            <label class="form-label" for="invoice_number">Invoice / Receipt Number</label>
                            <input type="text" 
                                   id="invoice_number" 
                                   name="invoice_number" 
                                   class="form-input" 
                                   value="{{ proposal.invoice_number|default:'' }}"
                                   placeholder="e.g., INV-2024-001">
                            <div class="form-help">Confidence: {{ confidence.invoice_number|floatformat:0 }}%</div>
                        </div>
                    </div>
                    
                    <!-- Split Transaction / Line Items -->
                    <div class="form-section">
                        <div class="form-section-title">
                            Split Transaction
                            <label style="font-weight: normal; font-size: 0.75rem; margin-left: 0.5rem; text-transform: none;">
                                <input type="checkbox" id="enable_split" onchange="toggleSplitMode(this.checked)">
                                Enable split booking
                            </label>
                        </div>
                        <div id="split-container" style="display: none;">
                            <div class="form-help mb-3">
                                Split this transaction across multiple lines with different categories. 
                                The sum must equal the total amount above.
                            </div>
                            <div id="line-items-container">
                                <!-- Line items will be added dynamically -->
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button type="button" class="btn btn-sm btn-outline" onclick="addLineItem()">
                                    + Add Line
                                </button>
                                <span id="split-total" class="form-help" style="margin-left: auto; font-weight: 600;"></span>
                            </div>
                        </div>
                        <input type="hidden" id="line_items_json" name="line_items_json" value="">
                    </div>
                    
                    <!-- Potential Matches (from Firefly transactions) -->
                    {% if matching_transactions %}
                    <div class="form-section">
                        <div class="form-section-title">
                            Potential Matches ({{ matching_transactions|length }} found)
                        </div>
                        <div class="form-help mb-2">
                            These existing Firefly transactions may match this document. 
                            Link to avoid creating a duplicate.
                        </div>
                        <div class="matching-transactions">
                            {% for match in matching_transactions %}
                            <div class="match-card" style="border: 1px solid var(--gray-200); border-radius: 0.375rem; padding: 0.75rem; margin-bottom: 0.5rem; background: var(--gray-50);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>{{ match.description|default:"(No description)" }}</strong>
                                        <span class="badge {% if match.score >= 80 %}badge-success{% elif match.score >= 60 %}badge-review{% else %}badge-danger{% endif %}" style="margin-left: 0.5rem;">
                                            {{ match.score }}% match
                                        </span>
                                    </div>
                                    <a href="{% url 'link_document_to_transaction' %}?document_id={{ document_id }}&firefly_id={{ match.firefly_id }}" 
                                       class="btn btn-sm btn-primary"
                                       onclick="return confirm('Link this document to this transaction? This will skip creating a new transaction.')">
                                        üîó Link
                                    </a>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">
                                    {{ match.amount }} ‚Ä¢ {{ match.date }} ‚Ä¢ {{ match.destination|default:"" }}
                                </div>
                                {% if match.reasons %}
                                <div style="font-size: 0.625rem; color: var(--gray-400); margin-top: 0.25rem;">
                                    Signals: {{ match.reasons|join:", " }}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- External ID (read-only) -->
                    <div class="form-section">
                        <div class="form-section-title">Identifiers</div>
                        <div class="form-group">
                            <label class="form-label">External ID</label>
                            <input type="text" 
                                   class="form-input" 
                                   value="{{ proposal.external_id }}"
                                   readonly>
                            <div class="form-help">Auto-generated. Changes if amount or date are modified.</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LLM Settings -->
            {% if llm_globally_enabled %}
            <div class="card mt-4">
                <div class="card-header">
                    <h2>ü§ñ AI Settings</h2>
                </div>
                <div class="card-body">
                    <div class="form-row" style="align-items: center; gap: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" 
                                       id="llm_opt_out_checkbox"
                                       {% if not llm_opt_out %}checked{% endif %}
                                       onchange="toggleLlmOptOut(this.checked)"
                                       style="width: 1.25rem; height: 1.25rem;">
                                <span>Use AI suggestions for this document</span>
                            </label>
                            <div class="form-help">
                                When enabled, AI will assist with category suggestions. Disable to rely only on rule-based extraction.
                            </div>
                        </div>
                        <div>
                            <button type="button" 
                                    class="btn btn-outline"
                                    onclick="rerunInterpretation()"
                                    title="Re-run AI interpretation for this document">
                                üîÑ Re-run Interpretation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="card mt-4">
                <div class="card-body">
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-lg btn-success" title="Save your edits and accept this transaction for import">
                            ‚úì Save & Accept
                        </button>
                        <button type="submit" formaction="{% url 'accept' record.id %}" formnovalidate class="btn btn-lg btn-primary" title="Accept the AI-extracted data without changes">
                            ‚úì Accept As-Is
                        </button>
                        <button type="submit" formaction="{% url 'reject' record.id %}" formnovalidate class="btn btn-lg btn-danger" title="Reject this document - it won't be imported">
                            ‚úï Reject
                        </button>
                        <button type="submit" formaction="{% url 'skip' record.id %}" formnovalidate class="btn btn-lg btn-secondary" title="Skip for now - review later">
                            Skip ‚Üí
                        </button>
                    </div>
                    <div class="action-buttons mt-3">
                        <a href="{% url 'reconciliation_list' %}?match_document={{ document_id }}" 
                           class="btn btn-lg btn-outline"
                           title="Link this document to an existing bank transaction instead of creating a new one">
                            üîó Link to Bank Transaction
                        </a>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Confidence Details -->
        <div class="card mt-4">
            <div class="card-header">
                <h2>Confidence Scores</h2>
                <span class="text-mono">{{ confidence.overall|floatformat:0 }}% overall</span>
            </div>
            <div class="card-body">
                <div class="confidence-bar" style="height: 0.75rem; margin-bottom: 1rem;">
                    <div class="confidence-bar-fill {% if confidence.overall >= 85 %}confidence-high{% elif confidence.overall >= 60 %}confidence-medium{% else %}confidence-low{% endif %}"
                         style="width: {{ confidence.overall }}%"></div>
                </div>
                <div class="confidence-detail">
                    <div class="confidence-item">
                        <div class="confidence-item-label">Amount</div>
                        <div class="confidence-item-value">{{ confidence.amount|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Date</div>
                        <div class="confidence-item-value">{{ confidence.date|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Currency</div>
                        <div class="confidence-item-value">{{ confidence.currency|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Vendor</div>
                        <div class="confidence-item-value">{{ confidence.vendor|floatformat:0 }}%</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Provenance -->
        <div class="card mt-4">
            <div class="card-header">
                <h2>Provenance</h2>
            </div>
            <div class="card-body">
                <dl class="provenance-info">
                    <dt>Source:</dt>
                    <dd>{{ provenance.source_system }}</dd>
                    
                    <dt>Strategy:</dt>
                    <dd>{{ provenance.extraction_strategy }}</dd>
                    
                    <dt>Parser:</dt>
                    <dd>v{{ provenance.parser_version }}</dd>
                    
                    <dt>Parsed:</dt>
                    <dd>{{ provenance.parsed_at }}</dd>
                </dl>
                
                {% if extraction.raw_text %}
                <details class="mt-4">
                    <summary style="cursor: pointer; font-size: 0.875rem; color: var(--gray-500);">
                        Show Raw OCR Text
                    </summary>
                    <div class="raw-text mt-2">{{ extraction.raw_text|truncatechars:2000 }}</div>
                </details>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Split transaction management
let lineItems = [];
let lineItemCounter = 0;

function toggleSplitMode(enabled) {
    const container = document.getElementById('split-container');
    container.style.display = enabled ? 'block' : 'none';
    
    if (enabled && lineItems.length === 0) {
        // Add first line item with the total amount
        addLineItem(parseFloat(document.getElementById('amount').value) || 0);
    }
    
    updateLineItemsJson();
}

function addLineItem(amount = 0, description = '', category = '') {
    const id = lineItemCounter++;
    lineItems.push({ id, amount, description, category });
    renderLineItems();
}

function removeLineItem(id) {
    lineItems = lineItems.filter(item => item.id !== id);
    if (lineItems.length === 0) {
        document.getElementById('enable_split').checked = false;
        toggleSplitMode(false);
    } else {
        renderLineItems();
    }
}

function updateLineItem(id, field, value) {
    const item = lineItems.find(item => item.id === id);
    if (item) {
        if (field === 'amount') {
            item.amount = parseFloat(value) || 0;
        } else {
            item[field] = value;
        }
    }
    updateSplitTotal();
    updateLineItemsJson();
}

function renderLineItems() {
    const container = document.getElementById('line-items-container');
    const categories = {{ firefly_categories_json|safe }};
    
    container.innerHTML = lineItems.map((item, idx) => `
        <div class="line-item-row" style="display: grid; grid-template-columns: 1fr 2fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border: 1px solid var(--gray-200); border-radius: 0.25rem;">
            <div>
                <input type="number" 
                       value="${item.amount}" 
                       step="0.01" 
                       class="form-input" 
                       placeholder="Amount"
                       onchange="updateLineItem(${item.id}, 'amount', this.value)"
                       style="font-size: 0.875rem;">
            </div>
            <div>
                <input type="text" 
                       value="${item.description}" 
                       class="form-input" 
                       placeholder="Description"
                       onchange="updateLineItem(${item.id}, 'description', this.value)"
                       style="font-size: 0.875rem;">
            </div>
            <div>
                <select class="form-input" 
                        onchange="updateLineItem(${item.id}, 'category', this.value)"
                        style="font-size: 0.875rem;">
                    <option value="">-- Category --</option>
                    ${categories.map(cat => `<option value="${cat.name}" ${cat.name === item.category ? 'selected' : ''}>${cat.name}</option>`).join('')}
                </select>
            </div>
            <button type="button" 
                    class="btn btn-sm btn-outline" 
                    onclick="removeLineItem(${item.id})"
                    style="color: #dc2626;"
                    ${lineItems.length <= 1 ? 'disabled' : ''}>
                ‚úï
            </button>
        </div>
    `).join('');
    
    updateSplitTotal();
    updateLineItemsJson();
}

function updateSplitTotal() {
    const total = lineItems.reduce((sum, item) => sum + (item.amount || 0), 0);
    const expected = parseFloat(document.getElementById('amount').value) || 0;
    const diff = Math.abs(total - expected);
    
    const totalEl = document.getElementById('split-total');
    if (diff < 0.01) {
        totalEl.innerHTML = `Total: ${total.toFixed(2)} ‚úì`;
        totalEl.style.color = 'var(--success)';
    } else {
        totalEl.innerHTML = `Total: ${total.toFixed(2)} (expected: ${expected.toFixed(2)}, diff: ${diff.toFixed(2)})`;
        totalEl.style.color = 'var(--danger)';
    }
}

function updateLineItemsJson() {
    const enabled = document.getElementById('enable_split').checked;
    const json = enabled && lineItems.length > 0 ? JSON.stringify(lineItems) : '';
    document.getElementById('line_items_json').value = json;
}

// Update split total when main amount changes
document.getElementById('amount').addEventListener('change', updateSplitTotal);

// LLM opt-out toggle
function toggleLlmOptOut(enableAi) {
    const optOut = !enableAi;
    fetch('{% url "toggle_llm_opt_out" record.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ opt_out: optOut })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show brief feedback
            const checkbox = document.getElementById('llm_opt_out_checkbox');
            const originalLabel = checkbox.nextElementSibling.textContent;
            checkbox.nextElementSibling.textContent = data.message;
            setTimeout(() => {
                checkbox.nextElementSibling.textContent = originalLabel;
            }, 2000);
        } else {
            alert('Failed to update setting: ' + data.error);
            // Revert checkbox state
            document.getElementById('llm_opt_out_checkbox').checked = enableAi;
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
        document.getElementById('llm_opt_out_checkbox').checked = enableAi;
    });
}

// Re-run interpretation
function rerunInterpretation() {
    {% if not llm_globally_enabled %}
    alert('AI/Ollama is not enabled. Please enable it in Settings to use this feature.');
    return;
    {% endif %}
    
    if (!confirm('Re-run AI interpretation for this document? This will refresh the page with updated suggestions.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '‚è≥ Processing...';
    btn.disabled = true;
    
    fetch('{% url "rerun_interpretation" record.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        // Check Content-Type before parsing as JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Please try again.');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Reload to show updated suggestions
            window.location.reload();
        } else {
            alert('Failed to re-run interpretation: ' + (data.error || 'Unknown error'));
            btn.textContent = originalText;
            btn.disabled = false;
        }
    })
    .catch(error => {
        alert('Network error: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

// Toggle document viewer visibility (for small screens)
function toggleDocumentViewer() {
    const viewer = document.getElementById('document-viewer');
    viewer.classList.toggle('collapsed');
    const btn = document.querySelector('.viewer-toggle');
    if (viewer.classList.contains('collapsed')) {
        btn.textContent = 'üìÑ Show Preview';
    } else {
        btn.textContent = 'üìÑ Hide Preview';
    }
}

// Form validation with field highlighting
document.querySelector('form').addEventListener('submit', function(e) {
    // Only validate for Save & Accept (not for reject/skip which use formnovalidate)
    if (e.submitter && (e.submitter.getAttribute('formnovalidate') !== null)) {
        return true;
    }
    
    // Clear previous error states
    document.querySelectorAll('.form-input.field-error').forEach(el => {
        el.classList.remove('field-error');
    });
    document.querySelectorAll('.form-group.has-error').forEach(el => {
        el.classList.remove('has-error');
    });
    
    // Check required fields
    const requiredFields = document.querySelectorAll('[required]');
    let firstInvalid = null;
    
    requiredFields.forEach(field => {
        if (!field.value || field.value.trim() === '') {
            field.classList.add('field-error');
            field.closest('.form-group')?.classList.add('has-error');
            if (!firstInvalid) firstInvalid = field;
        }
    });
    
    if (firstInvalid) {
        e.preventDefault();
        firstInvalid.focus();
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});
</script>
{% endblock %}
