{% extends "review/base.html" %}

{% block title %}Settings - SparkLink{% endblock %}

{% block extra_css %}
<style>
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        max-width: 800px;
    }
    
    .settings-section {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .settings-section-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-weight: 500;
    }
    
    .status-indicator.connected {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-indicator.disconnected {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-indicator.unknown {
        background: var(--gray-100);
        color: var(--gray-600);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    @media (max-width: 640px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
    }
    
    .form-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-help {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }
    
    .form-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }
    
    .token-input-wrapper {
        position: relative;
    }
    
    .token-input-wrapper input {
        padding-right: 3rem;
    }
    
    .toggle-visibility {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: var(--gray-500);
    }
    
    .account-list {
        margin-top: 0.5rem;
        padding: 0.75rem;
        background: var(--gray-50);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .account-item {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
    }
</style>
{% endblock %}

{% block content %}
<h1>‚öôÔ∏è Settings</h1>

<form method="post">
    {% csrf_token %}
    
    <div class="settings-grid">
        <!-- Paperless Settings -->
        <div class="settings-section">
            <div class="settings-section-title">
                üìÑ Paperless-ngx
                {% if paperless_status == 'connected' %}
                <span class="status-indicator connected">‚óè Connected</span>
                {% elif paperless_status %}
                <span class="status-indicator disconnected">‚óè {{ paperless_status }}</span>
                {% else %}
                <span class="status-indicator unknown">‚óè Not configured</span>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="paperless_token">API Token</label>
                <div class="token-input-wrapper">
                    <input type="password" 
                           name="paperless_token" 
                           id="paperless_token"
                           class="form-input"
                           value="{{ profile.paperless_token }}"
                           placeholder="Leave empty to use default">
                    <button type="button" class="toggle-visibility" onclick="toggleVisibility('paperless_token')">üëÅ</button>
                </div>
                <div class="form-help">Personal token from Paperless-ngx settings</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="paperless_url">Custom URL (optional)</label>
                <input type="url" 
                       name="paperless_url" 
                       id="paperless_url"
                       class="form-input"
                       value="{{ profile.paperless_url }}"
                       placeholder="Leave empty to use default">
                <div class="form-help">Only set if using different Paperless instance</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="paperless_filter_tags">Document Filter Tags</label>
                <input type="text" 
                       name="paperless_filter_tags" 
                       id="paperless_filter_tags"
                       class="form-input"
                       value="{{ profile.paperless_filter_tags|default:'finance/inbox' }}"
                       placeholder="e.g., finance/inbox, receipts">
                <div class="form-help">
                    Comma-separated list of tags to filter documents during extraction. 
                    Only documents with these tags will be processed. 
                    Default: <code>finance/inbox</code>
                </div>
            </div>
        </div>
        
        <!-- Firefly Settings -->
        <div class="settings-section">
            <div class="settings-section-title">
                üí∞ Firefly III
                {% if firefly_status == 'connected' %}
                <span class="status-indicator connected">‚óè Connected</span>
                {% elif firefly_status %}
                <span class="status-indicator disconnected">‚óè {{ firefly_status }}</span>
                {% else %}
                <span class="status-indicator unknown">‚óè Not configured</span>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="firefly_token">API Token</label>
                <div class="token-input-wrapper">
                    <input type="password" 
                           name="firefly_token" 
                           id="firefly_token"
                           class="form-input"
                           value="{{ profile.firefly_token }}"
                           placeholder="Leave empty to use default">
                    <button type="button" class="toggle-visibility" onclick="toggleVisibility('firefly_token')">üëÅ</button>
                </div>
                <div class="form-help">Personal access token from Firefly III profile</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="firefly_url">Custom URL (optional)</label>
                <input type="url" 
                       name="firefly_url" 
                       id="firefly_url"
                       class="form-input"
                       value="{{ profile.firefly_url }}"
                       placeholder="Leave empty to use default">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="default_source_account">Default Source Account</label>
                <select name="default_source_account" id="default_source_account" class="form-input">
                    <option value="{{ profile.default_source_account }}">{{ profile.default_source_account }}</option>
                    {% for account in firefly_accounts %}
                    {% if account.name != profile.default_source_account %}
                    <option value="{{ account.name }}">{{ account.name }} ({{ account.currency_code }})</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <div class="form-help">Bank account to use as default source for transactions</div>
            </div>
            
            {% if firefly_accounts %}
            <div class="account-list">
                <strong>Available Accounts:</strong>
                {% for account in firefly_accounts %}
                <div class="account-item">
                    <span>{{ account.name }}</span>
                    <span>{{ account.currency_code }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if firefly_categories %}
            <div class="account-list" style="margin-top: 1rem;">
                <strong>Available Categories:</strong>
                {% for category in firefly_categories %}
                <div class="account-item">
                    <span>{{ category.name }}</span>
                    {% if category.notes %}
                    <span title="{{ category.notes }}" style="color: var(--gray-400); cursor: help;">‚ÑπÔ∏è</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Processing Settings -->
        <div class="settings-section">
            <div class="settings-section-title">‚ö° Processing</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="auto_import_threshold">Auto-Import Threshold</label>
                    <input type="number" 
                           name="auto_import_threshold" 
                           id="auto_import_threshold"
                           class="form-input"
                           value="{{ profile.auto_import_threshold }}"
                           min="0" max="1" step="0.05">
                    <div class="form-help">Confidence above this = auto-import (0.0 - 1.0)</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="review_threshold">Review Threshold</label>
                    <input type="number" 
                           name="review_threshold" 
                           id="review_threshold"
                           class="form-input"
                           value="{{ profile.review_threshold }}"
                           min="0" max="1" step="0.05">
                    <div class="form-help">Confidence above this = needs review</div>
                </div>
            </div>
        </div>
        
        <!-- External Links (Quick Access) -->
        <div class="settings-section">
            <div class="settings-section-title">üîó External Links</div>
            <div class="form-help" style="margin-bottom: 1rem;">
                Optional: Add links to related services for quick access from the header menu.
            </div>
            
            <div class="form-group">
                <label class="form-label" for="syncthing_url">Syncthing URL</label>
                <input type="url" 
                       name="syncthing_url" 
                       id="syncthing_url"
                       class="form-input"
                       value="{{ profile.syncthing_url }}"
                       placeholder="e.g., http://localhost:8384">
                <div class="form-help">URL to Syncthing web UI for document syncing</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="importer_url">Firefly Data Importer URL</label>
                <input type="url" 
                       name="importer_url" 
                       id="importer_url"
                       class="form-input"
                       value="{{ profile.importer_url }}"
                       placeholder="e.g., http://localhost:8081">
                <div class="form-help">URL to Firefly Data Importer for bank statement imports</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="firefly_importer_token">Firefly Data Importer API Token (optional)</label>
                <div class="token-input-wrapper">
                    <input type="password" 
                           name="firefly_importer_token" 
                           id="firefly_importer_token"
                           class="form-input"
                           value="{{ profile.firefly_importer_token }}"
                           placeholder="Leave empty if same as Firefly III token">
                    <button type="button" class="toggle-visibility" onclick="toggleVisibility('firefly_importer_token')">üëÅ</button>
                </div>
                <div class="form-help">Separate API token for Firefly Data Importer (if different from Firefly III token)</div>
            </div>
        </div>
        
        <!-- LLM / Ollama Settings -->
        <div class="settings-section">
            <div class="settings-section-title">
                ü§ñ AI Assistant (Ollama)
                {% if llm_status == 'connected' %}
                <span class="status-indicator connected">‚óè Connected</span>
                {% elif llm_status %}
                <span class="status-indicator disconnected">‚óè {{ llm_status }}</span>
                {% else %}
                <span class="status-indicator unknown">‚óè Disabled</span>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" 
                           name="llm_enabled" 
                           id="llm_enabled"
                           {% if profile.llm_enabled %}checked{% endif %}
                           onchange="toggleLLMSettings()">
                    Enable AI-assisted categorization & chatbot
                </label>
                <div class="form-help">Uses local Ollama LLM for category suggestions and document Q&A</div>
            </div>
            
            <div id="llm-settings" style="{% if not profile.llm_enabled %}opacity: 0.5; pointer-events: none;{% endif %}">
                <div class="form-group">
                    <label class="form-label" for="ollama_url">Ollama Server URL</label>
                    <input type="url" 
                           name="ollama_url" 
                           id="ollama_url"
                           class="form-input"
                           value="{{ profile.ollama_url }}"
                           placeholder="{{ default_ollama_url }}">
                    <div class="form-help">
                        Leave empty to use default: <code>{{ default_ollama_url }}</code><br>
                        For Docker, use <code>host.docker.internal:11434</code> or the host IP
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="ollama_model">Primary Model</label>
                        <input type="text" 
                               name="ollama_model" 
                               id="ollama_model"
                               class="form-input"
                               list="model-list"
                               value="{{ profile.ollama_model }}"
                               placeholder="{{ default_ollama_model }}">
                        <div class="form-help">Fast model for most requests</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="ollama_model_fallback">Fallback Model</label>
                        <input type="text" 
                               name="ollama_model_fallback" 
                               id="ollama_model_fallback"
                               class="form-input"
                               list="model-list"
                               value="{{ profile.ollama_model_fallback }}"
                               placeholder="{{ default_ollama_model_fallback }}">
                        <div class="form-help">Larger model for complex cases</div>
                    </div>
                </div>
                
                <datalist id="model-list">
                    {% for model in available_models %}
                    <option value="{{ model }}">
                    {% endfor %}
                </datalist>
                
                <div class="form-group">
                    <label class="form-label" for="ollama_timeout">Request Timeout (seconds)</label>
                    <input type="number" 
                           name="ollama_timeout" 
                           id="ollama_timeout"
                           class="form-input"
                           value="{{ profile.ollama_timeout|default:30 }}"
                           min="5" max="300" step="5"
                           style="max-width: 150px;">
                    <div class="form-help">How long to wait for LLM response (default: 30s, max: 300s)</div>
                </div>
                
                {% if available_models %}
                <div class="account-list">
                    <strong>Available Models on Server:</strong>
                    {% for model in available_models %}
                    <div class="account-item">
                        <span>{{ model }}</span>
                        <button type="button" class="btn btn-xs btn-outline" onclick="document.getElementById('ollama_model').value='{{ model }}'">Use as Primary</button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- AI Schedule Settings - integrated into AI Assistant section -->
                <div class="settings-subsection" id="ai-schedule" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-200);">
                    <div style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        üìÖ Background Processing Schedule
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label toggle-label">
                            <input type="checkbox" 
                                   name="ai_schedule_enabled" 
                                   id="ai_schedule_enabled"
                                   {% if profile.ai_schedule_enabled %}checked{% endif %}
                                   onchange="toggleScheduleSettings()">
                            <span class="toggle-text">Enable Automatic AI Processing</span>
                        </label>
                        <div class="form-help">Automatically process AI jobs for new document extractions in the background</div>
                    </div>
                    
                    <div id="schedule-settings" style="{% if not profile.ai_schedule_enabled %}opacity: 0.5; pointer-events: none;{% endif %}">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label" for="ai_schedule_interval_minutes">Interval (min)</label>
                                <input type="number" 
                                       name="ai_schedule_interval_minutes" 
                                       id="ai_schedule_interval_minutes"
                                       class="form-input"
                                       value="{{ profile.ai_schedule_interval_minutes|default:60 }}"
                                       min="1" max="1440"
                                       style="max-width: 100px;">
                                <div class="form-help">Processing interval</div>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label" for="ai_schedule_batch_size">Batch Size</label>
                                <input type="number" 
                                       name="ai_schedule_batch_size" 
                                       id="ai_schedule_batch_size"
                                       class="form-input"
                                       value="{{ profile.ai_schedule_batch_size|default:1 }}"
                                       min="1" max="10"
                                       style="max-width: 80px;">
                                <div class="form-help">Jobs per run</div>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label" for="ai_schedule_max_retries">Max Retries</label>
                                <input type="number" 
                                       name="ai_schedule_max_retries" 
                                       id="ai_schedule_max_retries"
                                       class="form-input"
                                       value="{{ profile.ai_schedule_max_retries|default:3 }}"
                                       min="0" max="10"
                                       style="max-width: 80px;">
                                <div class="form-help">Retry attempts</div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label" for="ai_schedule_start_hour">Start Hour</label>
                                <input type="number" 
                                       name="ai_schedule_start_hour" 
                                       id="ai_schedule_start_hour"
                                       class="form-input"
                                       value="{{ profile.ai_schedule_start_hour|default:0 }}"
                                       min="0" max="23"
                                       style="max-width: 80px;">
                                <div class="form-help">0-23 hours</div>
                            </div>
                            
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label" for="ai_schedule_end_hour">End Hour</label>
                                <input type="number" 
                                       name="ai_schedule_end_hour" 
                                       id="ai_schedule_end_hour"
                                       class="form-input"
                                       value="{{ profile.ai_schedule_end_hour|default:24 }}"
                                       min="1" max="24"
                                       style="max-width: 80px;">
                                <div class="form-help">1-24 hours</div>
                            </div>
                        </div>
                        
                        <!-- Queue Status -->
                        <div class="queue-status-box" style="margin-top: 1rem; padding: 0.75rem 1rem; background: var(--gray-50); border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div style="display: flex; gap: 1rem; font-size: 0.8125rem; flex-wrap: wrap;">
                                <span><strong style="color: var(--gray-600);">{{ ai_queue_stats.pending }}</strong> pending</span>
                                <span><strong style="color: var(--blue-600);">{{ ai_queue_stats.processing }}</strong> processing</span>
                                <span><strong style="color: var(--green-600);">{{ ai_queue_stats.completed }}</strong> completed</span>
                                <span><strong style="color: var(--red-600);">{{ ai_queue_stats.failed }}</strong> failed</span>
                            </div>
                            <a href="{% url 'ai_queue_list' %}" class="btn btn-xs btn-outline">
                                View Queue ‚Üí
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Settings</button>
        <a href="{% url 'home' %}" class="btn btn-outline">Cancel</a>
    </div>
</form>

<script>
function toggleVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

function toggleLLMSettings() {
    const checkbox = document.getElementById('llm_enabled');
    const settings = document.getElementById('llm-settings');
    if (checkbox.checked) {
        settings.style.opacity = '1';
        settings.style.pointerEvents = 'auto';
    } else {
        settings.style.opacity = '0.5';
        settings.style.pointerEvents = 'none';
    }
}

function toggleScheduleSettings() {
    const checkbox = document.getElementById('ai_schedule_enabled');
    const settings = document.getElementById('schedule-settings');
    if (checkbox.checked) {
        settings.style.opacity = '1';
        settings.style.pointerEvents = 'auto';
    } else {
        settings.style.opacity = '0.5';
        settings.style.pointerEvents = 'none';
    }
}
</script>
{% endblock %}
