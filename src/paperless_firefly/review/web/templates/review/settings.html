{% extends "review/base.html" %}

{% block title %}Settings - SparkLink{% endblock %}

{% block extra_css %}
<style>
    .settings-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        max-width: 800px;
    }
    
    .settings-section {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .settings-section-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-weight: 500;
    }
    
    .status-indicator.connected {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-indicator.disconnected {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-indicator.unknown {
        background: var(--gray-100);
        color: var(--gray-600);
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    @media (max-width: 640px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
    }
    
    .form-input {
        width: 100%;
        padding: 0.625rem 0.875rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-help {
        font-size: 0.75rem;
        color: var(--gray-500);
        margin-top: 0.25rem;
    }
    
    .form-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }
    
    .token-input-wrapper {
        position: relative;
    }
    
    .token-input-wrapper input {
        padding-right: 3rem;
    }
    
    .toggle-visibility {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: var(--gray-500);
    }
    
    .account-list {
        margin-top: 0.5rem;
        padding: 0.75rem;
        background: var(--gray-50);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .account-item {
        display: flex;
        justify-content: space-between;
        padding: 0.25rem 0;
    }
</style>
{% endblock %}

{% block content %}
<h1>‚öôÔ∏è Settings</h1>

<form method="post">
    {% csrf_token %}
    
    <div class="settings-grid">
        <!-- Paperless Settings -->
        <div class="settings-section">
            <div class="settings-section-title">
                üìÑ Paperless-ngx
                {% if paperless_status == 'connected' %}
                <span class="status-indicator connected">‚óè Connected</span>
                {% elif paperless_status %}
                <span class="status-indicator disconnected">‚óè {{ paperless_status }}</span>
                {% else %}
                <span class="status-indicator unknown">‚óè Not configured</span>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="paperless_token">API Token</label>
                <div class="token-input-wrapper">
                    <input type="password" 
                           name="paperless_token" 
                           id="paperless_token"
                           class="form-input"
                           value="{{ profile.paperless_token }}"
                           placeholder="Leave empty to use default">
                    <button type="button" class="toggle-visibility" onclick="toggleVisibility('paperless_token')">üëÅ</button>
                </div>
                <div class="form-help">Personal token from Paperless-ngx settings</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="paperless_url">Custom URL (optional)</label>
                <input type="url" 
                       name="paperless_url" 
                       id="paperless_url"
                       class="form-input"
                       value="{{ profile.paperless_url }}"
                       placeholder="Leave empty to use default">
                <div class="form-help">Only set if using different Paperless instance</div>
            </div>
        </div>
        
        <!-- Firefly Settings -->
        <div class="settings-section">
            <div class="settings-section-title">
                üí∞ Firefly III
                {% if firefly_status == 'connected' %}
                <span class="status-indicator connected">‚óè Connected</span>
                {% elif firefly_status %}
                <span class="status-indicator disconnected">‚óè {{ firefly_status }}</span>
                {% else %}
                <span class="status-indicator unknown">‚óè Not configured</span>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label class="form-label" for="firefly_token">API Token</label>
                <div class="token-input-wrapper">
                    <input type="password" 
                           name="firefly_token" 
                           id="firefly_token"
                           class="form-input"
                           value="{{ profile.firefly_token }}"
                           placeholder="Leave empty to use default">
                    <button type="button" class="toggle-visibility" onclick="toggleVisibility('firefly_token')">üëÅ</button>
                </div>
                <div class="form-help">Personal access token from Firefly III profile</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="firefly_url">Custom URL (optional)</label>
                <input type="url" 
                       name="firefly_url" 
                       id="firefly_url"
                       class="form-input"
                       value="{{ profile.firefly_url }}"
                       placeholder="Leave empty to use default">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="default_source_account">Default Source Account</label>
                <select name="default_source_account" id="default_source_account" class="form-input">
                    <option value="{{ profile.default_source_account }}">{{ profile.default_source_account }}</option>
                    {% for account in firefly_accounts %}
                    {% if account.name != profile.default_source_account %}
                    <option value="{{ account.name }}">{{ account.name }} ({{ account.currency_code }})</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <div class="form-help">Bank account to use as default source for transactions</div>
            </div>
            
            {% if firefly_accounts %}
            <div class="account-list">
                <strong>Available Accounts:</strong>
                {% for account in firefly_accounts %}
                <div class="account-item">
                    <span>{{ account.name }}</span>
                    <span>{{ account.currency_code }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Processing Settings -->
        <div class="settings-section">
            <div class="settings-section-title">‚ö° Processing</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="auto_import_threshold">Auto-Import Threshold</label>
                    <input type="number" 
                           name="auto_import_threshold" 
                           id="auto_import_threshold"
                           class="form-input"
                           value="{{ profile.auto_import_threshold }}"
                           min="0" max="1" step="0.05">
                    <div class="form-help">Confidence above this = auto-import (0.0 - 1.0)</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="review_threshold">Review Threshold</label>
                    <input type="number" 
                           name="review_threshold" 
                           id="review_threshold"
                           class="form-input"
                           value="{{ profile.review_threshold }}"
                           min="0" max="1" step="0.05">
                    <div class="form-help">Confidence above this = needs review</div>
                </div>
            </div>
        </div>
        
        <!-- External Links (Quick Access) -->
        <div class="settings-section">
            <div class="settings-section-title">üîó External Links</div>
            <div class="form-help" style="margin-bottom: 1rem;">
                Optional: Add links to related services for quick access from the header menu.
            </div>
            
            <div class="form-group">
                <label class="form-label" for="syncthing_url">Syncthing URL</label>
                <input type="url" 
                       name="syncthing_url" 
                       id="syncthing_url"
                       class="form-input"
                       value="{{ profile.syncthing_url }}"
                       placeholder="e.g., http://localhost:8384">
                <div class="form-help">URL to Syncthing web UI for document syncing</div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="importer_url">Firefly Importer URL</label>
                <input type="url" 
                       name="importer_url" 
                       id="importer_url"
                       class="form-input"
                       value="{{ profile.importer_url }}"
                       placeholder="e.g., http://localhost:8081">
                <div class="form-help">URL to Firefly Importer for bank statement imports</div>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Settings</button>
        <a href="{% url 'home' %}" class="btn btn-outline">Cancel</a>
    </div>
</form>

<script>
function toggleVisibility(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}
</script>
{% endblock %}
