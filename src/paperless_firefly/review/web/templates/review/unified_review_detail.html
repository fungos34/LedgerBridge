{% extends "review/base.html" %}

{% block title %}Review: {{ record.title|truncatechars:40 }} - SparkLink{% endblock %}
{% block pending_count %}{{ pending_count }}{% endblock %}

{% block extra_css %}
<style>
    .review-layout {
        display: grid;
        grid-template-columns: 1fr 1fr 400px;
        gap: 1.5rem;
        align-items: start;
    }
    
    @media (max-width: 1400px) {
        .review-layout {
            grid-template-columns: 1fr 400px;
        }
        .document-viewer {
            display: none;
        }
    }
    
    @media (max-width: 1024px) {
        .review-layout {
            grid-template-columns: 1fr;
        }
    }
    
    .nav-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .record-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .record-type-badge.paperless {
        background: #f3e8ff;
        color: #7c3aed;
    }
    
    .record-type-badge.firefly {
        background: #dcfce7;
        color: #059669;
    }
    
    .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .form-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        margin-bottom: 1rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    
    /* Document Viewer */
    .document-viewer {
        position: sticky;
        top: 1rem;
        height: calc(100vh - 8rem);
        min-height: 500px;
    }
    
    .document-viewer.collapsed {
        height: 60px;
        min-height: 60px;
        overflow: hidden;
    }
    
    .document-viewer.collapsed .card-body {
        display: none;
    }
    
    .document-viewer iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0.375rem;
    }
    
    .viewer-toggle {
        background: var(--gray-100);
        border: 1px solid var(--gray-300);
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        display: inline-block;
    }
    
    .viewer-toggle:hover {
        background: var(--gray-200);
    }
    
    .document-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 2rem;
        text-align: center;
        color: var(--gray-500);
        background: var(--gray-50);
        border-radius: 0.375rem;
    }
    
    .document-error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .document-error-title {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }
    
    .document-error-message {
        font-size: 0.875rem;
    }
    
    /* Confidence Details */
    .confidence-detail {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .confidence-item {
        text-align: center;
        padding: 0.5rem;
        background: var(--gray-50);
        border-radius: 0.25rem;
    }
    
    .confidence-item-label {
        font-size: 0.625rem;
        text-transform: uppercase;
        color: var(--gray-500);
    }
    
    .confidence-item-value {
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    /* Required field indicator */
    .required-star {
        color: #dc2626;
        font-weight: bold;
    }
    
    /* Field validation error */
    .form-input.field-error,
    .form-input:invalid:not(:focus) {
        border-color: #dc2626;
        box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.1);
    }
    
    /* Provenance */
    .provenance-info {
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    .provenance-info dt {
        font-weight: 500;
        display: inline;
    }
    
    .provenance-info dd {
        display: inline;
        margin: 0;
        margin-right: 1rem;
    }
    
    .raw-text {
        max-height: 200px;
        overflow-y: auto;
        background: var(--gray-50);
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-family: monospace;
        font-size: 0.75rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    /* Link Section */
    .link-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
    }
    
    .link-header {
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
    }
    
    .link-header h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .link-header p {
        font-size: 0.75rem;
        opacity: 0.9;
    }
    
    .link-status {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .link-status.pending {
        background: #fef3c7;
        border-left: 3px solid #d97706;
    }
    
    .link-status.linked {
        background: #dcfce7;
        border-left: 3px solid #059669;
    }
    
    .link-status.orphan {
        background: #fee2e2;
        border-left: 3px solid #dc2626;
    }
    
    .link-status-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .link-status-desc {
        font-size: 0.75rem;
        color: var(--gray-600);
    }
    
    /* Suggestions */
    .suggestions-section {
        padding: 1rem 1.25rem;
    }
    
    .suggestions-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 0.75rem;
    }
    
    .suggestion-item {
        padding: 0.75rem;
        background: var(--gray-50);
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.15s;
        border: 2px solid transparent;
    }
    
    .suggestion-item:hover {
        background: #dbeafe;
        border-color: #93c5fd;
    }
    
    .suggestion-item.selected {
        background: #dbeafe;
        border-color: var(--primary);
    }
    
    .suggestion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .suggestion-score {
        background: var(--primary);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 600;
    }
    
    .suggestion-title {
        font-weight: 600;
        font-size: 0.875rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .suggestion-meta {
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    .suggestion-actions {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }
    
    /* Orphan Section */
    .orphan-section {
        padding: 1rem 1.25rem;
        background: #fef3c7;
        border-top: 1px dashed #d97706;
    }
    
    .orphan-section h4 {
        font-size: 0.875rem;
        color: #92400e;
        margin-bottom: 0.5rem;
    }
    
    .orphan-section p {
        font-size: 0.75rem;
        color: #92400e;
        margin-bottom: 0.75rem;
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        padding: 1rem;
        background: var(--gray-50);
        border-top: 1px solid var(--gray-200);
    }
    
    /* Linked Record Info */
    .linked-record-info {
        padding: 1rem 1.25rem;
        background: #f0fdf4;
        border-top: 1px solid #86efac;
    }
    
    .linked-record-info h4 {
        font-size: 0.75rem;
        color: #166534;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }
    
    .linked-record-details {
        font-size: 0.875rem;
    }
    
    /* Confidence Badge */
    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 600;
    }
    
    .confidence-high { background: #dcfce7; color: #166534; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }
    
    /* AI Badge */
    .badge-ai {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: linear-gradient(135deg, #818cf8, #6366f1);
        color: white;
        font-size: 0.625rem;
        font-weight: 600;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation -->
<div class="nav-buttons">
    <div class="flex gap-2 items-center">
        <a href="{% url 'unified_review_list' %}" class="btn btn-outline">‚Üê Back to List</a>
        {% if prev_id %}
        <a href="{% url 'unified_review_detail' record_type prev_id %}" class="btn btn-outline">‚Üê Previous</a>
        {% endif %}
        <span class="record-type-badge {{ record_type }}">
            {% if record_type == 'paperless' %}üìÑ Paperless{% else %}üè¶ Firefly{% endif %}
        </span>
    </div>
    <span class="position text-muted text-sm">{{ current_position }} of {{ pending_count }}</span>
    <div class="flex gap-2 items-center">
        {% if next_id %}
        <a href="{% url 'unified_review_detail' record_type next_id %}" class="btn btn-outline">Next ‚Üí</a>
        {% endif %}
        <span class="confidence-badge {% if record.confidence >= 80 %}confidence-high{% elif record.confidence >= 50 %}confidence-medium{% else %}confidence-low{% endif %}">
            {{ record.confidence|floatformat:0 }}% confidence
        </span>
    </div>
</div>

<div class="review-layout">
    {% if record_type == 'paperless' %}
    <!-- Document Viewer (Paperless only) -->
    <div class="card document-viewer" id="document-viewer">
        <div class="card-header">
            <h2>üìÑ Document Preview</h2>
            <div class="flex gap-2">
                <button type="button" class="viewer-toggle" onclick="toggleDocumentViewer()" title="Toggle document preview" id="viewer-toggle-btn">
                    ‚ñº Hide
                </button>
                <a href="{% url 'document' record.id %}?download=1" class="btn btn-sm btn-outline" download>
                    ‚¨á Download
                </a>
                <a href="{{ paperless_url }}/documents/{{ record.id }}/" target="_blank" class="btn btn-sm btn-outline">
                    Open in Paperless ‚Üó
                </a>
            </div>
        </div>
        <div class="card-body" style="height: calc(100% - 60px); padding: 0;" id="document-body">
            <div class="document-error" id="document-error" style="display: none;">
                <div class="document-error-icon">üìÑ‚ùå</div>
                <div class="document-error-title">Document Not Available</div>
                <div class="document-error-message">
                    The document may have been removed from Paperless or is temporarily unavailable.
                    <br><br>
                    <a href="{{ paperless_url }}/documents/{{ record.id }}/" target="_blank" class="btn btn-sm btn-primary">
                        Check in Paperless ‚Üó
                    </a>
                </div>
            </div>
            <iframe src="{% url 'document' record.id %}" 
                    title="Document Preview"
                    id="document-iframe"
                    onload="handleIframeLoad()"
                    onerror="handleIframeError()"
                    style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    {% endif %}
    
    <!-- Main Form -->
    <div>
        <form method="post" action="{% if record_type == 'paperless' %}{% url 'save' record.extraction_id %}{% endif %}" id="review-form">
            {% csrf_token %}
            <div class="card">
                <div class="card-header">
                    <h2>{{ record.title|truncatechars:50 }}</h2>
                </div>
                <div class="card-body">
                    <!-- Amount & Currency -->
                    <div class="form-section">
                        <div class="form-section-title">Amount</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="amount">Amount <span class="required-star">*</span></label>
                                <input type="number" 
                                       id="amount" 
                                       name="amount" 
                                       class="form-input" 
                                       value="{{ record.amount }}"
                                       step="0.01"
                                       {% if record_type == 'firefly' %}readonly{% endif %}
                                       required>
                                {% if confidence.amount %}
                                <div class="form-help">Confidence: {{ confidence.amount|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="currency">Currency <span class="required-star">*</span></label>
                                <input type="text" 
                                       id="currency" 
                                       name="currency" 
                                       class="form-input" 
                                       value="{{ record.currency }}"
                                       maxlength="3"
                                       style="text-transform: uppercase;"
                                       {% if record_type == 'firefly' %}readonly{% endif %}
                                       required>
                                {% if confidence.currency %}
                                <div class="form-help">Confidence: {{ confidence.currency|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date -->
                    <div class="form-section">
                        <div class="form-section-title">Date</div>
                        <div class="form-group">
                            <label class="form-label" for="date">Transaction Date <span class="required-star">*</span></label>
                            <input type="date" 
                                   id="date" 
                                   name="date" 
                                   class="form-input" 
                                   value="{{ record.date }}"
                                   {% if record_type == 'firefly' %}readonly{% endif %}
                                   required>
                            {% if confidence.date %}
                            <div class="form-help">Confidence: {{ confidence.date|floatformat:0 }}%</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="form-section">
                        <div class="form-section-title">Description</div>
                        <div class="form-group">
                            <label class="form-label" for="description">Description <span class="required-star">*</span></label>
                            <input type="text" 
                                   id="description" 
                                   name="description" 
                                   class="form-input" 
                                   value="{{ record.description }}"
                                   {% if record_type == 'firefly' %}readonly{% endif %}
                                   required>
                            {% if confidence.description %}
                            <div class="form-help">Confidence: {{ confidence.description|floatformat:0 }}%</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Accounts -->
                    <div class="form-section">
                        <div class="form-section-title">Accounts</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="source_account">Source Account <span class="required-star">*</span></label>
                                {% if record_type == 'paperless' %}
                                <select id="source_account" name="source_account" class="form-input" required>
                                    <option value="">-- Select Source Account --</option>
                                    {% for account in firefly_accounts %}
                                    <option value="{{ account.name }}" {% if account.name == record.source_account %}selected{% endif %}>
                                        {{ account.name }} ({{ account.currency_code }})
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if not firefly_accounts %}
                                <div class="form-help" style="color: #dc2626;">‚ö†Ô∏è Could not load Firefly accounts. Check your API settings.</div>
                                {% else %}
                                <div class="form-help">The bank account to debit (required for transactions)</div>
                                {% endif %}
                                {% else %}
                                <input type="text" class="form-input" value="{{ record.source_account }}" readonly>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="destination_account">Destination / Vendor</label>
                                <input type="text" 
                                       id="destination_account" 
                                       name="destination_account" 
                                       class="form-input" 
                                       value="{{ record.vendor|default:record.destination_account|default:'' }}"
                                       placeholder="e.g., Supermarket"
                                       {% if record_type == 'firefly' %}readonly{% endif %}>
                                {% if confidence.vendor %}
                                <div class="form-help">Confidence: {{ confidence.vendor|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category -->
                    <div class="form-section">
                        <div class="form-section-title">
                            Category
                            {% if llm_suggestion %}
                            <span class="badge-ai" title="AI suggested: {{ llm_suggestion.category }}">ü§ñ AI</span>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="category">Category</label>
                            {% if record_type == 'paperless' %}
                            <select id="category" name="category" class="form-input">
                                <option value="">-- Select Category --</option>
                                {% for cat in firefly_categories %}
                                <option value="{{ cat.name }}" {% if cat.name == record.category %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if llm_suggestion %}
                            <div class="form-help">
                                AI suggested: <strong>{{ llm_suggestion.category }}</strong>
                                <button type="button" class="btn btn-xs btn-outline" 
                                        onclick="document.getElementById('category').value='{{ llm_suggestion.category }}'">
                                    Use suggestion
                                </button>
                            </div>
                            {% endif %}
                            {% else %}
                            <input type="text" class="form-input" value="{{ record.category }}" readonly>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if record_type == 'paperless' %}
                    <!-- Transaction Type -->
                    <div class="form-section">
                        <div class="form-section-title">Transaction Type</div>
                        <div class="form-group">
                            <select id="transaction_type" name="transaction_type" class="form-input" required>
                                <option value="withdrawal" {% if record.transaction_type == 'withdrawal' or record.transaction_type == 'WITHDRAWAL' %}selected{% endif %}>Withdrawal (Expense)</option>
                                <option value="deposit" {% if record.transaction_type == 'deposit' or record.transaction_type == 'DEPOSIT' %}selected{% endif %}>Deposit (Income)</option>
                                <option value="transfer" {% if record.transaction_type == 'transfer' or record.transaction_type == 'TRANSFER' %}selected{% endif %}>Transfer</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Invoice Number -->
                    <div class="form-section">
                        <div class="form-section-title">Reference</div>
                        <div class="form-group">
                            <label class="form-label" for="invoice_number">Invoice / Receipt Number</label>
                            <input type="text" 
                                   id="invoice_number" 
                                   name="invoice_number" 
                                   class="form-input" 
                                   value="{{ record.invoice_number|default:'' }}"
                                   placeholder="e.g., INV-2024-001">
                            {% if confidence.invoice_number %}
                            <div class="form-help">Confidence: {{ confidence.invoice_number|floatformat:0 }}%</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Split Transaction / Line Items -->
                    <div class="form-section">
                        <div class="form-section-title">
                            Split Transaction
                            <label style="font-weight: normal; font-size: 0.75rem; margin-left: 0.5rem; text-transform: none;">
                                <input type="checkbox" id="enable_split" onchange="toggleSplitMode(this.checked)">
                                Enable split booking
                            </label>
                        </div>
                        <div id="split-container" style="display: none;">
                            <div class="form-help mb-3">
                                Split this transaction across multiple lines with different categories. 
                                The sum must equal the total amount above.
                            </div>
                            <div id="line-items-container">
                                <!-- Line items will be added dynamically -->
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button type="button" class="btn btn-sm btn-outline" onclick="addLineItem()">
                                    + Add Line
                                </button>
                                <span id="split-total" class="form-help" style="margin-left: auto; font-weight: 600;"></span>
                            </div>
                        </div>
                        <input type="hidden" id="line_items_json" name="line_items_json" value="">
                    </div>
                    {% endif %}
                </div>
                
                {% if record_type == 'paperless' %}
                <div class="action-buttons">
                    <button type="submit" class="btn btn-success" title="Save your edits and accept this transaction">üíæ Save & Accept</button>
                    <button type="submit" formaction="{% url 'accept' record.extraction_id %}" formnovalidate class="btn btn-primary" title="Accept AI-extracted data without changes">‚úì Accept As-Is</button>
                    <a href="{% url 'reject' record.extraction_id %}" class="btn btn-danger" 
                       onclick="return confirm('Reject this extraction?')" title="Reject this document">‚ùå Reject</a>
                    <button type="submit" formaction="{% url 'skip' record.extraction_id %}" formnovalidate class="btn btn-secondary" title="Skip for now - review later">Skip ‚Üí</button>
                    {% if record.review_decision %}
                    <a href="{% url 'reset_extraction' record.extraction_id %}" class="btn btn-outline">üîÑ Reset</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </form>
        
        {% if record_type == 'paperless' %}
        <!-- AI Settings -->
        {% if llm_globally_enabled %}
        <div class="card mt-4">
            <div class="card-header">
                <h2>ü§ñ AI Settings</h2>
            </div>
            <div class="card-body">
                <div class="form-row" style="align-items: center; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" 
                                   id="llm_opt_out_checkbox"
                                   {% if not llm_opt_out %}checked{% endif %}
                                   onchange="toggleLlmOptOut(this.checked)"
                                   style="width: 1.25rem; height: 1.25rem;">
                            <span>Use AI suggestions for this document</span>
                        </label>
                        <div class="form-help">
                            When enabled, AI will assist with category suggestions. Disable to rely only on rule-based extraction.
                        </div>
                    </div>
                    <div>
                        <button type="button" 
                                class="btn btn-outline"
                                onclick="rerunInterpretation()"
                                title="Re-run AI interpretation for this document">
                            üîÑ Re-run Interpretation
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Confidence Details -->
        {% if confidence %}
        <div class="card mt-4">
            <div class="card-header">
                <h2>Confidence Scores</h2>
                <span class="text-mono">{{ confidence.overall|floatformat:0 }}% overall</span>
            </div>
            <div class="card-body">
                <div class="confidence-bar" style="height: 0.75rem; margin-bottom: 1rem;">
                    <div class="confidence-bar-fill {% if confidence.overall >= 85 %}confidence-high{% elif confidence.overall >= 60 %}confidence-medium{% else %}confidence-low{% endif %}"
                         style="width: {{ confidence.overall }}%"></div>
                </div>
                <div class="confidence-detail">
                    <div class="confidence-item">
                        <div class="confidence-item-label">Amount</div>
                        <div class="confidence-item-value">{{ confidence.amount|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Date</div>
                        <div class="confidence-item-value">{{ confidence.date|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Currency</div>
                        <div class="confidence-item-value">{{ confidence.currency|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Vendor</div>
                        <div class="confidence-item-value">{{ confidence.vendor|floatformat:0 }}%</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Extraction Audit / Provenance -->
        {% if provenance or record.raw_text %}
        <div class="card mt-4">
            <div class="card-header">
                <h2>üîç Extraction Audit</h2>
            </div>
            <div class="card-body">
                {% if provenance %}
                <dl class="provenance-info">
                    <dt>Source:</dt>
                    <dd>{{ provenance.source_system|default:"paperless" }}</dd>
                    
                    <dt>Strategy:</dt>
                    <dd>{{ provenance.extraction_strategy|default:"ocr_heuristic" }}</dd>
                    
                    <dt>Parser:</dt>
                    <dd>v{{ provenance.parser_version|default:"unknown" }}</dd>
                    
                    <dt>Parsed:</dt>
                    <dd>{{ provenance.parsed_at|default:"unknown" }}</dd>
                    
                    {% if record.source_hash %}
                    <dt>Source Hash:</dt>
                    <dd><code style="font-size: 0.7rem;">{{ record.source_hash|truncatechars:20 }}</code></dd>
                    {% endif %}
                </dl>
                {% endif %}
                
                <!-- Per-field confidence details -->
                {% if confidence %}
                <div class="mt-4">
                    <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Field Confidence Scores</h4>
                    <div class="confidence-detail">
                        <div class="confidence-item">
                            <div class="confidence-item-label">Amount</div>
                            <div class="confidence-item-value {% if confidence.amount >= 80 %}text-success{% elif confidence.amount >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.amount|floatformat:0 }}%
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="confidence-item-label">Date</div>
                            <div class="confidence-item-value {% if confidence.date >= 80 %}text-success{% elif confidence.date >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.date|floatformat:0 }}%
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="confidence-item-label">Vendor</div>
                            <div class="confidence-item-value {% if confidence.vendor >= 80 %}text-success{% elif confidence.vendor >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.vendor|floatformat:0 }}%
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="confidence-item-label">Description</div>
                            <div class="confidence-item-value {% if confidence.description >= 80 %}text-success{% elif confidence.description >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.description|floatformat:0 }}%
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if record.raw_text %}
                <details class="mt-4">
                    <summary style="cursor: pointer; font-size: 0.875rem; color: var(--gray-500);">
                        üìù Show Raw OCR Text (Source Data)
                    </summary>
                    <div class="raw-text mt-2">{{ record.raw_text|truncatechars:3000 }}</div>
                </details>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Document Links (visible on small screens) -->
        <div class="card mt-4 viewer-toggle-card" style="display: none;">
            <div class="card-body">
                <a href="{% url 'document' record.id %}" target="_blank" class="btn btn-outline">
                    üìÑ View Original Document
                </a>
                <a href="{{ paperless_url }}/documents/{{ record.id }}/" target="_blank" class="btn btn-outline">
                    Open in Paperless ‚Üó
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Link Section (Right Sidebar) -->
    <div class="link-section">
        <div class="link-header">
            <h3>üîó Linking</h3>
            <p>{% if record_type == 'paperless' %}Match to Firefly transaction{% else %}Match to Paperless document{% endif %}</p>
        </div>
        
        <!-- Current Link Status -->
        <div class="link-status {{ link_status }}">
            {% if link_status == 'linked' %}
            <div class="link-status-title">‚úÖ Linked</div>
            <div class="link-status-desc">This record is linked and ready for import</div>
            {% elif link_status == 'orphan' %}
            <div class="link-status-title">üìç Orphan</div>
            <div class="link-status-desc">Confirmed as having no matching record</div>
            {% else %}
            <div class="link-status-title">‚ö†Ô∏è Not Linked</div>
            <div class="link-status-desc">Must be linked or marked as orphan before import</div>
            {% endif %}
        </div>
        
        {% if linked_record %}
        <!-- Linked Record Info -->
        <div class="linked-record-info">
            <h4>Linked to:</h4>
            <div class="linked-record-details">
                {% if record_type == 'paperless' %}
                <strong>üè¶ Firefly #{{ linkage.firefly_id }}</strong><br>
                {{ linked_record.description|truncatechars:40 }}<br>
                <span class="text-muted">{{ linked_record.amount }} ‚Ä¢ {{ linked_record.date }}</span>
                {% else %}
                <strong>üìÑ Document #{{ linked_record.document_id }}</strong><br>
                {{ linked_record.title|truncatechars:40 }}
                {% endif %}
            </div>
            <div style="margin-top: 0.75rem;">
                <button type="button" class="btn btn-outline btn-sm" onclick="unlinkRecord()" title="Remove this linkage">
                    üîì Unlink
                </button>
            </div>
        </div>
        {% endif %}
        
        {% if link_status == 'pending' %}
        <!-- Top 3 Suggestions -->
        <div class="suggestions-section">
            <div class="suggestions-title">
                Top Matches (click to link)
            </div>
            
            {% if suggestions %}
            {% for suggestion in suggestions %}
            <div class="suggestion-item" 
                 data-id="{{ suggestion.id }}"
                 data-type="{{ suggestion.type }}"
                 onclick="selectSuggestion(this, {{ suggestion.id }}, '{{ suggestion.type }}')">
                <div class="suggestion-header">
                    <span class="suggestion-title">
                        {% if suggestion.type == 'firefly' %}
                        üè¶ {{ suggestion.description|truncatechars:25 }}
                        {% else %}
                        üìÑ {{ suggestion.title|truncatechars:25 }}
                        {% endif %}
                    </span>
                    <span class="suggestion-score">{{ suggestion.score }}%</span>
                </div>
                <div class="suggestion-meta">
                    {{ suggestion.amount|default:"‚Äî" }} ‚Ä¢ {{ suggestion.date|default:"‚Äî" }}
                    {% if suggestion.vendor or suggestion.destination_account %}
                    ‚Ä¢ {{ suggestion.vendor|default:suggestion.destination_account|default:"‚Äî" }}
                    {% endif %}
                </div>
                <div class="suggestion-actions">
                    <button type="button" class="btn btn-sm btn-primary" 
                            onclick="event.stopPropagation(); quickLink({{ record.id }}, {{ suggestion.id }})">
                        üîó Link
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted text-sm">No matching records found</p>
            {% endif %}
            
            <button type="button" class="btn btn-outline btn-sm mt-3" onclick="loadMoreSuggestions()">
                üîÑ Load More Suggestions
            </button>
        </div>
        
        <!-- Mark as Orphan -->
        <div class="orphan-section">
            <h4>üìç No Match?</h4>
            <p>If this record has no matching partner (e.g., cash payment, no receipt), mark it as orphan.</p>
            <button type="button" class="btn btn-warning btn-sm" onclick="markAsOrphan()">
                Mark as Orphan
            </button>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Store current record info
const recordType = '{{ record_type }}';
const recordId = {{ record.id }};
{% if record_type == 'paperless' %}
const documentId = {{ record.id }};
const extractionId = {{ record.extraction_id|default:"null" }};
{% else %}
const fireflyId = {{ record.id }};
{% endif %}

let selectedSuggestion = null;

// Document viewer toggle
function toggleDocumentViewer() {
    const viewer = document.getElementById('document-viewer');
    const btn = document.getElementById('viewer-toggle-btn');
    if (viewer) {
        viewer.classList.toggle('collapsed');
        const isCollapsed = viewer.classList.contains('collapsed');
        if (btn) {
            btn.textContent = isCollapsed ? '‚ñ∂ Show' : '‚ñº Hide';
        }
        // Remember preference in localStorage
        localStorage.setItem('documentViewerCollapsed', isCollapsed);
    }
}

// Iframe load/error handling
function handleIframeLoad() {
    const iframe = document.getElementById('document-iframe');
    const errorDiv = document.getElementById('document-error');
    
    // Try to detect load errors (cross-origin restrictions may prevent this)
    try {
        // Check if iframe loaded with content
        if (iframe && iframe.contentWindow) {
            // Hide error, show iframe
            if (errorDiv) errorDiv.style.display = 'none';
            iframe.style.display = 'block';
        }
    } catch (e) {
        // Cross-origin - can't check, assume loaded OK
        console.log('Cannot check iframe content (cross-origin)');
    }
}

function handleIframeError() {
    const iframe = document.getElementById('document-iframe');
    const errorDiv = document.getElementById('document-error');
    
    // Show error message, hide iframe
    if (iframe) iframe.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'flex';
}

// Check for HTTP errors from document endpoint
function checkDocumentAvailability() {
    {% if record_type == 'paperless' %}
    fetch('{% url "document" record.id %}', { method: 'HEAD' })
        .then(response => {
            if (!response.ok) {
                handleIframeError();
            }
        })
        .catch(() => {
            handleIframeError();
        });
    {% endif %}
}

// Initialize document viewer state from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const viewer = document.getElementById('document-viewer');
    const btn = document.getElementById('viewer-toggle-btn');
    const savedState = localStorage.getItem('documentViewerCollapsed');
    
    if (viewer && savedState === 'true') {
        viewer.classList.add('collapsed');
        if (btn) btn.textContent = '‚ñ∂ Show';
    }
    
    // Check document availability after short delay
    setTimeout(checkDocumentAvailability, 500);
});

// Split transaction management
let lineItems = [];
let lineItemCounter = 0;

function toggleSplitMode(enabled) {
    const container = document.getElementById('split-container');
    if (!container) return;
    container.style.display = enabled ? 'block' : 'none';
    
    if (enabled && lineItems.length === 0) {
        // Add first line item with the total amount
        addLineItem(parseFloat(document.getElementById('amount').value) || 0);
    }
    
    updateLineItemsJson();
}

function addLineItem(amount = 0, description = '', category = '') {
    const id = lineItemCounter++;
    lineItems.push({ id, amount, description, category });
    renderLineItems();
}

function removeLineItem(id) {
    lineItems = lineItems.filter(item => item.id !== id);
    if (lineItems.length === 0) {
        const checkbox = document.getElementById('enable_split');
        if (checkbox) checkbox.checked = false;
        toggleSplitMode(false);
    } else {
        renderLineItems();
    }
}

function updateLineItem(id, field, value) {
    const item = lineItems.find(item => item.id === id);
    if (item) {
        if (field === 'amount') {
            item.amount = parseFloat(value) || 0;
        } else {
            item[field] = value;
        }
    }
    updateSplitTotal();
    updateLineItemsJson();
}

function renderLineItems() {
    const container = document.getElementById('line-items-container');
    if (!container) return;
    
    const categories = {{ firefly_categories_json|safe|default:"[]" }};
    
    container.innerHTML = lineItems.map((item, idx) => `
        <div class="line-item-row" style="display: grid; grid-template-columns: 1fr 2fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border: 1px solid var(--gray-200); border-radius: 0.25rem;">
            <div>
                <input type="number" 
                       value="${item.amount}" 
                       step="0.01" 
                       class="form-input" 
                       placeholder="Amount"
                       onchange="updateLineItem(${item.id}, 'amount', this.value)"
                       style="font-size: 0.875rem;">
            </div>
            <div>
                <input type="text" 
                       value="${item.description}" 
                       class="form-input" 
                       placeholder="Description"
                       onchange="updateLineItem(${item.id}, 'description', this.value)"
                       style="font-size: 0.875rem;">
            </div>
            <div>
                <select class="form-input" 
                        onchange="updateLineItem(${item.id}, 'category', this.value)"
                        style="font-size: 0.875rem;">
                    <option value="">-- Category --</option>
                    ${categories.map(cat => `<option value="${cat.name}" ${cat.name === item.category ? 'selected' : ''}>${cat.name}</option>`).join('')}
                </select>
            </div>
            <button type="button" 
                    class="btn btn-sm btn-outline" 
                    onclick="removeLineItem(${item.id})"
                    style="color: #dc2626;"
                    ${lineItems.length <= 1 ? 'disabled' : ''}>
                ‚úï
            </button>
        </div>
    `).join('');
    
    updateSplitTotal();
    updateLineItemsJson();
}

function updateSplitTotal() {
    const total = lineItems.reduce((sum, item) => sum + (item.amount || 0), 0);
    const expectedEl = document.getElementById('amount');
    const expected = expectedEl ? parseFloat(expectedEl.value) || 0 : 0;
    const diff = Math.abs(total - expected);
    
    const totalEl = document.getElementById('split-total');
    if (!totalEl) return;
    
    if (diff < 0.01) {
        totalEl.innerHTML = `Total: ${total.toFixed(2)} ‚úì`;
        totalEl.style.color = 'var(--success)';
    } else {
        totalEl.innerHTML = `Total: ${total.toFixed(2)} (expected: ${expected.toFixed(2)}, diff: ${diff.toFixed(2)})`;
        totalEl.style.color = 'var(--danger)';
    }
}

function updateLineItemsJson() {
    const checkbox = document.getElementById('enable_split');
    const enabled = checkbox ? checkbox.checked : false;
    const json = enabled && lineItems.length > 0 ? JSON.stringify(lineItems) : '';
    const jsonField = document.getElementById('line_items_json');
    if (jsonField) jsonField.value = json;
}

// Update split total when main amount changes
const amountField = document.getElementById('amount');
if (amountField) {
    amountField.addEventListener('change', updateSplitTotal);
}

// LLM opt-out toggle
function toggleLlmOptOut(enableAi) {
    const optOut = !enableAi;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "toggle_llm_opt_out" record.extraction_id|default:0 %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ opt_out: optOut })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const checkbox = document.getElementById('llm_opt_out_checkbox');
            const originalLabel = checkbox.nextElementSibling.textContent;
            checkbox.nextElementSibling.textContent = data.message;
            setTimeout(() => {
                checkbox.nextElementSibling.textContent = originalLabel;
            }, 2000);
        } else {
            alert('Failed to update setting: ' + data.error);
            document.getElementById('llm_opt_out_checkbox').checked = enableAi;
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
        document.getElementById('llm_opt_out_checkbox').checked = enableAi;
    });
}

// Re-run interpretation
function rerunInterpretation() {
    {% if not llm_globally_enabled %}
    alert('AI/Ollama is not enabled. Please enable it in Settings to use this feature.');
    return;
    {% endif %}
    
    if (!confirm('Re-run AI interpretation for this document? The AI will analyze all fields and provide suggestions.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '‚è≥ Processing...';
    btn.disabled = true;
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "rerun_interpretation" record.extraction_id|default:0 %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Please try again.');
        }
        return response.json();
    })
    .then(data => {
        btn.textContent = originalText;
        btn.disabled = false;
        
        if (data.success) {
            // Apply suggestions dynamically to form fields
            if (data.suggestions) {
                applySuggestionsToForm(data.suggestions);
                showSuggestionsSummary(data.suggestions, data.message);
            } else if (data.suggestion) {
                // Backward compatibility: single category suggestion
                applySuggestionsToForm({
                    category: {
                        value: data.suggestion.category,
                        confidence: data.suggestion.confidence,
                        reason: ''
                    }
                });
                showSuggestionsSummary({category: data.suggestion}, data.message);
            } else {
                alert(data.message || 'AI completed but returned no suggestions.');
            }
        } else {
            alert('Failed to re-run interpretation: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Network error: ' + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
    });
}

// Apply AI suggestions to form fields
function applySuggestionsToForm(suggestions) {
    const fieldMap = {
        'category': 'category',
        'transaction_type': 'transaction_type',
        'destination_account': 'destination_account',
        'description': 'description',
        'invoice_number': 'invoice_number'
    };
    
    for (const [field, suggestion] of Object.entries(suggestions)) {
        const fieldId = fieldMap[field];
        if (!fieldId) continue;
        
        const element = document.getElementById(fieldId);
        if (!element) continue;
        
        // Only apply if confidence > 0.5
        const confidence = suggestion.confidence || 0;
        if (confidence < 0.5) continue;
        
        // Highlight the field to show it was updated
        element.style.transition = 'background-color 0.3s';
        element.style.backgroundColor = '#e8f5e9';
        
        // Set the value
        if (element.tagName === 'SELECT') {
            // For select, find and select the option
            const option = Array.from(element.options).find(o => o.value === suggestion.value);
            if (option) {
                element.value = suggestion.value;
            }
        } else {
            element.value = suggestion.value;
        }
        
        // Add tooltip with reason
        if (suggestion.reason) {
            element.title = `AI suggestion (${Math.round(confidence * 100)}%): ${suggestion.reason}`;
        }
        
        // Fade out highlight
        setTimeout(() => {
            element.style.backgroundColor = '';
        }, 2000);
        
        // Add a small badge next to the field
        addAISuggestionBadge(element, confidence, suggestion.reason);
    }
}

// Add AI badge next to suggested field
function addAISuggestionBadge(element, confidence, reason) {
    // Remove existing badge if any
    const existingBadge = element.parentElement.querySelector('.ai-suggestion-badge');
    if (existingBadge) {
        existingBadge.remove();
    }
    
    const badge = document.createElement('span');
    badge.className = 'ai-suggestion-badge';
    badge.innerHTML = `ü§ñ ${Math.round(confidence * 100)}%`;
    badge.style.cssText = `
        display: inline-block;
        margin-left: 8px;
        padding: 2px 6px;
        font-size: 0.7rem;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 4px;
        cursor: help;
    `;
    badge.title = reason || 'AI suggested this value';
    
    // Insert after the input/select
    element.insertAdjacentElement('afterend', badge);
}

// Show summary of suggestions
function showSuggestionsSummary(suggestions, message) {
    const summaryItems = [];
    for (const [field, suggestion] of Object.entries(suggestions)) {
        if (suggestion.value && suggestion.confidence >= 0.5) {
            summaryItems.push(`${field}: "${suggestion.value}" (${Math.round(suggestion.confidence * 100)}%)`);
        }
    }
    
    if (summaryItems.length > 0) {
        const summaryText = 'AI Suggestions applied:\\n\\n' + summaryItems.join('\\n') + 
            '\\n\\nFields have been highlighted. Review and adjust as needed.';
        alert(summaryText);
    } else {
        alert(message || 'AI analysis complete. No high-confidence suggestions to apply.');
    }
}

function selectSuggestion(element, id, type) {
    // Remove selection from all
    document.querySelectorAll('.suggestion-item').forEach(el => {
        el.classList.remove('selected');
    });
    // Select this one
    element.classList.add('selected');
    selectedSuggestion = { id, type };
}

function quickLink(paperlessId, fireflyId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_quick_link" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            paperless_id: recordType === 'paperless' ? recordId : fireflyId,
            firefly_id: recordType === 'paperless' ? fireflyId : recordId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error creating link: ' + error);
    });
}

function markAsOrphan() {
    if (!confirm('Mark this record as orphan (no matching partner)?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_quick_link" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            paperless_id: recordType === 'paperless' ? recordId : null,
            firefly_id: recordType === 'firefly' ? recordId : null,
            mark_orphan: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error marking as orphan: ' + error);
    });
}

function loadMoreSuggestions() {
    fetch('{% url "api_link_suggestions" record_type record_id %}')
    .then(response => response.json())
    .then(data => {
        console.log('Suggestions:', data.suggestions);
        // Could update the suggestions list dynamically
        alert('Found ' + data.suggestions.length + ' suggestions');
    })
    .catch(error => {
        console.error('Error loading suggestions:', error);
    });
}

function unlinkRecord() {
    if (!confirm('Remove the linkage between these records? This will set the record back to "pending" status.')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_unlink" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            record_type: recordType,
            record_id: recordId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error removing link: ' + error);
    });
}
</script>
{% endblock %}
