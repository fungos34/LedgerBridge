{% extends "review/base.html" %}

{% block title %}Review: {{ record.title|truncatechars:40 }} - SparkLink{% endblock %}
{% block pending_count %}{{ pending_count }}{% endblock %}

{% block extra_css %}
<style>
    .review-layout {
        display: grid;
        grid-template-columns: 1fr 1fr 400px;
        gap: 1.5rem;
        align-items: start;
    }
    
    @media (max-width: 1400px) {
        .review-layout {
            grid-template-columns: 1fr 400px;
        }
        .document-viewer {
            display: none;
        }
    }
    
    @media (max-width: 1024px) {
        .review-layout {
            grid-template-columns: 1fr;
        }
    }
    
    .nav-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .record-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .record-type-badge.paperless {
        background: #f3e8ff;
        color: #7c3aed;
    }
    
    .record-type-badge.firefly {
        background: #dcfce7;
        color: #059669;
    }
    
    .form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .form-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--gray-500);
        margin-bottom: 1rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }
    
    /* Document Viewer */
    .document-viewer {
        position: sticky;
        top: 1rem;
        height: calc(100vh - 8rem);
        min-height: 500px;
    }
    
    .document-viewer.collapsed {
        height: 60px;
        min-height: 60px;
        overflow: hidden;
    }
    
    .document-viewer.collapsed .card-body {
        display: none;
    }
    
    .document-viewer iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 0.375rem;
    }
    
    .viewer-toggle {
        background: var(--gray-100);
        border: 1px solid var(--gray-300);
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        display: inline-block;
    }
    
    .viewer-toggle:hover {
        background: var(--gray-200);
    }
    
    .document-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 2rem;
        text-align: center;
        color: var(--gray-500);
        background: var(--gray-50);
        border-radius: 0.375rem;
    }
    
    .document-error-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .document-error-title {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }
    
    .document-error-message {
        font-size: 0.875rem;
    }
    
    /* Confidence Details */
    .confidence-detail {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .confidence-item {
        text-align: center;
        padding: 0.5rem;
        background: var(--gray-50);
        border-radius: 0.25rem;
    }
    
    .confidence-item-label {
        font-size: 0.625rem;
        text-transform: uppercase;
        color: var(--gray-500);
    }
    
    .confidence-item-value {
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    /* Required field indicator */
    .required-star {
        color: #dc2626;
        font-weight: bold;
    }
    
    /* Field validation error */
    .form-input.field-error,
    .form-input:invalid:not(:focus) {
        border-color: #dc2626;
        box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.1);
    }
    
    /* Provenance */
    .provenance-info {
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    .provenance-info dt {
        font-weight: 500;
        display: inline;
    }
    
    .provenance-info dd {
        display: inline;
        margin: 0;
        margin-right: 1rem;
    }
    
    .raw-text {
        max-height: 200px;
        overflow-y: auto;
        background: var(--gray-50);
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-family: monospace;
        font-size: 0.75rem;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    /* Link Section */
    .link-section {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: sticky;
        top: 1rem;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
    }
    
    .link-header {
        padding: 1rem 1.25rem;
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
    }
    
    .link-header h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .link-header p {
        font-size: 0.75rem;
        opacity: 0.9;
    }
    
    .link-status {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .link-status.pending {
        background: #fef3c7;
        border-left: 3px solid #d97706;
    }
    
    .link-status.linked {
        background: #dcfce7;
        border-left: 3px solid #059669;
    }
    
    .link-status.orphan {
        background: #fee2e2;
        border-left: 3px solid #dc2626;
    }
    
    .link-status-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .link-status-desc {
        font-size: 0.75rem;
        color: var(--gray-600);
    }
    
    /* Suggestions */
    .suggestions-section {
        padding: 1rem 1.25rem;
    }
    
    .suggestions-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--gray-500);
        margin-bottom: 0.75rem;
    }
    
    .suggestion-item {
        padding: 0.75rem;
        background: var(--gray-50);
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.15s;
        border: 2px solid transparent;
    }
    
    .suggestion-item:hover {
        background: #dbeafe;
        border-color: #93c5fd;
    }
    
    .suggestion-item.selected {
        background: #dbeafe;
        border-color: var(--primary);
    }
    
    .suggestion-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .suggestion-score {
        background: var(--primary);
        color: white;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 600;
    }
    
    .suggestion-title {
        font-weight: 600;
        font-size: 0.875rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .suggestion-meta {
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    .suggestion-actions {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
    }
    
    /* Orphan Section */
    .orphan-section {
        padding: 1rem 1.25rem;
        background: #fef3c7;
        border-top: 1px dashed #d97706;
    }
    
    .orphan-section h4 {
        font-size: 0.875rem;
        color: #92400e;
        margin-bottom: 0.5rem;
    }
    
    .orphan-section p {
        font-size: 0.75rem;
        color: #92400e;
        margin-bottom: 0.75rem;
    }
    
    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        padding: 1rem;
        background: var(--gray-50);
        border-top: 1px solid var(--gray-200);
    }
    
    /* Prominent Confirm Button */
    .btn-confirm {
        font-weight: 600;
        font-size: 1rem;
        padding: 0.625rem 1.25rem;
        background: linear-gradient(135deg, #059669, #047857);
        border: 2px solid #047857;
        box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
        transition: all 0.2s ease;
    }
    
    .btn-confirm:hover {
        background: linear-gradient(135deg, #047857, #065f46);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(5, 150, 105, 0.4);
    }
    
    /* AI Changed Field Highlighting */
    .ai-modified {
        background-color: #fffbeb !important;
        border-color: #f59e0b !important;
        transition: background-color 0.3s ease;
    }
    
    .ai-modified-container {
        position: relative;
    }
    
    .ai-field-actions {
        display: inline-flex;
        gap: 0.25rem;
        margin-left: 0.5rem;
        vertical-align: middle;
    }
    
    .ai-field-actions button {
        padding: 0.125rem 0.375rem;
        font-size: 0.65rem;
        border-radius: 0.25rem;
        border: 1px solid var(--gray-300);
        background: white;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .ai-field-actions button.accept-ai:hover {
        background: #dcfce7;
        border-color: #22c55e;
    }
    
    .ai-field-actions button.undo-ai:hover {
        background: #fee2e2;
        border-color: #ef4444;
    }
    
    /* Unsaved changes indicator */
    .unsaved-indicator {
        display: none;
        padding: 0.5rem 1rem;
        background: #fef3c7;
        border-bottom: 1px solid #fbbf24;
        color: #92400e;
        font-size: 0.875rem;
        text-align: center;
    }
    
    .unsaved-indicator.visible {
        display: block;
    }
    
    /* Notification animations */
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    /* Linked Record Info */
    .linked-record-info {
        padding: 1rem 1.25rem;
        background: #f0fdf4;
        border-top: 1px solid #86efac;
    }
    
    .linked-record-info h4 {
        font-size: 0.75rem;
        color: #166534;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
    }
    
    .linked-record-details {
        font-size: 0.875rem;
    }
    
    /* Confidence Badge */
    .confidence-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 600;
    }
    
    .confidence-high { background: #dcfce7; color: #166534; }
    .confidence-medium { background: #fef3c7; color: #92400e; }
    .confidence-low { background: #fee2e2; color: #991b1b; }
    
    /* AI Badge */
    .badge-ai {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        background: linear-gradient(135deg, #818cf8, #6366f1);
        color: white;
        font-size: 0.625rem;
        font-weight: 600;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        margin-left: 0.5rem;
    }
    
    /* AI Progress Modal */
    .ai-progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }
    
    .ai-progress-modal {
        background: white;
        border-radius: 0.75rem;
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    .ai-progress-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--gray-900);
    }
    
    .ai-progress-subtitle {
        font-size: 0.875rem;
        color: var(--gray-500);
        margin-bottom: 1.5rem;
    }
    
    .ai-progress-bar-container {
        background: var(--gray-200);
        border-radius: 9999px;
        height: 0.75rem;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .ai-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        border-radius: 9999px;
        transition: width 1s linear;
    }
    
    .ai-progress-time {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }
    
    .ai-progress-status {
        font-size: 0.875rem;
        color: var(--gray-600);
        min-height: 1.5rem;
        margin-top: 0.5rem;
        font-weight: 500;
    }
    
    .ai-progress-hint {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--gray-400);
    }
    
    .ai-progress-cancel {
        margin-top: 1.5rem;
        padding: 0.5rem 1.5rem;
        background: var(--gray-100);
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.875rem;
    }
    
    .ai-progress-cancel:hover {
        background: var(--gray-200);
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .ai-progress-spinner {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    /* Collapsible Cards */
    .card-collapsible .card-header {
        cursor: pointer;
        transition: background-color 0.15s ease;
        user-select: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-collapsible .card-header:hover {
        background: var(--gray-100);
    }
    
    .card-collapsible .card-header h2 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .card-collapsible .collapse-icon {
        font-size: 0.75rem;
        color: var(--gray-500);
        transition: transform 0.2s ease;
        margin-left: auto;
    }
    
    .card-collapsible.collapsed .collapse-icon {
        transform: rotate(-90deg);
    }
    
    .card-collapsible.collapsed .card-body {
        display: none;
    }
    
    .card-collapsible .card-header-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    /* AI Job Status Badge */
    .ai-job-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.125rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.625rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .ai-job-badge.pending { background: #fef3c7; color: #92400e; }
    .ai-job-badge.processing { background: #dbeafe; color: #1d4ed8; }
    .ai-job-badge.completed { background: #dcfce7; color: #166534; }
    .ai-job-badge.failed { background: #fee2e2; color: #991b1b; }
    .ai-job-badge.not-scheduled { background: var(--gray-100); color: var(--gray-600); }
</style>
{% endblock %}

{% block content %}
<!-- Navigation -->
<div class="nav-buttons">
    <div class="flex gap-2 items-center">
        <a href="{% url 'unified_review_list' %}" class="btn btn-outline">‚Üê Back to List</a>
        {% if prev_id %}
        <a href="{% url 'unified_review_detail' record_type prev_id %}" class="btn btn-outline">‚Üê Previous</a>
        {% endif %}
        <span class="record-type-badge {{ record_type }}">
            {% if record_type == 'paperless' %}üìÑ Paperless{% else %}üè¶ Firefly{% endif %}
        </span>
    </div>
    <span class="position text-muted text-sm">{{ current_position }} of {{ pending_count }}</span>
    <div class="flex gap-2 items-center">
        {% if next_id %}
        <a href="{% url 'unified_review_detail' record_type next_id %}" class="btn btn-outline">Next ‚Üí</a>
        {% endif %}
        <span class="confidence-badge {% if record.confidence >= 80 %}confidence-high{% elif record.confidence >= 50 %}confidence-medium{% else %}confidence-low{% endif %}">
            {{ record.confidence|floatformat:0 }}% confidence
        </span>
    </div>
</div>

<div class="review-layout">
    {% if record_type == 'paperless' %}
    <!-- Document Viewer (Paperless only) -->
    <div class="card document-viewer" id="document-viewer">
        <div class="card-header">
            <h2>üìÑ Document Preview</h2>
            <div class="flex gap-2">
                <button type="button" class="viewer-toggle" onclick="toggleDocumentViewer()" title="Toggle document preview" id="viewer-toggle-btn">
                    ‚ñº Hide
                </button>
                <a href="{% url 'document' record.id %}?download=1" class="btn btn-sm btn-outline" download>
                    ‚¨á Download
                </a>
                <a href="{{ paperless_url }}/documents/{{ record.id }}/" target="_blank" class="btn btn-sm btn-outline">
                    Open in Paperless ‚Üó
                </a>
            </div>
        </div>
        <div class="card-body" style="height: calc(100% - 60px); padding: 0;" id="document-body">
            <div class="document-error" id="document-error" style="display: none;">
                <div class="document-error-icon">üìÑ‚ùå</div>
                <div class="document-error-title">Document Not Available</div>
                <div class="document-error-message">
                    The document may have been removed from Paperless or is temporarily unavailable.
                    <br><br>
                    <a href="{{ paperless_url }}/documents/{{ record.id }}/" target="_blank" class="btn btn-sm btn-primary">
                        Check in Paperless ‚Üó
                    </a>
                </div>
            </div>
            <iframe src="{% url 'document' record.id %}" 
                    title="Document Preview"
                    id="document-iframe"
                    onload="handleIframeLoad()"
                    onerror="handleIframeError()"
                    style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    {% endif %}
    
    <!-- Main Form -->
    <div>
        <!-- Unsaved Changes Warning Banner -->
        <div id="unsaved-indicator" class="unsaved-indicator">
            ‚ö†Ô∏è You have unsaved changes. Save before leaving or they will be lost.
        </div>
        
        <form method="post" action="{% if record_type == 'paperless' %}{% url 'save' record.extraction_id %}{% endif %}" id="review-form">
            {% csrf_token %}
            <!-- Hidden field for confirm flag -->
            <input type="hidden" name="confirm" id="confirm-flag" value="true">
            
            <div class="card">
                <div class="card-header">
                    <h2>{{ record.title|truncatechars:50 }}</h2>
                </div>
                <div class="card-body">
                    <!-- Amount & Currency (keeping section as it has 2 fields) -->
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="amount">Amount <span class="required-star">*</span></label>
                                <input type="number" 
                                       id="amount" 
                                       name="amount" 
                                       class="form-input" 
                                       value="{{ record.amount }}"
                                       step="0.01"
                                       {% if record_type == 'firefly' %}readonly{% endif %}
                                       required>
                                {% if confidence.amount %}
                                <div class="form-help">Confidence: {{ confidence.amount|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="currency">Currency <span class="required-star">*</span></label>
                                <input type="text" 
                                       id="currency" 
                                       name="currency" 
                                       class="form-input" 
                                       value="{{ record.currency }}"
                                       maxlength="3"
                                       style="text-transform: uppercase;"
                                       {% if record_type == 'firefly' %}readonly{% endif %}
                                       required>
                                {% if confidence.currency %}
                                <div class="form-help">Confidence: {{ confidence.currency|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Date & Description (combined as related fields) -->
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="date">Transaction Date <span class="required-star">*</span></label>
                                <input type="date" 
                                       id="date" 
                                       name="date" 
                                       class="form-input" 
                                       value="{{ record.date }}"
                                       {% if record_type == 'firefly' %}readonly{% endif %}
                                       required>
                                {% if confidence.date %}
                                <div class="form-help">Confidence: {{ confidence.date|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label" for="description">Description <span class="required-star">*</span></label>
                                <input type="text" 
                                       id="description" 
                                       name="description" 
                                       class="form-input" 
                                       value="{{ record.description }}"
                                       {% if record_type == 'firefly' %}readonly{% endif %}
                                       required>
                                {% if confidence.description %}
                                <div class="form-help">Confidence: {{ confidence.description|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Accounts (keeping as has 2 fields) -->
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="source_account">Source Account <span class="required-star">*</span></label>
                                {% if record_type == 'paperless' %}
                                <select id="source_account" name="source_account" class="form-input" required>
                                    <option value="">-- Select Source Account --</option>
                                    {% for account in firefly_accounts %}
                                    <option value="{{ account.name }}" {% if account.name == record.source_account %}selected{% endif %}>
                                        {{ account.name }} ({{ account.currency_code }})
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if not firefly_accounts %}
                                <div class="form-help" style="color: #dc2626;">‚ö†Ô∏è Could not load Firefly accounts. Check your API settings.</div>
                                {% else %}
                                <div class="form-help">The bank account to debit (required for transactions)</div>
                                {% endif %}
                                {% else %}
                                <input type="text" class="form-input" value="{{ record.source_account }}" readonly>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="destination_account">Destination / Vendor</label>
                                <input type="text" 
                                       id="destination_account" 
                                       name="destination_account" 
                                       class="form-input" 
                                       value="{{ record.vendor|default:record.destination_account|default:'' }}"
                                       placeholder="e.g., Supermarket"
                                       {% if record_type == 'firefly' %}readonly{% endif %}>
                                {% if confidence.vendor %}
                                <div class="form-help">Confidence: {{ confidence.vendor|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Category -->
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label" for="category">
                                Category
                                {% if llm_suggestion %}
                                <span class="badge-ai" title="AI suggested: {{ llm_suggestion.category }}">ü§ñ AI</span>
                                {% endif %}
                            </label>
                            {% if record_type == 'paperless' %}
                            <select id="category" name="category" class="form-input">
                                <option value="">-- Select Category --</option>
                                {% for cat in firefly_categories %}
                                <option value="{{ cat.name }}" {% if cat.name == record.category %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if llm_suggestion %}
                            <div class="form-help">
                                AI suggested: <strong>{{ llm_suggestion.category }}</strong>
                                <button type="button" class="btn btn-xs btn-outline" 
                                        onclick="document.getElementById('category').value='{{ llm_suggestion.category }}'">
                                    Use suggestion
                                </button>
                            </div>
                            {% endif %}
                            {% else %}
                            <input type="text" class="form-input" value="{{ record.category }}" readonly>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if record_type == 'paperless' %}
                    <!-- Transaction Type and Reference (combined row) -->
                    <div class="form-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="transaction_type">Transaction Type <span class="required-star">*</span></label>
                                <select id="transaction_type" name="transaction_type" class="form-input" required>
                                    <option value="withdrawal" {% if record.transaction_type == 'withdrawal' or record.transaction_type == 'WITHDRAWAL' %}selected{% endif %}>Withdrawal (Expense)</option>
                                    <option value="deposit" {% if record.transaction_type == 'deposit' or record.transaction_type == 'DEPOSIT' %}selected{% endif %}>Deposit (Income)</option>
                                    <option value="transfer" {% if record.transaction_type == 'transfer' or record.transaction_type == 'TRANSFER' %}selected{% endif %}>Transfer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="invoice_number">Invoice / Receipt Number</label>
                                <input type="text" 
                                       id="invoice_number" 
                                       name="invoice_number" 
                                       class="form-input" 
                                       value="{{ record.invoice_number|default:'' }}"
                                       placeholder="e.g., INV-2024-001">
                                {% if confidence.invoice_number %}
                                <div class="form-help">Confidence: {{ confidence.invoice_number|floatformat:0 }}%</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Split Transaction / Line Items -->
                    <div class="form-section">
                        <div class="form-section-title">
                            Split Transaction
                            <label style="font-weight: normal; font-size: 0.75rem; margin-left: 0.5rem; text-transform: none;">
                                <input type="checkbox" id="enable_split" onchange="toggleSplitMode(this.checked)">
                                Enable split booking
                            </label>
                        </div>
                        <div id="split-container" style="display: none;">
                            <div class="form-help mb-3">
                                Split this transaction across multiple lines with different categories. 
                                The sum must equal the total amount above.
                            </div>
                            <div id="line-items-container">
                                <!-- Line items will be added dynamically -->
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button type="button" class="btn btn-sm btn-outline" onclick="addLineItem()">
                                    + Add Line
                                </button>
                                <span id="split-total" class="form-help" style="margin-left: auto; font-weight: 600;"></span>
                            </div>
                        </div>
                        <input type="hidden" id="line_items_json" name="line_items_json" value="">
                    </div>
                    {% endif %}
                </div>
                
                {% if record_type == 'paperless' %}
                <div class="action-buttons">
                    <button type="button" class="btn btn-outline" onclick="saveWithoutConfirm()" title="Save changes without confirming - stay on this page">
                        üíæ Save
                    </button>
                    <button type="submit" class="btn btn-primary btn-confirm" title="Save and confirm - moves to next item">
                        ‚úì Confirm
                    </button>
                    <button type="submit" formaction="{% url 'skip' record.extraction_id %}" formnovalidate class="btn btn-secondary" title="Skip for now - review later">Skip ‚Üí</button>
                    <a href="{% url 'reject' record.extraction_id %}" class="btn btn-danger" 
                       onclick="return confirm('Reject this extraction?')" title="Reject this document">‚ùå Reject</a>
                    {% if record.review_decision %}
                    <a href="{% url 'reset_extraction' record.extraction_id %}" class="btn btn-outline">üîÑ Reset</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </form>
        
        {% if record_type == 'paperless' %}
        <!-- AI Settings (Collapsible, hidden by default) -->
        {% if llm_globally_enabled %}
        <div class="card card-collapsible mt-4 collapsed" id="ai-settings-card">
            <div class="card-header" onclick="toggleCard('ai-settings-card')">
                <h2>ü§ñ AI Settings</h2>
                <div class="card-header-info">
                    {% if ai_job_status %}
                    <span class="ai-job-badge {{ ai_job_status.status|lower }}">
                        {% if ai_job_status.status == 'PENDING' %}‚è≥ Scheduled{% elif ai_job_status.status == 'PROCESSING' %}‚öôÔ∏è Processing{% elif ai_job_status.status == 'COMPLETED' %}‚úÖ Completed{% elif ai_job_status.status == 'FAILED' %}‚ùå Failed{% else %}{{ ai_job_status.status }}{% endif %}
                    </span>
                    {% else %}
                    <span class="ai-job-badge not-scheduled">Not Scheduled</span>
                    {% endif %}
                    <span class="collapse-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-body">
                <div class="form-row" style="align-items: center; gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" 
                                   id="llm_opt_out_checkbox"
                                   {% if not llm_opt_out %}checked{% endif %}
                                   onchange="toggleLlmOptOut(this.checked)"
                                   style="width: 1.25rem; height: 1.25rem;">
                            <span>Use AI suggestions for this document</span>
                        </label>
                        <div class="form-help">
                            When enabled, AI will assist with category suggestions. Disable to rely only on rule-based extraction.
                        </div>
                    </div>
                    <div>
                        <button type="button" 
                                class="btn btn-outline"
                                onclick="rerunInterpretation()"
                                title="Re-run AI interpretation for this document">
                            üîÑ Re-run Interpretation
                        </button>
                    </div>
                </div>
                {% if ai_job_status %}
                <div class="mt-3 p-3" style="background: var(--gray-50); border-radius: 0.375rem;">
                    <div class="form-help" style="margin: 0;">
                        <strong>AI Job Status:</strong> {{ ai_job_status.status }}<br>
                        {% if ai_job_status.scheduled_at %}
                        <strong>Scheduled:</strong> {{ ai_job_status.scheduled_at }}<br>
                        {% endif %}
                        {% if ai_job_status.started_at %}
                        <strong>Started:</strong> {{ ai_job_status.started_at }}<br>
                        {% endif %}
                        {% if ai_job_status.completed_at %}
                        <strong>Completed:</strong> {{ ai_job_status.completed_at }}<br>
                        {% endif %}
                        {% if ai_job_status.error_message %}
                        <strong>Error:</strong> <span style="color: var(--red-600);">{{ ai_job_status.error_message }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- AI Suggestions from Queue -->
                {% if ai_suggestions %}
                <div class="mt-3 p-3" style="background: #dcfce7; border-radius: 0.375rem; border: 1px solid #86efac;">
                    <h4 style="font-size: 0.875rem; color: #166534; margin-bottom: 0.75rem;">
                        ‚ú® AI Suggestions Available
                    </h4>
                    {% if ai_suggestions.category %}
                    <div class="ai-suggestion-item" style="margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <strong>Category:</strong> 
                                <span class="text-mono">{{ ai_suggestions.category.value }}</span>
                                {% if ai_suggestions.category.confidence %}
                                <span class="badge-confidence" style="margin-left: 0.5rem; background: #166534; color: white; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.65rem;">
                                    {{ ai_suggestions.category.confidence|floatformat:0 }}% confidence
                                </span>
                                {% endif %}
                            </div>
                            <button type="button" 
                                    class="btn btn-sm btn-success"
                                    onclick="applyAiSuggestion('category', '{{ ai_suggestions.category.value }}')"
                                    style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">
                                Use this
                            </button>
                        </div>
                        {% if ai_suggestions.category.reason %}
                        <div class="form-help" style="margin-top: 0.25rem; font-style: italic;">
                            "{{ ai_suggestions.category.reason }}"
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="mt-2 pt-2" style="border-top: 1px solid #86efac;">
                        <button type="button" 
                                class="btn btn-sm btn-outline"
                                onclick="applyAllAiSuggestions()"
                                style="font-size: 0.75rem;">
                            ‚úÖ Apply All AI Suggestions
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Confidence Details (Collapsible, hidden by default) -->
        {% if confidence %}
        <div class="card card-collapsible mt-4 collapsed" id="confidence-card">
            <div class="card-header" onclick="toggleCard('confidence-card')">
                <h2>üìä Confidence Scores</h2>
                <div class="card-header-info">
                    <span class="text-mono">{{ confidence.overall|floatformat:0 }}% overall</span>
                    <span class="collapse-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-body">
                <div class="confidence-bar" style="height: 0.75rem; margin-bottom: 1rem;">
                    <div class="confidence-bar-fill {% if confidence.overall >= 85 %}confidence-high{% elif confidence.overall >= 60 %}confidence-medium{% else %}confidence-low{% endif %}"
                         style="width: {{ confidence.overall }}%"></div>
                </div>
                <div class="confidence-detail">
                    <div class="confidence-item">
                        <div class="confidence-item-label">Amount</div>
                        <div class="confidence-item-value">{{ confidence.amount|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Date</div>
                        <div class="confidence-item-value">{{ confidence.date|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Currency</div>
                        <div class="confidence-item-value">{{ confidence.currency|floatformat:0 }}%</div>
                    </div>
                    <div class="confidence-item">
                        <div class="confidence-item-label">Vendor</div>
                        <div class="confidence-item-value">{{ confidence.vendor|floatformat:0 }}%</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Extraction Audit / Provenance (Collapsible, hidden by default) -->
        {% if provenance or record.raw_text %}
        <div class="card card-collapsible mt-4 collapsed" id="audit-card">
            <div class="card-header" onclick="toggleCard('audit-card')">
                <h2>üîç Extraction Audit</h2>
                <div class="card-header-info">
                    <span>{{ provenance.extraction_strategy|default:"ocr" }}</span>
                    <span class="collapse-icon">‚ñº</span>
                </div>
            </div>
            <div class="card-body">
                {% if provenance %}
                <dl class="provenance-info">
                    <dt>Source:</dt>
                    <dd>{{ provenance.source_system|default:"paperless" }}</dd>
                    
                    <dt>Strategy:</dt>
                    <dd>{{ provenance.extraction_strategy|default:"ocr_heuristic" }}</dd>
                    
                    <dt>Parser:</dt>
                    <dd>v{{ provenance.parser_version|default:"unknown" }}</dd>
                    
                    <dt>Parsed:</dt>
                    <dd>{{ provenance.parsed_at|default:"unknown" }}</dd>
                    
                    {% if record.source_hash %}
                    <dt>Source Hash:</dt>
                    <dd><code style="font-size: 0.7rem;">{{ record.source_hash|truncatechars:20 }}</code></dd>
                    {% endif %}
                </dl>
                {% endif %}
                
                <!-- Per-field confidence details -->
                {% if confidence %}
                <div class="mt-4">
                    <h4 style="font-size: 0.875rem; margin-bottom: 0.5rem;">Field Confidence Scores</h4>
                    <div class="confidence-detail">
                        <div class="confidence-item">
                            <div class="confidence-item-label">Amount</div>
                            <div class="confidence-item-value {% if confidence.amount >= 80 %}text-success{% elif confidence.amount >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.amount|floatformat:0 }}%
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="confidence-item-label">Date</div>
                            <div class="confidence-item-value {% if confidence.date >= 80 %}text-success{% elif confidence.date >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.date|floatformat:0 }}%
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="confidence-item-label">Vendor</div>
                            <div class="confidence-item-value {% if confidence.vendor >= 80 %}text-success{% elif confidence.vendor >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.vendor|floatformat:0 }}%
                            </div>
                        </div>
                        <div class="confidence-item">
                            <div class="confidence-item-label">Description</div>
                            <div class="confidence-item-value {% if confidence.description >= 80 %}text-success{% elif confidence.description >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                {{ confidence.description|floatformat:0 }}%
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if record.raw_text %}
                <details class="mt-4">
                    <summary style="cursor: pointer; font-size: 0.875rem; color: var(--gray-500);">
                        üìù Show Raw OCR Text (Source Data)
                    </summary>
                    <div class="raw-text mt-2">{{ record.raw_text|truncatechars:3000 }}</div>
                </details>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Document Links (visible on small screens) -->
        <div class="card mt-4 viewer-toggle-card" style="display: none;">
            <div class="card-body">
                <a href="{% url 'document' record.id %}" target="_blank" class="btn btn-outline">
                    üìÑ View Original Document
                </a>
                <a href="{{ paperless_url }}/documents/{{ record.id }}/" target="_blank" class="btn btn-outline">
                    Open in Paperless ‚Üó
                </a>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Link Section (Right Sidebar) -->
    <div class="link-section">
        <div class="link-header">
            <h3>üîó Linking</h3>
            <p>{% if record_type == 'paperless' %}Match to Firefly transaction{% else %}Match to Paperless document{% endif %}</p>
        </div>
        
        <!-- Current Link Status -->
        <div class="link-status {{ link_status }}">
            {% if link_status == 'linked' %}
            <div class="link-status-title">‚úÖ Linked</div>
            <div class="link-status-desc">This record is linked and ready for import</div>
            {% elif link_status == 'orphan' %}
            <div class="link-status-title">üìç Orphan</div>
            <div class="link-status-desc">Confirmed as having no matching record</div>
            {% else %}
            <div class="link-status-title">‚ö†Ô∏è Not Linked</div>
            <div class="link-status-desc">Must be linked or marked as orphan before import</div>
            {% endif %}
        </div>
        
        {% if linked_record %}
        <!-- Linked Record Info -->
        <div class="linked-record-info">
            <h4>Linked to:</h4>
            <div class="linked-record-details">
                {% if record_type == 'paperless' %}
                <strong>üè¶ Firefly #{{ linkage.firefly_id }}</strong><br>
                {{ linked_record.description|truncatechars:40 }}<br>
                <span class="text-muted">{{ linked_record.amount }} ‚Ä¢ {{ linked_record.date }}</span>
                {% else %}
                <strong>üìÑ Document #{{ linked_record.document_id }}</strong><br>
                {{ linked_record.title|truncatechars:40 }}
                {% endif %}
            </div>
            <div style="margin-top: 0.75rem;">
                <button type="button" class="btn btn-outline btn-sm" onclick="unlinkRecord()" title="Remove this linkage">
                    üîì Unlink
                </button>
            </div>
        </div>
        {% endif %}
        
        {% if link_status == 'pending' %}
        <!-- Top 3 Suggestions -->
        <div class="suggestions-section">
            <div class="suggestions-title">
                Top Matches (click to link)
            </div>
            
            {% if suggestions %}
            {% for suggestion in suggestions %}
            <div class="suggestion-item" 
                 data-id="{{ suggestion.id }}"
                 data-type="{{ suggestion.type }}"
                 onclick="selectSuggestion(this, {{ suggestion.id }}, '{{ suggestion.type }}')">
                <div class="suggestion-header">
                    <span class="suggestion-title">
                        {% if suggestion.type == 'firefly' %}
                        üè¶ {{ suggestion.description|truncatechars:25 }}
                        {% else %}
                        üìÑ {{ suggestion.title|truncatechars:25 }}
                        {% endif %}
                    </span>
                    <span class="suggestion-score">{{ suggestion.score }}%</span>
                </div>
                <div class="suggestion-meta">
                    {{ suggestion.amount|default:"‚Äî" }} ‚Ä¢ {{ suggestion.date|default:"‚Äî" }}
                    {% if suggestion.vendor or suggestion.destination_account %}
                    ‚Ä¢ {{ suggestion.vendor|default:suggestion.destination_account|default:"‚Äî" }}
                    {% endif %}
                </div>
                <div class="suggestion-actions">
                    <button type="button" class="btn btn-sm btn-primary" 
                            onclick="event.stopPropagation(); quickLink({{ record.id }}, {{ suggestion.id }})">
                        üîó Link
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <p class="text-muted text-sm">No matching records found</p>
            {% endif %}
            
            <button type="button" class="btn btn-outline btn-sm mt-3" onclick="loadMoreSuggestions()">
                üîÑ Load More Suggestions
            </button>
        </div>
        
        <!-- Mark as Orphan -->
        <div class="orphan-section">
            <h4>üìç No Match?</h4>
            <p>If this record has no matching partner (e.g., cash payment, no receipt), mark it as orphan.</p>
            <button type="button" class="btn btn-warning btn-sm" onclick="markAsOrphan()">
                Mark as Orphan
            </button>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Store current record info
const recordType = '{{ record_type }}';
const recordId = {{ record.id }};
{% if record_type == 'paperless' %}
const documentId = {{ record.id }};
const extractionId = {{ record.extraction_id|default:"null" }};
{% else %}
const fireflyId = {{ record.id }};
{% endif %}

let selectedSuggestion = null;

// ============================================
// Unsaved Changes Tracking
// ============================================
let formHasChanges = false;
let submittingForm = false;
const originalFormValues = {};
const aiModifiedFields = {}; // Track AI-modified fields for per-field undo

// Store original form values on load
function storeOriginalValues() {
    const form = document.getElementById('review-form');
    if (!form) return;
    
    const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
    inputs.forEach(input => {
        const key = input.id || input.name;
        if (key) {
            originalFormValues[key] = input.value;
        }
    });
}

// Check if form has been modified
function checkForChanges() {
    const form = document.getElementById('review-form');
    if (!form) return false;
    
    const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
    for (const input of inputs) {
        const key = input.id || input.name;
        if (key && originalFormValues[key] !== undefined) {
            if (input.value !== originalFormValues[key]) {
                return true;
            }
        }
    }
    return false;
}

// Update unsaved indicator
function updateUnsavedIndicator() {
    formHasChanges = checkForChanges();
    const indicator = document.getElementById('unsaved-indicator');
    if (indicator) {
        indicator.classList.toggle('visible', formHasChanges);
    }
}

// Warn on page unload if unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (formHasChanges && !submittingForm) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Initialize change tracking
document.addEventListener('DOMContentLoaded', function() {
    storeOriginalValues();
    
    const form = document.getElementById('review-form');
    if (form) {
        // Track all input changes
        form.addEventListener('input', updateUnsavedIndicator);
        form.addEventListener('change', updateUnsavedIndicator);
        
        // Mark as submitting when form is submitted
        form.addEventListener('submit', function() {
            submittingForm = true;
        });
    }
    
    // Allow navigation for skip, reject, reset links
    document.querySelectorAll('a[href*="/reject"], a[href*="/reset"]').forEach(link => {
        link.addEventListener('click', function() {
            submittingForm = true;
        });
    });
});

// ============================================
// Save Without Confirm
// ============================================
function saveWithoutConfirm() {
    submittingForm = true;
    const confirmFlag = document.getElementById('confirm-flag');
    if (confirmFlag) {
        confirmFlag.value = 'false';
    }
    const form = document.getElementById('review-form');
    if (form) {
        form.submit();
    }
}

// Document viewer toggle
function toggleDocumentViewer() {
    const viewer = document.getElementById('document-viewer');
    const btn = document.getElementById('viewer-toggle-btn');
    if (viewer) {
        viewer.classList.toggle('collapsed');
        const isCollapsed = viewer.classList.contains('collapsed');
        if (btn) {
            btn.textContent = isCollapsed ? '‚ñ∂ Show' : '‚ñº Hide';
        }
        // Remember preference in localStorage
        localStorage.setItem('documentViewerCollapsed', isCollapsed);
    }
}

// Generic card collapse toggle
function toggleCard(cardId) {
    const card = document.getElementById(cardId);
    if (card) {
        card.classList.toggle('collapsed');
        // Remember preference
        const isCollapsed = card.classList.contains('collapsed');
        localStorage.setItem(`card_${cardId}_collapsed`, isCollapsed);
    }
}

// Initialize card collapse states from localStorage on page load
document.addEventListener('DOMContentLoaded', function() {
    // Collapsible cards - restore state from localStorage
    document.querySelectorAll('.card-collapsible').forEach(card => {
        const cardId = card.id;
        if (cardId) {
            const savedState = localStorage.getItem(`card_${cardId}_collapsed`);
            // Default collapsed state is set in HTML; only restore if user explicitly toggled
            if (savedState === 'false') {
                card.classList.remove('collapsed');
            }
        }
    });
});

// Iframe load/error handling
function handleIframeLoad() {
    const iframe = document.getElementById('document-iframe');
    const errorDiv = document.getElementById('document-error');
    
    // Try to detect load errors (cross-origin restrictions may prevent this)
    try {
        // Check if iframe loaded with content
        if (iframe && iframe.contentWindow) {
            // Hide error, show iframe
            if (errorDiv) errorDiv.style.display = 'none';
            iframe.style.display = 'block';
        }
    } catch (e) {
        // Cross-origin - can't check, assume loaded OK
        console.log('Cannot check iframe content (cross-origin)');
    }
}

function handleIframeError() {
    const iframe = document.getElementById('document-iframe');
    const errorDiv = document.getElementById('document-error');
    
    // Show error message, hide iframe
    if (iframe) iframe.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'flex';
}

// Check for HTTP errors from document endpoint
function checkDocumentAvailability() {
    {% if record_type == 'paperless' %}
    fetch('{% url "document" record.id %}', { method: 'HEAD' })
        .then(response => {
            if (!response.ok) {
                handleIframeError();
            }
        })
        .catch(() => {
            handleIframeError();
        });
    {% endif %}
}

// Initialize document viewer state from localStorage
document.addEventListener('DOMContentLoaded', function() {
    const viewer = document.getElementById('document-viewer');
    const btn = document.getElementById('viewer-toggle-btn');
    const savedState = localStorage.getItem('documentViewerCollapsed');
    
    if (viewer && savedState === 'true') {
        viewer.classList.add('collapsed');
        if (btn) btn.textContent = '‚ñ∂ Show';
    }
    
    // Check document availability after short delay
    setTimeout(checkDocumentAvailability, 500);
});

// Split transaction management
let lineItems = [];
let lineItemCounter = 0;

function toggleSplitMode(enabled) {
    const container = document.getElementById('split-container');
    if (!container) return;
    container.style.display = enabled ? 'block' : 'none';
    
    if (enabled && lineItems.length === 0) {
        // Add first line item with the total amount
        addLineItem(parseFloat(document.getElementById('amount').value) || 0);
    }
    
    updateLineItemsJson();
}

function addLineItem(amount = 0, description = '', category = '') {
    const id = lineItemCounter++;
    lineItems.push({ id, amount, description, category });
    renderLineItems();
}

function removeLineItem(id) {
    lineItems = lineItems.filter(item => item.id !== id);
    if (lineItems.length === 0) {
        const checkbox = document.getElementById('enable_split');
        if (checkbox) checkbox.checked = false;
        toggleSplitMode(false);
    } else {
        renderLineItems();
    }
}

function updateLineItem(id, field, value) {
    const item = lineItems.find(item => item.id === id);
    if (item) {
        if (field === 'amount') {
            item.amount = parseFloat(value) || 0;
        } else {
            item[field] = value;
        }
    }
    updateSplitTotal();
    updateLineItemsJson();
}

function renderLineItems() {
    const container = document.getElementById('line-items-container');
    if (!container) return;
    
    const categories = {{ firefly_categories_json|safe|default:"[]" }};
    
    container.innerHTML = lineItems.map((item, idx) => `
        <div class="line-item-row" style="display: grid; grid-template-columns: 1fr 2fr 2fr auto; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: white; border: 1px solid var(--gray-200); border-radius: 0.25rem;">
            <div>
                <input type="number" 
                       value="${item.amount}" 
                       step="0.01" 
                       class="form-input" 
                       placeholder="Amount"
                       onchange="updateLineItem(${item.id}, 'amount', this.value)"
                       style="font-size: 0.875rem;">
            </div>
            <div>
                <input type="text" 
                       value="${item.description}" 
                       class="form-input" 
                       placeholder="Description"
                       onchange="updateLineItem(${item.id}, 'description', this.value)"
                       style="font-size: 0.875rem;">
            </div>
            <div>
                <select class="form-input" 
                        onchange="updateLineItem(${item.id}, 'category', this.value)"
                        style="font-size: 0.875rem;">
                    <option value="">-- Category --</option>
                    ${categories.map(cat => `<option value="${cat.name}" ${cat.name === item.category ? 'selected' : ''}>${cat.name}</option>`).join('')}
                </select>
            </div>
            <button type="button" 
                    class="btn btn-sm btn-outline" 
                    onclick="removeLineItem(${item.id})"
                    style="color: #dc2626;"
                    ${lineItems.length <= 1 ? 'disabled' : ''}>
                ‚úï
            </button>
        </div>
    `).join('');
    
    updateSplitTotal();
    updateLineItemsJson();
}

function updateSplitTotal() {
    const total = lineItems.reduce((sum, item) => sum + (item.amount || 0), 0);
    const expectedEl = document.getElementById('amount');
    const expected = expectedEl ? parseFloat(expectedEl.value) || 0 : 0;
    const diff = Math.abs(total - expected);
    
    const totalEl = document.getElementById('split-total');
    if (!totalEl) return;
    
    if (diff < 0.01) {
        totalEl.innerHTML = `Total: ${total.toFixed(2)} ‚úì`;
        totalEl.style.color = 'var(--success)';
    } else {
        totalEl.innerHTML = `Total: ${total.toFixed(2)} (expected: ${expected.toFixed(2)}, diff: ${diff.toFixed(2)})`;
        totalEl.style.color = 'var(--danger)';
    }
}

function updateLineItemsJson() {
    const checkbox = document.getElementById('enable_split');
    const enabled = checkbox ? checkbox.checked : false;
    const json = enabled && lineItems.length > 0 ? JSON.stringify(lineItems) : '';
    const jsonField = document.getElementById('line_items_json');
    if (jsonField) jsonField.value = json;
}

// Update split total when main amount changes
const amountField = document.getElementById('amount');
if (amountField) {
    amountField.addEventListener('change', updateSplitTotal);
}

// LLM opt-out toggle
function toggleLlmOptOut(enableAi) {
    const optOut = !enableAi;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "toggle_llm_opt_out" record.extraction_id|default:0 %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ opt_out: optOut })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const checkbox = document.getElementById('llm_opt_out_checkbox');
            const originalLabel = checkbox.nextElementSibling.textContent;
            checkbox.nextElementSibling.textContent = data.message;
            setTimeout(() => {
                checkbox.nextElementSibling.textContent = originalLabel;
            }, 2000);
        } else {
            alert('Failed to update setting: ' + data.error);
            document.getElementById('llm_opt_out_checkbox').checked = enableAi;
        }
    })
    .catch(error => {
        alert('Network error: ' + error);
        document.getElementById('llm_opt_out_checkbox').checked = enableAi;
    });
}

// Re-run interpretation with progress tracking
const LLM_TIMEOUT_SECONDS = {{ llm_timeout_seconds|default:60 }};
let aiProgressInterval = null;
let aiAbortController = null;

function rerunInterpretation() {
    {% if not llm_globally_enabled %}
    alert('AI/Ollama is not enabled. Please enable it in Settings to use this feature.');
    return;
    {% endif %}
    
    if (!confirm('Re-run AI interpretation for this document? The AI will analyze all fields and provide suggestions.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = '‚è≥ Processing...';
    btn.disabled = true;
    
    // Show progress modal
    showAIProgressModal(LLM_TIMEOUT_SECONDS);
    
    // Create abort controller for timeout
    aiAbortController = new AbortController();
    const timeoutId = setTimeout(() => {
        aiAbortController.abort();
    }, (LLM_TIMEOUT_SECONDS + 5) * 1000); // Extra 5 seconds for network
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "rerun_interpretation" record.extraction_id|default:0 %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        signal: aiAbortController.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        hideAIProgressModal();
        
        // Check if response is OK first
        if (!response.ok) {
            // Try to get error from JSON body if possible
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json().then(data => {
                    throw new Error(data.error || `Server error: ${response.status}`);
                });
            }
            // Handle actual server errors (not gateway timeouts - those are still processing)
            if (response.status === 500) {
                throw new Error('Server error occurred. Check server logs for details.');
            } else if (response.status >= 400 && response.status < 500) {
                throw new Error(`Client error: ${response.status} ${response.statusText}`);
            } else {
                // For 502/504/524, don't immediately fail - the backend might still be processing
                // The AbortController timeout will handle actual timeouts
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            }
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            // This shouldn't happen for successful responses but handle it gracefully
            throw new Error('Server returned unexpected response format. The server may be overloaded. Please try again.');
        }
        return response.json();
    })
    .then(data => {
        btn.textContent = originalText;
        btn.disabled = false;
        
        if (data.success) {
            // Apply suggestions dynamically to form fields
            if (data.suggestions) {
                applySuggestionsToForm(data.suggestions);
                showSuggestionsSummary(data.suggestions, data.message);
            } else if (data.suggestion) {
                // Backward compatibility: single category suggestion
                applySuggestionsToForm({
                    category: {
                        value: data.suggestion.category,
                        confidence: data.suggestion.confidence,
                        reason: ''
                    }
                });
                showSuggestionsSummary({category: data.suggestion}, data.message);
            } else {
                showNotification(
                    'AI Analysis Complete',
                    data.message || 'AI completed but returned no high-confidence suggestions.',
                    'warning'
                );
            }
        } else {
            showNotification(
                'AI Interpretation Failed',
                data.error || 'Unknown error occurred.',
                'error'
            );
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        hideAIProgressModal();
        btn.textContent = originalText;
        btn.disabled = false;
        
        if (error.name === 'AbortError') {
            showNotification(
                'AI Request Timed Out',
                `The AI request took longer than ${LLM_TIMEOUT_SECONDS} seconds. The server may still be processing. Try again or check Settings to increase the timeout.`,
                'error'
            );
        } else {
            showNotification(
                'Connection Error',
                error.message || 'Network error occurred.',
                'error'
            );
        }
    });
}

function showAIProgressModal(timeoutSeconds) {
    // Remove existing modal if any
    hideAIProgressModal();
    
    const overlay = document.createElement('div');
    overlay.id = 'ai-progress-overlay';
    overlay.className = 'ai-progress-overlay';
    overlay.innerHTML = `
        <div class="ai-progress-modal">
            <div class="ai-progress-title ai-progress-spinner">ü§ñ AI is thinking...</div>
            <div class="ai-progress-subtitle">Please wait while the AI analyzes your document</div>
            <div class="ai-progress-bar-container">
                <div id="ai-progress-bar" class="ai-progress-bar" style="width: 0%"></div>
            </div>
            <div id="ai-progress-time" class="ai-progress-time">0s</div>
            <div class="ai-progress-status">Connecting to AI model...</div>
            <div class="ai-progress-hint" style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-400);">
                Maximum wait time: ${timeoutSeconds}s
            </div>
            <button onclick="cancelAIRequest()" class="ai-progress-cancel">Cancel</button>
        </div>
    `;
    document.body.appendChild(overlay);
    
    // Start elapsed time counter
    let elapsed = 0;
    aiProgressInterval = setInterval(() => {
        elapsed++;
        const progress = Math.min(100, (elapsed / timeoutSeconds) * 100);
        
        // Format elapsed time as "Xm Ys" or "Ys"
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeString = minutes > 0 
            ? `${minutes}m ${seconds}s` 
            : `${seconds}s`;
        
        const timeEl = document.getElementById('ai-progress-time');
        const barEl = document.getElementById('ai-progress-bar');
        const statusEl = document.querySelector('.ai-progress-status');
        
        if (timeEl) timeEl.textContent = timeString;
        if (barEl) barEl.style.width = `${progress}%`;
        
        // Update status message based on elapsed time
        if (statusEl) {
            if (elapsed < 5) {
                statusEl.textContent = 'Connecting to AI model...';
            } else if (elapsed < 15) {
                statusEl.textContent = 'AI analyzing document content...';
            } else if (elapsed < 30) {
                statusEl.textContent = 'Generating suggestions...';
            } else {
                statusEl.textContent = 'Still processing (this might take a while)...';
            }
        }
        
        if (elapsed >= timeoutSeconds) {
            clearInterval(aiProgressInterval);
        }
    }, 1000);
}

function hideAIProgressModal() {
    if (aiProgressInterval) {
        clearInterval(aiProgressInterval);
        aiProgressInterval = null;
    }
    const overlay = document.getElementById('ai-progress-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function cancelAIRequest() {
    if (aiAbortController) {
        aiAbortController.abort();
    }
    hideAIProgressModal();
    showNotification('Request Cancelled', 'AI interpretation was cancelled.', 'warning');
}

// Apply a single AI suggestion to a form field
function applyAiSuggestion(fieldName, value) {
    const field = document.getElementById(fieldName);
    if (!field) {
        console.warn('Field not found:', fieldName);
        return;
    }
    
    // Store original value for undo
    const originalValue = field.value;
    
    // Apply the AI suggestion
    field.value = value;
    field.classList.add('ai-modified');
    
    // Mark as changed
    updateUnsavedIndicator();
    
    showNotification('AI Suggestion Applied', `Set ${fieldName} to "${value}"`, 'success');
}

// Apply all available AI suggestions
function applyAllAiSuggestions() {
    {% if ai_suggestions %}
    const suggestions = {{ ai_suggestions|safe }};
    let appliedCount = 0;
    
    // Apply category if available
    if (suggestions.category && suggestions.category.value) {
        const categoryField = document.getElementById('category');
        if (categoryField) {
            categoryField.value = suggestions.category.value;
            categoryField.classList.add('ai-modified');
            appliedCount++;
        }
    }
    
    // Apply other fields if they become available in the future
    // (e.g., transaction_type, description, etc.)
    
    if (appliedCount > 0) {
        updateUnsavedIndicator();
        showNotification('AI Suggestions Applied', `Applied ${appliedCount} suggestion(s) to form fields`, 'success');
    } else {
        showNotification('No Suggestions', 'No AI suggestions were available to apply', 'warning');
    }
    {% else %}
    showNotification('No Suggestions', 'No AI suggestions are available', 'warning');
    {% endif %}
}

// Apply AI suggestions to form fields
function applySuggestionsToForm(suggestions) {
    const fieldMap = {
        'category': 'category',
        'transaction_type': 'transaction_type',
        'destination_account': 'destination_account',
        'description': 'description',
        'invoice_number': 'invoice_number',
        'amount': 'amount',
        'date': 'date',
        'source_account': 'source_account'
    };
    
    // Handle split transactions if suggested
    if (suggestions.split_transactions && Array.isArray(suggestions.split_transactions)) {
        applySplitSuggestions(suggestions.split_transactions);
    }
    
    // Apply regular field suggestions
    for (const [field, suggestion] of Object.entries(suggestions)) {
        if (field === 'split_transactions') continue; // Already handled
        
        const fieldId = fieldMap[field];
        if (!fieldId) continue;
        
        const element = document.getElementById(fieldId);
        if (!element) continue;
        
        // Only apply if confidence > 0.5
        const confidence = suggestion.confidence || 0;
        if (confidence < 0.5) continue;
        
        // Store original value for undo
        const originalValue = element.value;
        aiModifiedFields[fieldId] = {
            original: originalValue,
            suggested: suggestion.value,
            confidence: confidence,
            reason: suggestion.reason || ''
        };
        
        // Set the new value
        if (element.tagName === 'SELECT') {
            const option = Array.from(element.options).find(o => o.value === suggestion.value);
            if (option) {
                element.value = suggestion.value;
            }
        } else {
            element.value = suggestion.value;
        }
        
        // Apply AI-modified styling
        element.classList.add('ai-modified');
        
        // Add per-field accept/undo controls
        addAIFieldControls(element, fieldId, confidence, suggestion.reason);
    }
    
    // Update unsaved indicator
    updateUnsavedIndicator();
}

// Apply split transaction suggestions
function applySplitSuggestions(splits) {
    if (!splits || splits.length === 0) return;
    
    // Enable split mode
    const checkbox = document.getElementById('enable_split');
    if (checkbox && !checkbox.checked) {
        checkbox.checked = true;
        toggleSplitMode(true);
    }
    
    // Clear existing line items
    lineItems = [];
    lineItemCounter = 0;
    
    // Add suggested splits
    splits.forEach((split, idx) => {
        const id = ++lineItemCounter;
        lineItems.push({
            id: id,
            amount: parseFloat(split.amount) || 0,
            description: split.description || '',
            category: split.category || ''
        });
    });
    
    // Render the line items
    renderLineItems();
    
    // Store for undo
    aiModifiedFields['split_transactions'] = {
        original: [],
        suggested: splits,
        confidence: 0.8,
        reason: 'AI suggested splitting this transaction'
    };
}

// Add per-field accept/undo controls
function addAIFieldControls(element, fieldId, confidence, reason) {
    // Remove any existing controls
    const existingControls = element.parentElement.querySelector('.ai-field-controls');
    if (existingControls) {
        existingControls.remove();
    }
    
    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'ai-field-controls';
    controlsContainer.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.25rem;
    `;
    
    // Badge showing AI suggested
    const badge = document.createElement('span');
    badge.className = 'ai-suggestion-badge';
    badge.innerHTML = `ü§ñ AI: ${Math.round(confidence * 100)}%`;
    badge.style.cssText = `
        display: inline-block;
        padding: 2px 6px;
        font-size: 0.65rem;
        background: #fef3c7;
        color: #92400e;
        border-radius: 4px;
        cursor: help;
    `;
    badge.title = reason || 'AI suggested this value';
    
    // Accept button
    const acceptBtn = document.createElement('button');
    acceptBtn.type = 'button';
    acceptBtn.className = 'accept-ai';
    acceptBtn.innerHTML = '‚úì Accept';
    acceptBtn.style.cssText = `
        padding: 2px 8px;
        font-size: 0.65rem;
        background: #dcfce7;
        color: #166534;
        border: 1px solid #22c55e;
        border-radius: 4px;
        cursor: pointer;
    `;
    acceptBtn.onclick = function() {
        acceptAIField(fieldId);
    };
    
    // Undo button
    const undoBtn = document.createElement('button');
    undoBtn.type = 'button';
    undoBtn.className = 'undo-ai';
    undoBtn.innerHTML = '‚Ü© Undo';
    undoBtn.style.cssText = `
        padding: 2px 8px;
        font-size: 0.65rem;
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
        border-radius: 4px;
        cursor: pointer;
    `;
    undoBtn.onclick = function() {
        undoAIField(fieldId);
    };
    
    controlsContainer.appendChild(badge);
    controlsContainer.appendChild(acceptBtn);
    controlsContainer.appendChild(undoBtn);
    
    // Insert after the input/select
    element.insertAdjacentElement('afterend', controlsContainer);
}

// Accept AI suggestion (remove undo option, keep value)
function acceptAIField(fieldId) {
    const element = document.getElementById(fieldId);
    if (!element) return;
    
    // Remove AI styling
    element.classList.remove('ai-modified');
    
    // Remove controls
    const controls = element.parentElement.querySelector('.ai-field-controls');
    if (controls) {
        controls.remove();
    }
    
    // Mark as accepted (update original values so it's not seen as a change)
    originalFormValues[fieldId] = element.value;
    delete aiModifiedFields[fieldId];
    
    // Show brief accepted indicator
    const accepted = document.createElement('span');
    accepted.innerHTML = '‚úì Accepted';
    accepted.style.cssText = `
        display: inline-block;
        margin-left: 8px;
        padding: 2px 6px;
        font-size: 0.65rem;
        background: #dcfce7;
        color: #166534;
        border-radius: 4px;
    `;
    element.insertAdjacentElement('afterend', accepted);
    
    setTimeout(() => {
        accepted.remove();
    }, 2000);
    
    updateUnsavedIndicator();
}

// Undo AI suggestion (restore original value)
function undoAIField(fieldId) {
    const element = document.getElementById(fieldId);
    if (!element) return;
    
    const fieldData = aiModifiedFields[fieldId];
    if (!fieldData) return;
    
    // Restore original value
    element.value = fieldData.original;
    
    // Remove AI styling
    element.classList.remove('ai-modified');
    
    // Remove controls
    const controls = element.parentElement.querySelector('.ai-field-controls');
    if (controls) {
        controls.remove();
    }
    
    delete aiModifiedFields[fieldId];
    
    // Show brief undo indicator
    const undone = document.createElement('span');
    undone.innerHTML = '‚Ü© Restored';
    undone.style.cssText = `
        display: inline-block;
        margin-left: 8px;
        padding: 2px 6px;
        font-size: 0.65rem;
        background: #fee2e2;
        color: #991b1b;
        border-radius: 4px;
    `;
    element.insertAdjacentElement('afterend', undone);
    
    setTimeout(() => {
        undone.remove();
    }, 2000);
    
    updateUnsavedIndicator();
}

// Add AI badge next to suggested field (legacy - kept for backward compatibility)
function addAISuggestionBadge(element, confidence, reason) {
    // Now handled by addAIFieldControls
}

// Show summary of suggestions
function showSuggestionsSummary(suggestions, message) {
    const summaryItems = [];
    let hasChanges = false;
    
    for (const [field, suggestion] of Object.entries(suggestions)) {
        if (field === 'split_transactions' && Array.isArray(suggestion)) {
            summaryItems.push(`Split transactions: ${suggestion.length} splits suggested`);
            hasChanges = true;
        } else if (suggestion.value && suggestion.confidence >= 0.5) {
            summaryItems.push(`‚Ä¢ ${field}: "${suggestion.value}" (${Math.round(suggestion.confidence * 100)}%)`);
            hasChanges = true;
        }
    }
    
    if (hasChanges) {
        // Use a toast-like notification instead of alert
        showNotification(
            'ü§ñ AI Suggestions Applied',
            summaryItems.join('\n') + '\n\nReview changes and use Accept/Undo buttons per field.',
            'info'
        );
    } else {
        showNotification(
            'AI Analysis Complete',
            message || 'No high-confidence suggestions to apply.',
            'warning'
        );
    }
}

// Show notification toast
function showNotification(title, message, type) {
    // Remove existing notification
    const existing = document.getElementById('ai-notification');
    if (existing) {
        existing.remove();
    }
    
    const colors = {
        'info': { bg: '#eff6ff', border: '#3b82f6', text: '#1e40af' },
        'success': { bg: '#f0fdf4', border: '#22c55e', text: '#166534' },
        'warning': { bg: '#fffbeb', border: '#f59e0b', text: '#92400e' },
        'error': { bg: '#fef2f2', border: '#ef4444', text: '#991b1b' }
    };
    const color = colors[type] || colors.info;
    
    const notification = document.createElement('div');
    notification.id = 'ai-notification';
    notification.style.cssText = `
        position: fixed;
        top: 1rem;
        right: 1rem;
        max-width: 400px;
        padding: 1rem;
        background: ${color.bg};
        border: 1px solid ${color.border};
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999;
        animation: slideIn 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
            <div>
                <div style="font-weight: 600; color: ${color.text}; margin-bottom: 0.5rem;">${title}</div>
                <div style="font-size: 0.875rem; color: ${color.text}; white-space: pre-line;">${message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="
                background: none;
                border: none;
                font-size: 1.25rem;
                cursor: pointer;
                color: ${color.text};
                line-height: 1;
            ">√ó</button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-dismiss after 10 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(() => notification.remove(), 300);
        }
    }, 10000);
}

function selectSuggestion(element, id, type) {
    // Remove selection from all
    document.querySelectorAll('.suggestion-item').forEach(el => {
        el.classList.remove('selected');
    });
    // Select this one
    element.classList.add('selected');
    selectedSuggestion = { id, type };
}

function quickLink(paperlessId, fireflyId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_quick_link" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            paperless_id: recordType === 'paperless' ? recordId : fireflyId,
            firefly_id: recordType === 'paperless' ? fireflyId : recordId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error creating link: ' + error);
    });
}

function markAsOrphan() {
    if (!confirm('Mark this record as orphan (no matching partner)?')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_quick_link" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            paperless_id: recordType === 'paperless' ? recordId : null,
            firefly_id: recordType === 'firefly' ? recordId : null,
            mark_orphan: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error marking as orphan: ' + error);
    });
}

function loadMoreSuggestions() {
    fetch('{% url "api_link_suggestions" record_type record_id %}')
    .then(response => response.json())
    .then(data => {
        console.log('Suggestions:', data.suggestions);
        // Could update the suggestions list dynamically
        alert('Found ' + data.suggestions.length + ' suggestions');
    })
    .catch(error => {
        console.error('Error loading suggestions:', error);
    });
}

function unlinkRecord() {
    if (!confirm('Remove the linkage between these records? This will set the record back to "pending" status.')) {
        return;
    }
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('{% url "api_unlink" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            record_type: recordType,
            record_id: recordId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error removing link: ' + error);
    });
}
</script>
{% endblock %}
