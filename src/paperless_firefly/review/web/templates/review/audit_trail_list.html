{% extends "review/base.html" %}

{% block title %}Audit Trail{% endblock %}

{% block extra_css %}
<style>
    .filter-bar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .filter-bar .form-group {
        flex: 1;
        min-width: 150px;
    }
    
    .filter-bar label {
        font-size: 0.75rem;
        color: var(--gray-500);
        display: block;
        margin-bottom: 0.25rem;
    }
    
    .filter-bar input,
    .filter-bar select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .run-row {
        transition: background-color 0.15s ease;
    }
    
    .run-row:hover {
        background-color: var(--gray-50);
    }
    
    .state-badge {
        display: inline-block;
        padding: 0.125rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .state-badge.LINKED { background: #dcfce7; color: #166534; }
    .state-badge.REJECTED { background: #fee2e2; color: #991b1b; }
    .state-badge.ACCEPTED { background: #dbeafe; color: #1e40af; }
    .state-badge.PENDING { background: #fef3c7; color: #92400e; }
    .state-badge.FAILED { background: #fee2e2; color: #991b1b; }
    .state-badge.COMPLETED { background: #dcfce7; color: #166534; }
    
    .source-badge {
        display: inline-block;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.625rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .source-badge.USER { background: #dbeafe; color: #1e40af; }
    .source-badge.RULES { background: #f3e8ff; color: #6b21a8; }
    .source-badge.LLM { background: #fce7f3; color: #9d174d; }
    .source-badge.AUTO { background: #dcfce7; color: #166534; }
    
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }
    
    .pagination .page-info {
        color: var(--gray-500);
        font-size: 0.875rem;
    }
    
    .json-preview {
        font-family: "SFMono-Regular", Consolas, monospace;
        font-size: 0.625rem;
        background: var(--gray-50);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<!-- Filter Bar -->
<form method="get" class="filter-bar">
    <div class="form-group">
        <label for="document_id">Document ID</label>
        <input type="number" id="document_id" name="document_id" 
               value="{{ filter_document }}" placeholder="Filter by doc...">
    </div>
    <div class="form-group">
        <label for="firefly_id">Firefly ID</label>
        <input type="number" id="firefly_id" name="firefly_id" 
               value="{{ filter_firefly }}" placeholder="Filter by tx...">
    </div>
    <div class="form-group">
        <label for="decision_source">Decision Source</label>
        <select id="decision_source" name="decision_source">
            <option value="">All Sources</option>
            <option value="USER" {% if filter_source == "USER" %}selected{% endif %}>User</option>
            <option value="RULES" {% if filter_source == "RULES" %}selected{% endif %}>Rules</option>
            <option value="LLM" {% if filter_source == "LLM" %}selected{% endif %}>LLM</option>
            <option value="AUTO" {% if filter_source == "AUTO" %}selected{% endif %}>Auto</option>
        </select>
    </div>
    <div class="form-group" style="flex: 0; align-self: flex-end;">
        <button type="submit" class="btn btn-primary">Filter</button>
    </div>
</form>

<div class="card">
    <div class="card-header">
        <h2>üìú Audit Trail ({{ total_count }} runs)</h2>
    </div>
    
    {% if runs %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Timestamp</th>
                <th>Document</th>
                <th>Firefly TX</th>
                <th>State</th>
                <th>Source</th>
                <th>Action</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs %}
            <tr class="run-row">
                <td class="text-mono text-sm">#{{ run.id }}</td>
                <td class="text-sm">{{ run.run_timestamp|slice:":19" }}</td>
                <td>
                    {% if run.document_id %}
                    <a href="{% url 'detail' run.document_id %}" class="text-link">Doc #{{ run.document_id }}</a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if run.firefly_id %}
                    <a href="{{ firefly_url }}/transactions/show/{{ run.firefly_id }}" 
                       target="_blank" class="text-link">TX #{{ run.firefly_id }}</a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    <span class="state-badge {{ run.final_state }}">{{ run.final_state }}</span>
                </td>
                <td>
                    {% if run.decision_source %}
                    <span class="source-badge {{ run.decision_source }}">{{ run.decision_source }}</span>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td class="text-sm">
                    {{ run.firefly_write_action|default:"-" }}
                </td>
                <td>
                    <a href="{% url 'audit_trail_detail' run.id %}" class="btn btn-sm btn-outline" title="View Details">
                        üëÅ
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    <div class="pagination">
        {% if has_prev %}
        <a href="?page={{ page|add:"-1" }}{% if filter_document %}&document_id={{ filter_document }}{% endif %}{% if filter_firefly %}&firefly_id={{ filter_firefly }}{% endif %}{% if filter_source %}&decision_source={{ filter_source }}{% endif %}" 
           class="btn btn-sm btn-outline">‚Üê Previous</a>
        {% endif %}
        
        <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
        
        {% if has_next %}
        <a href="?page={{ page|add:"1" }}{% if filter_document %}&document_id={{ filter_document }}{% endif %}{% if filter_firefly %}&firefly_id={{ filter_firefly }}{% endif %}{% if filter_source %}&decision_source={{ filter_source }}{% endif %}" 
           class="btn btn-sm btn-outline">Next ‚Üí</a>
        {% endif %}
    </div>
    {% else %}
    <div class="empty-state">
        <h3>üì≠ No audit records</h3>
        <p>No interpretation runs match the current filters.</p>
        {% if filter_document or filter_firefly or filter_source %}
        <p class="mt-4">
            <a href="{% url 'audit_trail_list' %}" class="btn btn-outline">Clear Filters</a>
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}